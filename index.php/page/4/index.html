<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Kam&#39;s Idea Log</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Kam&#39;s Idea Log">
<meta property="og:url" content="https://kamsar.net/index.php/page/4/index.html">
<meta property="og:site_name" content="Kam&#39;s Idea Log">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Kam Figy">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@kamsar">
  
    <link rel="alternative" href="/index.php/feed" title="Kam&#39;s Idea Log" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:400italic,400,600' rel='stylesheet' type='text/css'>
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">

  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-62284328-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


<meta name="generator" content="Hexo 5.4.0"></head>
<body>
  <div id="container">
    <header id="header">
  <div id="header-main" class="header-inner">
    <div class="outer">
      <a href="/" id="logo">
        <span class="site-title">Kam&#39;s Idea Log</span>
        <span class="subtitle">C#, Jamstack, and Shenanigans</span>
      </a>
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/blog/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        <div class="profile" id="profile-nav">
          <a id="profile-anchor" href="javascript:;"><img class="avatar" src="https://www.gravatar.com/avatar/314826f5d569260f26ac9f26f9e38b86?s=40" srcset="https://www.gravatar.com/avatar/314826f5d569260f26ac9f26f9e38b86?s=80 2x" alt="omg the beard"><i class="fa fa-caret-down"></i></a>
        </div>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"> </button><input type="hidden" name="sitesearch" value="https://kamsar.net"></form>
      </div>
    </div>
  </div>
  <div id="main-nav-mobile" class="header-sub header-inner">
    <table class="menu outer">
      <tr>
      
        <td><a class="main-nav-link" href="/">Home</a></td>
      
        <td><a class="main-nav-link" href="/blog/archives">Archives</a></td>
      
      <td>
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="https://kamsar.net"></form>
      </td>
      </tr>
    </table>
  </div>
  
</header>
    <div class="outer">
      <aside id="profile">
  <div class="inner profile-inner">
  	<div class="base-info profile-block">
		  <img id="avatar" src="https://www.gravatar.com/avatar/314826f5d569260f26ac9f26f9e38b86?s=128" srcset="https://www.gravatar.com/avatar/314826f5d569260f26ac9f26f9e38b86?s=256 2x" alt="#sitecorebeard">
      <h2 id="name">Kam Figy</h2>
      <h3 id="title">Principal Platform Architect at</h3>
      <a class="corp-logo" href="https://uniform.dev" target="_blank"><img src="/css/images/uniform-logo.svg" alt="Uniform" width="180"></a>
      <span id="location"><i class="fa fa-map-marker"></i>Vancouver, WA USA</span>
      <a id="follow" target="_blank" rel="noopener" href="https://twitter.com/kamsar">FOLLOW</a>
  	</div>
    <div class="contact-info profile-block">
      <table class="contact-list">
        <tr>
        
          <td><a target="_blank" rel="noopener" href="https://github.com/kamsar" title="github"><i class="fa fa-github"></i></a></td>
        
          <td><a target="_blank" rel="noopener" href="https://twitter.com/kamsar" title="twitter"><i class="fa fa-twitter"></i></a></td>
        
          <td><a href="/index.php/feed" title="rss"><i class="fa fa-rss"></i></a></td>
        
        </tr>
      </table>
    </div>
    <div class="article-info profile-block bio">
      <h2>About</h2>
      <p>Kam has been making websites since 1996, starting out with a 14.4k modem on a <a href="https://en.wikipedia.org/wiki/Party_line_(telephony)" target="_blank">party line</a> in the Hawaiian rainforest. A veteran developer, architect, and speaker, he's been working in the content management space for well over a decade. Kam is the author of <a href="https://github.com/kamsar/Unicorn" target="_blank">Unicorn</a>, <a href="https://github.com/kamsar/Synthesis" target="_blank">Synthesis</a>, <a href="https://github.com/kamsar/Dianoga" target="_blank">Dianoga</a>, and several other open-source libraries.</p>
    </div>
  </div>
</aside>
      <section id="main">
  
    <article id="post-Sitecore-hangs-on-startup-when-using-MongoDB" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/index.php/2016/09/Sitecore-hangs-on-startup-when-using-MongoDB/">Sitecore hangs on startup when using MongoDB</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/index.php/2016/09/Sitecore-hangs-on-startup-when-using-MongoDB/">
    <time datetime="2016-09-02T17:52:25.000Z" itemprop="datePublished">September 2, 2016</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/index.php/category/Sitecore/">Sitecore</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I ran across a tricky issue today where a Sitecore content delivery cluster would simply hang on startup. No errors in the logs. Nothing in the windows event logs. The content editing server worked just fine.</p>
<p>Mystifying, right? So it came down to process of elimination: I disabled analytics and removed all Mongo connection strings and the site worked. The obvious answer here would be “it’s a firewall issue.”</p>
<p>It wasn’t. <code>mongo.exe</code> could connect to the replica set just fine. The connection was using SSL, so I checked the server certificate. It was valid and trusted. </p>
<p>Eventually it came down to a few important facts:</p>
<ul>
<li>We were using SSL.</li>
<li>Because we weren’t using client certificates, <code>mongo.exe</code> had to use <code>--sslAllowInvalidCertificates</code>, which meant that it was not verifying the server certificate.</li>
<li>The Mongo C# driver <em>does</em> validate the server certificate.</li>
</ul>
<p>But you said the server certificate was totally valid, right? Right - and it was valid.</p>
<p>Except for the sneaky fact that <em>the certificate had a Certificate Revocation List (CRL) URL embedded in it</em>. The Mongo C# driver defaults to checking the CRL to make sure the server certificate is not revoked.</p>
<p>Normally that’s a good thing, but in this case <em>the CRL was behind the firewall, and the delivery servers were not</em>. So the CRL could not be checked, and the server certificate was treated as invalid due to that.</p>
<p>Why this results in straight up hanging the site instead of an error I’m not sure. But that leads to how it got fixed.</p>
<h2 id="Extending-the-Mongo-Client-Settings"><a href="#Extending-the-Mongo-Client-Settings" class="headerlink" title="Extending the Mongo Client Settings"></a>Extending the Mongo Client Settings</h2><p>The most obvious fix would be to add something to the connection string to disable the CRL check, as it would be undesirable to expose the PKI server that issued the certificate to the DMZ where the delivery servers live. Unfortunately, there is no option to do that in the Mongo connection string format.</p>
<p>Fortunately, There’s A Micro-Pipeline For That™. Sitecore exposes the <code>updateMongoDriverSettings</code> pipeline, which is empty by default. This pipeline allows you to fool with the <a target="_blank" rel="noopener" href="http://api.mongodb.com/csharp/current/html/T_MongoDB_Driver_MongoClientSettings.htm">MongoClientSettings</a> object and alter configurations that are not available in the connection string.</p>
<p>Here’s an example patch to add a processor to said pipeline:</p>
<pre><code>&lt;configuration xmlns:patch=&quot;http://www.sitecore.net/xmlconfig/&quot;&gt;
    &lt;sitecore&gt;
        &lt;pipelines&gt;
            &lt;updateMongoDriverSettings&gt;
                &lt;processor type=&quot;Me.Pipelines.UpdateMongoDriverSettings.DisableCrlChecks, Me&quot;/&gt;
            &lt;/updateMongoDriverSettings&gt;
        &lt;/pipelines&gt;
    &lt;/sitecore&gt;
&lt;/configuration&gt;
</code></pre>
<p>And the processor implementation that alters the <code>MongoClientSettings</code> to disable CRL checks:</p>
<pre><code>using MongoDB.Driver;
using Sitecore.Analytics.Pipelines.UpdateMongoDriverSettings;

namespace Me.Pipelines.UpdateMongoDriverSettings
&#123;
    public class DisableCrlChecks : UpdateMongoDriverSettingsProcessor
    &#123;
        public override void UpdateSettings(UpdateMongoDriverSettingsArgs args)
        &#123;
            args.MongoSettings.SslSettings = new SslSettings &#123; CheckCertificateRevocation = false &#125;;
        &#125;
    &#125;
&#125;
</code></pre>
<p>This technique could also be used to diagnose other SSL issues that might involve <em>invalid</em> certificates, because you can also <a target="_blank" rel="noopener" href="https://stackoverflow.com/a/34735350/1359221">alter the certificate validity handling</a> to get diagnostic output.</p>
<h2 id="Caveat-Sorry-not-for-you-Mongo-Session-Provider"><a href="#Caveat-Sorry-not-for-you-Mongo-Session-Provider" class="headerlink" title="Caveat: Sorry, not for you Mongo Session Provider"></a>Caveat: Sorry, not for you Mongo Session Provider</h2><img src="/index.php/2016/09/Sitecore-hangs-on-startup-when-using-MongoDB/vader.jpg" class=""> 

<p>Unfortunately if you’re using the MongoDB Session State provider, it does not respect this pipeline. In fact, it makes itself highly extensible, by hiding the place to put your options in a private static method! Called by internal methods! </p>
<pre><code>private static MongoCollection GetCollection(string connectionString, string databaseName, string collectionName)
&#123;
    return (MongoCollection) new MongoClient(new MongoUrl(connectionString)).GetServer().GetDatabase(databaseName).GetCollection(collectionName);
&#125;
</code></pre>
<p>So you’re hosed if you’re using Mongo sessions.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kamsar.net/index.php/2016/09/Sitecore-hangs-on-startup-when-using-MongoDB/" data-id="ckrl9emyd004998q712ij8i3i" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Dependency-Injection-in-Sitecore-8-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/index.php/2016/08/Dependency-Injection-in-Sitecore-8-2/">Dependency Injection in Sitecore 8.2</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/index.php/2016/08/Dependency-Injection-in-Sitecore-8-2/">
    <time datetime="2016-09-01T00:30:03.000Z" itemprop="datePublished">August 31, 2016</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/index.php/category/Sitecore/">Sitecore</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Sitecore 8.2, hot off the presses yesterday, includes built in <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Dependency_injection">dependency injection</a>. If you’ve been following the internal architecture of Sitecore for very long, you’ve probably realized that a lot of it is uglier than it needs to be - and less extensible - thanks to the lack of system-wide DI support. It’s kind of a big deal. Even if <a target="_blank" rel="noopener" href="https://twitter.com/cardinal252">Nat Mann</a> hates conforming containers ;)</p>
<p>The Sitecore <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Inversion_of_control">IoC</a> container is based on <a target="_blank" rel="noopener" href="https://docs.asp.net/en/latest/mvc/controllers/dependency-injection.html">Microsoft’s Dependency Injection</a> library that was written for .NET Core. It is not the world’s most flexible or performant container (nor was it designed to be), but it works and is a decent choice. If you wish you can change the underlying IoC library being used, but we aren’t going to cover that today.</p>
<p>Sitecore’s built in DI offers two major advantages over the third party dependency injection that most advanced Sitecore teams have been using for a long time:</p>
<ul>
<li>Sitecore itself is using it (and thus you can extend Sitecore itself by replacing dependencies)</li>
<li>You can natively dependency inject into pipeline processors (which you could <a target="_blank" rel="noopener" href="https://cardinalcore.co.uk/2014/07/02/sitecore-pipelines-commands-using-ioc-containers/">sort of already do</a>)</li>
</ul>
<h2 id="Controller-Injection"><a href="#Controller-Injection" class="headerlink" title="Controller Injection"></a>Controller Injection</h2><p>As with most ASP.NET DI implementations, most dependency resolution will take place in <em>controllers</em>. If you’ve already been using constructor injection with Sitecore, you may have to change absolutely nothing:</p>
<pre><code>public class FooController : Controller
&#123;
    private readonly IDependency _dependency;

    public Foo(IDependency dependency) 
    &#123;
        _dependency = dependency;
    &#125;

    public ActionResult Index() 
    &#123;
        return View(_dependency.DoStuff());
    &#125;
&#125;
</code></pre>
<p>Be aware that the built in IoC container has two major limitations when injecting controllers:</p>
<ul>
<li>You may only have <em>one</em> public constructor for your controller - or any other registered dependency. This is a good thing, as multiple public constructors are a <a target="_blank" rel="noopener" href="https://cuttingedge.it/blogs/steven/pivot/entry.php?id=97">DI antipattern</a> anyway.</li>
<li>The controller class must be registered with the container to be resolvable (e.g. you must register it such as <code>container.AddTransient&lt;FooController&gt;()</code>).</li>
</ul>
<p>The latter limitation we can do something nice about: read on and we’ll get to that when we talk about registering dependencies :)</p>
<h2 id="Pipeline-Injection"><a href="#Pipeline-Injection" class="headerlink" title="Pipeline Injection"></a>Pipeline Injection</h2><p>You may also inject dependencies into pipeline processors using the same constructor injection pattern as controllers. Processors are <em>not injected by default</em>, presumably for performance. As with controllers, processors may only have one public constructor. I suspect, but have not tried, that this trick would also work with commands.</p>
<p>To inject a processor, simply add <code>resolve=&quot;true&quot;</code> to its registration. For example:</p>
<pre><code>&lt;processor type=&quot;Foo.BarProcessor, Foo&quot; resolve=&quot;true&quot; /&gt;
</code></pre>
<h2 id="Web-Forms-Dependency-Injection"><a href="#Web-Forms-Dependency-Injection" class="headerlink" title="Web Forms Dependency Injection"></a>Web Forms Dependency Injection</h2><img src="/index.php/2016/08/Dependency-Injection-in-Sitecore-8-2/grumpy-cat-no.jpg" class="">

<p>(You can actually do Web Forms DI with Sitecore but I’m not going to tell you how. Quit using Web Forms.)</p>
<h2 id="Service-Locator"><a href="#Service-Locator" class="headerlink" title="Service Locator"></a>Service Locator</h2><p>You can also resolve dependencies from the Sitecore container using the <a target="_blank" rel="noopener" href="http://blog.ploeh.dk/2010/02/03/ServiceLocatorisanAnti-Pattern/">Service Locator <em>antipattern</em></a>. This is where you explicitly ask the container to give you an instance of an object. It’s an antipattern, and you should use it as a weapon of last resort, because it tightly couples your class to the IoC container and makes things difficult to test.</p>
<p>There are actually multiple ways you can use Service Locator:</p>
<pre><code>// the MVC DependencyResolver can be used
DependencyResolver.Current.GetService&lt;IService&gt;();

// the Sitecore ServiceLocator can be used
using Sitecore.DependencyInjection;
ServiceLocator.ServiceProvider.GetService&lt;IServiceCollection&gt;();
</code></pre>
<p>Again don’t use these…unless you have no other choice.</p>
<h1 id="Registering-Dependencies"><a href="#Registering-Dependencies" class="headerlink" title="Registering Dependencies"></a>Registering Dependencies</h1><p>Of course an IoC container is useless if it has no registered dependencies to resolve! Sitecore’s container can be configured in multiple ways, all of which involve some level of XML. I heard you groan when you read that ;)</p>
<p>Keep in mind when wiring dependencies that the IoC container is <em>not multitenant</em>. Your dependencies are sharing the container with Sitecore’s - and if you have more than one site, potentially other sites as well. So don’t go expecting to have <code>IFoo</code> resolve to different implementations in different sites!</p>
<p>If you get confused and want to see a list of every dependency that is currently registered, along with its scope and type, there’s a page for that! Just visit <code>/sitecore/admin/showservicesconfig.aspx</code> and there you are. While you’re at it, check out the <a target="_blank" rel="noopener" href="https://jammykam.wordpress.com/2016/08/23/sitecore-admin-pages-cheat-sheet-new-tools/">other handy tools in the admin pages too</a>.</p>
<h2 id="Configurators"><a href="#Configurators" class="headerlink" title="Configurators"></a>Configurators</h2><p>A configurator is probably what you think of when you consider IoC configuration if you’ve been using any modern container library. It’s a C# class that conforms to an interface where you are given a container object, and expected to wire your dependencies to it. You can register as many configurators as you like in the <code>&lt;services&gt;</code> section.</p>
<pre><code>&lt;configuration xmlns:patch=&quot;http://www.sitecore.net/xmlconfig/&quot;&gt;
    &lt;sitecore&gt;
        &lt;services&gt;
            &lt;configurator type=&quot;MyProject.MyConfiguratorClass, MyProject&quot; /&gt;
        &lt;/services&gt;
    &lt;/sitecore&gt;
&lt;/configuration&gt;
</code></pre>
<p>Here’s an example configurator implementation that registers a couple dependencies. As with most containers <code>Transient</code> and <code>Singleton</code> dependencies are available, and I believe <code>Scoped</code> as well, but I’m not sure what the exact behaviour of that is in this case.</p>
<pre><code>using Microsoft.Extensions.DependencyInjection;
using Sitecore.DependencyInjection;

namespace MyProject
&#123;
    public class MyConfiguratorClass : IServicesConfigurator
    &#123;
        public void Configure(IServiceCollection serviceCollection)
        &#123;
            serviceCollection.AddSingleton&lt;IDependency, Dependency&gt;();
            serviceCollection.AddSingleton&lt;IService&gt;(provider =&gt; new Service(&quot;withFactory&quot;));
        &#125;
    &#125;
&#125;
</code></pre>
<p><strong>Note</strong>: You cannot use Sitecore Factory conventions when registering configurators, for example setting properties on the configurator with child elements. This is because the Factory also speaks DI now as a fallback, so it’d be like asking the container to resolve itself :)</p>
<h2 id="Direct-Registration"><a href="#Direct-Registration" class="headerlink" title="Direct Registration"></a>Direct Registration</h2><p>You can also register individual dependencies with XML, just like we did ten years ago! I wouldn’t suggest doing this as it is less expressive than a configurator, not type-checked by compilation, and probably marginally slower as well due to having to convert the string to the type for every dependency.</p>
<pre><code>&lt;configuration xmlns:patch=&quot;http://www.sitecore.net/xmlconfig/&quot;&gt;
    &lt;sitecore&gt;
        &lt;services&gt;
            &lt;register 
                serviceType=&quot;Type.IName, Assembly&quot; 
                implementationType=&quot;Type.Name, Assembly&quot; 
                lifetime=&quot;Transient&quot; /&gt;
        &lt;/services&gt;
    &lt;/sitecore&gt;
&lt;/configuration&gt;
</code></pre>
<h1 id="Automatic-Controller-Registration"><a href="#Automatic-Controller-Registration" class="headerlink" title="Automatic Controller Registration"></a>Automatic Controller Registration</h1><p>If you’re actually reading this, you may have noticed that I mentioned earlier that you must register every MVC controller you wish to dependency inject with the IoC container. Sounds like a drag, right? Not so fast! Pull out your robe and wizard hat, grab this handy code, and register all your controllers automatically within a configurator:</p>
<pre><code>public void Configure(IServiceCollection serviceCollection)
&#123;
    // configurator per project? Use this:
    serviceCollection.AddMvcControllersInCurrentAssembly();

    // configure all the things from on high by convention? Use this (Habitat as the example):
    serviceCollection.AddMvcControllers(
        &quot;Sitecore.Feature.*&quot;, 
        &quot;Sitecore.*.Website&quot;);

    // you can also pass Assembly instances directly, but why?
    serviceCollection.AddMvcControllers(
        Assembly.FromName(&quot;Foo&quot;), 
        Assembly.FromName(&quot;Bar&quot;));
&#125;
</code></pre>
<p>And without further ado, here’s the code that makes that possible.</p>
<script src="//gist.github.com/460528edc3043b16bdccfdbd0ea0c552.js"></script>

<p>Have a nice day!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kamsar.net/index.php/2016/08/Dependency-Injection-in-Sitecore-8-2/" data-id="ckrl9emyc004598q7109igf24" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Configuring-domains-from-patch-files" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/index.php/2016/08/Configuring-domains-from-patch-files/">Configuring domains from patch files</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/index.php/2016/08/Configuring-domains-from-patch-files/">
    <time datetime="2016-08-05T19:22:53.000Z" itemprop="datePublished">August 5, 2016</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/index.php/category/Sitecore/">Sitecore</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Sitecore domains are logical security groupings, for example the product ships with “sitecore” (backend users) and “extranet” (frontend users). But you do not have to stick with only the domains the product ships with, as usual for Sitecore you can extend and add your own.</p>
<p>Normally adding a domain means editing <code>App_Config\Security\Domains.config</code>, but we don’t want to do this. Why? Because editing standard Sitecore config files makes it difficult to upgrade Sitecore and introduces error prone file merging. </p>
<p>What we want to do instead is use <a target="_blank" rel="noopener" href="http://sitecore-community.github.io/docs/documentation/Sitecore%20Fundamentals/Patch%20Files/"><em>config patch</em> files</a>. These allow us to add our config completely separately from Sitecore’s standard configuration files. But there’s a problem when it comes to domains: <code>Domains.config</code> does not live in the requisite <code>&lt;sitecore&gt;</code> config section so we cannot patch it.</p>
<p>Fortunately there’s a little known way around this. Someone at Sitecore implemented a config-based domain manager, but it’s not the default - presumably for backwards compatibility. And you <em>can</em> activate that, and add domains to it, using patch files.</p>
<p>So next time you want to add a domain to Sitecore, like say adding a domain for each site to provide logical author role groupings, switch over to the config domain manager. You know you want <code>MySite\Editor</code> instead of <code>sitecore\MySite Editor</code>. It’s easy to do, too.</p>
<p>This patch will activate the config domain manager (the defaults for the config manager already are the same as <code>Domains.config</code> so nothing else needs to be registered):</p>
<pre><code>&lt;configuration xmlns:patch=&quot;http://www.sitecore.net/xmlconfig/&quot;&gt;
    &lt;sitecore&gt;
        &lt;domainManager defaultProvider=&quot;file&quot;&gt;
            &lt;patch:attribute name=&quot;defaultProvider&quot;&gt;config&lt;/patch:attribute&gt;
        &lt;/domainManager&gt;
    &lt;/sitecore&gt;
&lt;/configuration&gt;
</code></pre>
<p>And this patch is an example of adding a domain to the config domain manager:</p>
<pre><code>&lt;configuration xmlns:patch=&quot;http://www.sitecore.net/xmlconfig/&quot;&gt;
    &lt;sitecore&gt;
        &lt;domainManager&gt;
            &lt;domains&gt;
                &lt;domain id=&quot;MyNewDomain&quot; type=&quot;Sitecore.Security.Domains.Domain, Sitecore.Kernel&quot;&gt;
                    &lt;param desc=&quot;name&quot;&gt;$(id)&lt;/param&gt;
                    &lt;ensureAnonymousUser&gt;false&lt;/ensureAnonymousUser&gt;
                &lt;/domain&gt;
            &lt;/domains&gt;
        &lt;/domainManager&gt;
    &lt;/sitecore&gt;
&lt;/configuration&gt;
</code></pre>
<p>And there you have it. Enjoy!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kamsar.net/index.php/2016/08/Configuring-domains-from-patch-files/" data-id="ckrl9emyc004398q715q6cbaq" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Synthesis-8-2-1-Released" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/index.php/2016/06/Synthesis-8-2-1-Released/">Synthesis 8.2.1 Released</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/index.php/2016/06/Synthesis-8-2-1-Released/">
    <time datetime="2016-06-07T02:18:07.000Z" itemprop="datePublished">June 6, 2016</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/index.php/category/Synthesis/">Synthesis</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I am happy to announce that Synthesis 8.2.1 is available on NuGet. This release primarily adds additional features. </p>
<h2 id="What’s-New"><a href="#What’s-New" class="headerlink" title="What’s New?"></a>What’s New?</h2><h3 id="Improved-Multiple-Configuration-Support"><a href="#Improved-Multiple-Configuration-Support" class="headerlink" title="Improved Multiple Configuration Support"></a>Improved Multiple Configuration Support</h3><p>Previously registering multiple configurations in Synthesis was possible but way too hard. Configurations may now register themselves using code, similar to MVC area registrations.</p>
<p>To register a new configuration with Synthesis 8.2.1:</p>
<ul>
<li>Add a class to the assembly you want the configuration’s model to live in that derives from <code>SynthesisConfigurationRegistration</code></li>
<li>Implement the abstract members of <code>SynthesisConfigurationRegistration</code>. Much deeper customization is also available by overriding other optional members.</li>
<li>Add a <code>SynthesisConfigRegistrar</code> processor to the <code>initialize</code> pipeline that is set to scan your assembly, e.g.<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;pipelines&gt;</span><br><span class="line">	&lt;initialize&gt;</span><br><span class="line">		&lt;!-- IMPORTANT: Each registrar instance must have a unique hint value for the patch to work correctly. --&gt;</span><br><span class="line">		&lt;processor type=&quot;Synthesis.Pipelines.Initialize.SynthesisConfigRegistrar, Synthesis&quot; hint=&quot;Hinty McHintface&quot;&gt;</span><br><span class="line">			&lt;assemblies hint=&quot;list:AddAssembly&quot;&gt;</span><br><span class="line">				&lt;meAssembly&gt;My.Assembly.WithModel&lt;/meAssembly&gt;</span><br><span class="line">			&lt;/assemblies&gt;</span><br><span class="line">		&lt;/processor&gt;</span><br><span class="line">	&lt;/initialize&gt;</span><br><span class="line">&lt;/pipelines&gt;</span><br></pre></td></tr></table></figure></li>
<li>That’s it! Your configuration will now be activated.</li>
</ul>
<h3 id="Auto-Friending"><a href="#Auto-Friending" class="headerlink" title="Auto Friending"></a>Auto Friending</h3><img src="/index.php/2016/06/Synthesis-8-2-1-Released/bemyfriend.jpg" class="" title="WHAT DID I EVER DO TO YOU?">

<p>Along with simpler configuration registration, allowing your configurations to reference each other’s generated classes is also far easier with “Auto-Friending.”</p>
<p>To illustrate this, suppose you were using Habitat and in your Project layer you had templates that inherited Feature templates. Without auto-friending (or previously manual friending), the Project would generate duplicate interfaces for the Feature templates. This is a bad thing. But with friending, the Project generated template will simply inherit from the already existing Feature model, extending implicit dependency in the database into explicit dependency at a code level (also a good thing!).</p>
<p>With auto-friending, configurations automatically friend each other in the order they are registered. So for the example above, as long as the Feature’s model configuration was registered before the Project’s model, everything would Just Work. You can control the order of registration by the order in the <code>SynthesisConfigRegistrar</code> assemblies.</p>
<h3 id="IRenderingContext-and-improved-IoC-support-Synthesis-Mvc"><a href="#IRenderingContext-and-improved-IoC-support-Synthesis-Mvc" class="headerlink" title="IRenderingContext and improved IoC support (Synthesis.Mvc)"></a>IRenderingContext and improved IoC support (Synthesis.Mvc)</h3><p>A pattern that I’ve been using for a while (<a target="_blank" rel="noopener" href="http://www.martywoods.nl/unit-testing-sitecore-mvc-its-easy-when-using-synthesis/">as have others</a>) to improve testability is to make a facade over the <code>RenderingContext</code> that turns it into a Synthesis API and removes all <code>Item</code> dependencies. This <code>IRenderingContext</code> can be registered with your IoC container (to <code>SitecoreRenderingContext</code>) and constructor-injected into controller renderings to make <code>Item</code>-free controllers that are easy to test without any hacks. Even awesome hacks like FakeDb.</p>
<p>For example:</p>
<p>```<br>public class FooController : Controller<br>{<br>    private readonly IRenderingContext _renderingContext;</p>
<pre><code>public FooController(IRenderingContext renderingContext) 
&#123;
    _renderingContext = renderingContext;
&#125;

public ActionResult Foo() 
&#123;
    var dataSource = _renderingContext.GetRenderingDatasource&lt;IExpectedTypeItem&gt;();

    if(dataSource == null) 
    &#123;
        // no datasource set, or datasource is wrong template type (or context item, if no datasource set)
        return Content(&quot;Derp.&quot;);
    &#125;

    var model = new FooViewModel(dataSource);

    // set other model props here

    // Note that none of this controller directly used Sitecore APIs and thus does not require FakeDb nor HTTP context
    // to have unit tests written against it.

    return View(model);
&#125;
</code></pre>
<p>}```</p>
<p>Additional, more specific interfaces are also available for more specific use cases: <code>IContextItem</code>, <code>IContextDatabase</code>, and <code>IContextSite</code>. These can all be bound to <code>SitecoreRenderingContext</code> and provide smaller interfaces for more specific tasks.</p>
<h3 id="Config-Patching-by-Default"><a href="#Config-Patching-by-Default" class="headerlink" title="Config Patching by Default"></a>Config Patching by Default</h3><p>Synthesis now ships with <code>Synthesis.LocalConfig.config.example</code>, which is designed to be duplicated to form your own configuration patch. This encourages leaving the default configurations alone, which in turn greatly simplifies upgrading. The documentation and README has also been updated to reflect this.</p>
<h2 id="Improvements"><a href="#Improvements" class="headerlink" title="Improvements"></a>Improvements</h2><ul>
<li>The default settings have been improved:<ul>
<li>Creating model backup files is now disabled by default because it is of questionable utility when using source control</li>
<li>The <code>InterfaceOutputPath</code> and <code>ItemOutputPath</code> settings have been deprecated and merged into a single <code>ModelOutputPath</code> because it’s silly to emit more than one model file. The separate settings will still operate if you wish to use them.</li>
<li>Uncommonly used settings have been removed from Synthesis.config (<code>SitecoreKernelAssemblyPath</code>, <code>SynthesisAssemblyPath</code>, and <code>InterfaceSuffix</code>). They continue to work if set, but are removed for brevity as they are generally not used other than at default values.</li>
</ul>
</li>
<li>The <code>SynthesisEditContext</code> class has been marked obsolete because <a target="_blank" rel="noopener" href="http://sitecore.alexiasoft.nl/2006/04/03/new-way-of-editing-items/#comment-16">the pattern is a bad idea</a></li>
<li>WebForms related classes have been marked obsolete because don’t use WebForms</li>
<li>The ability to attempt to automatically rebuild the project containing the model on startup has been removed due to being a generally bad idea</li>
<li>The <code>ModelOutputBasePath</code> setting has been added. This path is prepended to the <code>ModelOutputPath</code> for all configurations. The advantage of using this is that for people who work out of webroot, they can use <code>&lt;sc.variable&gt;</code> values in a setting (e.g. the out of webroot project location) whereas Sitecore does not expand variables in the <code>ModelOutputPath</code>. <a target="_blank" rel="noopener" href="https://github.com/kamsar/Synthesis/issues/27">#27</a></li>
</ul>
<h2 id="Bug-Fixes"><a href="#Bug-Fixes" class="headerlink" title="Bug Fixes"></a>Bug Fixes</h2><ul>
<li>Setting max backups to 0 no longer results in an infinite loop and now does not make backup files <a target="_blank" rel="noopener" href="https://github.com/kamsar/Synthesis/issues/28">#28</a></li>
<li>Registering the same assembly twice in the type list provider will no longer scan the assembly twice</li>
<li>Wildcards that do not end in * (e.g. Foo.*.Web) will not operate correctly when adding assemblies to the type list provider</li>
</ul>
<h2 id="Upgrading"><a href="#Upgrading" class="headerlink" title="Upgrading"></a>Upgrading</h2><p>Upgrading should be as simple as a NuGet upgrade*. If you have customized your Synthesis.config you may need to merge it with the default (or even better make it a patch file).</p>
<p>* as long as you are using Sitecore 8.1. As with the 8.2.0 release, it is designed only for Sitecore 8.1 due to breaking Sitecore API changes in 8.1. Sorry about that :(</p>
<h2 id="Thanks"><a href="#Thanks" class="headerlink" title="Thanks!"></a>Thanks!</h2><p>Thank you to the community members who contributed to this release:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/AlexKasaku">Alex Washtell</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/thesoftwarejedi">Dana Hanna</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/patocl">patocl</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/andyshokry">Andy Shokry</a></li>
<li><a target="_blank" rel="noopener" href="https://twitter.com/martijn_b0s">Martijn Bos</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mulate">Mauricio Ulate</a></li>
</ul>
<p>As always, happy coding!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kamsar.net/index.php/2016/06/Synthesis-8-2-1-Released/" data-id="ckrl9emyc004198q73srxfvqv" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Unicorn-3-1-5-Released" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/index.php/2016/03/Unicorn-3-1-5-Released/">Unicorn 3.1.5 Released</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/index.php/2016/03/Unicorn-3-1-5-Released/">
    <time datetime="2016-03-24T04:31:57.000Z" itemprop="datePublished">March 23, 2016</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/index.php/category/Unicorn/">Unicorn</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Unicorn 3.1.5 and Rainbow 1.3 are released to NuGet right now. This is a maintenance release. Upgrading is recommended, particularly if you are using Transparent Sync.</p>
<h2 id="New-Features"><a href="#New-Features" class="headerlink" title="New Features"></a>New Features</h2><h3 id="Link-DB-and-Indexing-support"><a href="#Link-DB-and-Indexing-support" class="headerlink" title="Link DB and Indexing support"></a>Link DB and Indexing support</h3><p>The new <code>&lt;syncConfiguration&gt;</code> dependency (see <code>Unicorn.config</code>) enables configurations to opt in to having synced items be updated into the link database and/or the search indexes after being changed by a sync.</p>
<p>This improves Unicorn’s compatibility with content syncing scenarios that are less developer focused, at the expense of reduced sync performance.</p>
<p>Transparent Sync also supports these flags, and items changed <em>while Sitecore is alive to see them</em> will have their links and indexes taken care of if set to do so. However if the IIS App Pool is not active during the file changes, nothing is updated.</p>
<h3 id="Per-configuration-concurrency"><a href="#Per-configuration-concurrency" class="headerlink" title="Per-configuration concurrency"></a>Per-configuration concurrency</h3><p>Unicorn 3 has always supported multithreaded sync and reserialize, but it has been disabled since release due to a concurrency bug in the Sitecore Template Engine that results in sync deadlocks when it is used to sync template item changes.</p>
<p>3.1.5 brings the ability to set the max thread count per-configuration (using the same <code>&lt;syncConfiguration&gt;</code> as indexing support) so that for configurations that are not syncing templates (or on Sitecore prior to 8.0U2) you may again enable concurrency. Threaded syncing can be 30-50% faster than non threaded.</p>
<h3 id="Control-panel-UX-improvements"><a href="#Control-panel-UX-improvements" class="headerlink" title="Control panel UX improvements"></a>Control panel UX improvements</h3><p>Unicorn 3.1.5 brings a ‘Sync all’ button to the control panel, and a few minor UI tweaks such as relegating the log verbosity to an options modal.</p>
<h2 id="Bug-Fixes"><a href="#Bug-Fixes" class="headerlink" title="Bug Fixes"></a>Bug Fixes</h2><ul>
<li>Checkboxes inherited through several layers of standard values will no longer result in the derived template being reset to base standard values</li>
<li>Auto-publish no longer will miss publishing unversioned fields in certain cases</li>
<li>Renaming or moving items with transparent sync enabled and data cache turned on no longer results in a corrupted data cache</li>
<li>Change Template now works correctly with transparent sync</li>
<li>Unicorn now understands content items that are using Sitecore 8.1 language fallback without creating extra versions on the serialized copy</li>
<li>The log verbosity feature has had several issues fixed that would result in logs incorrectly not being shown at the selected level</li>
<li>Unicorn’s Micro IoC container now understands int constructor parameters</li>
<li>Adding or changing serialized template items when using transparent sync will now correctly clear the template engine, preventing an error</li>
<li>Automated build powershell examples are now more flexible when invoked in unusual path locations</li>
<li>In the control panel, the batch action buttons will no longer ‘overlay’ configuration checkboxes in certain situations</li>
<li>Logging of unversioned field updates will no longer incorrectly show a version number alongside the update in the logs</li>
<li>Certain unusual situations when syncing templates and items of that template will no longer throw a null reference due to stale caches</li>
</ul>
<h2 id="Upgrading"><a href="#Upgrading" class="headerlink" title="Upgrading"></a>Upgrading</h2><p>Upgrading from 3.1.4 is just a NuGet upgrade away. There are some config changes, so overwrite files and merge anything custom back in. Or even better use config patches and leave the default config alone :)</p>
<p>Note that Unicorn 3.1.5 changes the storage format for checkbox fields so that <em>unchecked</em> checkboxes are stored as ‘0’ instead of Sitecore’s standard blank value. This makes sync more reliable, however it does means that the first sync after serializing a new item with an unchecked checkbox will result in a ‘change’ as the zero value is pushed back into the Sitecore database. Checkboxes that are already serialized with blank values will continue to work just fine as they are.</p>
<h1 id="Credits"><a href="#Credits" class="headerlink" title="Credits"></a>Credits</h1><p>Unicorn is a team effort of the Sitecore community. I’d like to thank the following folks who contributed to this release:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/thesoftwarejedi">Dana Hanna</a><br><a target="_blank" rel="noopener" href="https://github.com/Gadensgaard">Kasper Gadensgaard</a><br><a target="_blank" rel="noopener" href="https://github.com/cassidydotdk">Mark Cassidy</a><br><a target="_blank" rel="noopener" href="https://github.com/TheCodeKing">Mike Carlisle</a><br><a target="_blank" rel="noopener" href="https://github.com/Krusen">Søren Kruse</a><br><a target="_blank" rel="noopener" href="https://github.com/WizX20">WizX20</a></p>
<p>And extra special thanks to Robin Hermanussen, Richard Seal, Alex Washtell, Mark Cassidy, and everyone else I missed for tirelessly answering questions in #unicorn on Sitecore Slack when I’m busy or not around!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kamsar.net/index.php/2016/03/Unicorn-3-1-5-Released/" data-id="ckrl9emyb003z98q700vvb3tj" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-The-Solr-Cannon" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/index.php/2016/03/The-Solr-Cannon/">The Solr Cannon: Rapid Solr Setup for Sitecore</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/index.php/2016/03/The-Solr-Cannon/">
    <time datetime="2016-03-15T21:43:43.000Z" itemprop="datePublished">March 15, 2016</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/index.php/category/Sitecore/">Sitecore</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Have you ever wished that standing up a Solr server for Sitecore was easy? I have. So I made a script to make it so.</p>
<p>The Solr Cannon automates the setup and configuration of Solr on Windows (Note: Linux may be a better production choice if you have the option), including installation as a background service, Sitecore schema installation, core creation, and generating a Sitecore config patch file that will point Sitecore at your shiny new Solr server and its cores.</p>
<h2 id="What-you’ll-need"><a href="#What-you’ll-need" class="headerlink" title="What you’ll need"></a>What you’ll need</h2><ul>
<li>A copy of the <a target="_blank" rel="noopener" href="https://bitnami.com/stack/solr">Bitnami Solr Stack</a> for Windows (I used 5.5.0-1)</li>
<li>A copy of <a target="_blank" rel="noopener" href="https://gist.github.com/kamsar/ef8811bd458603f1e808#file-install-solr-ps1">the script</a> and the <a target="_blank" rel="noopener" href="https://gist.github.com/kamsar/ef8811bd458603f1e808#file-schema-xml">solr schema file</a> (the schema was generated with Sitecore 8.1 Update 1, you might need to generate your own if it doesn’t work)</li>
<li>PowerShell 3.0 or later</li>
</ul>
<h2 id="Let’s-do-this"><a href="#Let’s-do-this" class="headerlink" title="Let’s do this"></a>Let’s do this</h2><ul>
<li>Copy the Solr stack and scripts to a folder on the server that will run Solr</li>
<li>Review the <code>Install Solr.ps1</code> script to make sure the variables are to your liking (<em>project name</em>, ports, solr stack installer path, etc)</li>
<li>Open an administrative PowerShell prompt</li>
<li>Execute <code>Install Solr.ps1</code></li>
<li>Kick back for a couple minutes</li>
<li>Bask in the glow of your new Solr server and all of its Sitecore cores</li>
</ul>
<h2 id="But-what-about-the-rest"><a href="#But-what-about-the-rest" class="headerlink" title="But what about the rest?"></a>But what about the rest?</h2><p>Ok ok, that’s not all you need to do in order to configure Solr and Sitecore. </p>
<ul>
<li>Check out <a target="_blank" rel="noopener" href="http://sitecoreblog.patrickperrone.com/2015/02/sitecore-8-solr-part33-configur-ageddon.html">Patrick Perrone’s post</a> to help you <a target="_blank" rel="noopener" href="http://sitecoreblog.patrickperrone.com/2015/03/a-script-to-swap-search-in-sitecore.html">swap in Solr</a> as the search provider and configure the Solr IoC container. Note: I’d recommend Windsor for the IoC. Autofac and Ninject were less than awesome install experiences…</li>
<li>Once you have the Sitecore configuration flipped to Solr, you can grab the <code>Solr.config</code> file that the Solr Cannon produced when it installed Solr (written to the script directory). This config patch will:<ul>
<li>Point Sitecore at your Solr server</li>
<li>Make Sitecore look at the correct core names for each index</li>
<li>Enable <code>SwitchOnRebuildSolrIndex</code> which allows you to rebuild indexes without any index downtime (great for production…or dev)</li>
</ul>
</li>
<li>Load up Sitecore, open the indexing manager, and rebuild all your indexes. With a bit of luck, you’ll be good to go!</li>
</ul>
<h2 id="Multi-tenant-Solr"><a href="#Multi-tenant-Solr" class="headerlink" title="Multi-tenant Solr"></a>Multi-tenant Solr</h2><p>Suppose you’re working on your own machine and you’ve got more than one dev site that’s using Solr. The Solr Cannon scripts can act to create a new config set and cores for several Sitecore installations on the same Solr server. Edit the script to have a different <code>$ProjectName</code> set, run it again, and say no when asked if you need to install a Solr server. In this mode, the script will build out a config set and cores for a new Sitecore site, as well as the patch file.</p>
<p>Have fun :)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kamsar.net/index.php/2016/03/The-Solr-Cannon/" data-id="ckrl9emyb003x98q74pbb1jmn" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Branch-Datasource-Presets" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/index.php/2016/03/Branch-Datasource-Presets/">Branch Datasource Presets</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/index.php/2016/03/Branch-Datasource-Presets/">
    <time datetime="2016-03-15T21:39:23.000Z" itemprop="datePublished">March 15, 2016</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/index.php/category/Sitecore/">Sitecore</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Ever stored rendering component data source items under a page? For example:</p>
<pre><code>/sitecore/content/Page
/sitecore/content/Page/Datasources/ComponentDataSourceItem
</code></pre>
<p>It’s a good practice and it seems to work quite well for page specific components. I use it all the time.</p>
<p>But have you ever wished branch templates understood that pattern in a logical fashion? What if this:</p>
<pre><code>/sitecore/templates/branches/Foo/$name
/sitecore/templates/branches/Foo/$name/Datasources/ComponentDataSourceItem
</code></pre>
<p>…expanded out to have the branch create the hierarchy <strong>and</strong> re-link the layout details on the instiantiated branch item to point to the right relative child data source item, instead of the child item under the branch template?</p>
<p>Doing this lets you use branch templates to create preset rendering hierarchies, <strong>including</strong> page specific data source items.</p>
<p>Sound good? Well you’ve found the right place to <a target="_blank" rel="noopener" href="https://github.com/kamsar/BranchPresets">get the code to do just that</a>. This requires Sitecore 8 or above with the pipeline-based item provider to operate.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kamsar.net/index.php/2016/03/Branch-Datasource-Presets/" data-id="ckrl9emya003v98q7hfqbdpk0" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Unicorn-3-1-4-Released" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/index.php/2016/02/Unicorn-3-1-4-Released/">Unicorn 3.1.4 Released</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/index.php/2016/02/Unicorn-3-1-4-Released/">
    <time datetime="2016-02-29T04:19:12.000Z" itemprop="datePublished">February 28, 2016</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/index.php/category/Unicorn/">Unicorn</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Unicorn 3.1.4 and Rainbow 1.2 are released to NuGet. This is a maintenance release which contains a few UX improvements and minor bug fixes and improvements.</p>
<h2 id="What’s-new"><a href="#What’s-new" class="headerlink" title="What’s new?"></a>What’s new?</h2><h3 id="Logging-Verbosity"><a href="#Logging-Verbosity" class="headerlink" title="Logging Verbosity"></a>Logging Verbosity</h3><p>The most obvious change is that you can now select a logging verbosity in the control panel. If you’ve ever run a sync where many, many changes were synced you may have run into the issue where browsers start to crawl when fed that many log messages. Now you can choose to log only warnings or errors for that kind of situation. The Sitecore log files always get full verbosity, so you can see what exactly happened even if it was not written to the browser. Your verbosity setting is stored in a persistent cookie, so your selection is remembered.</p>
<p>Verbosity does not affect automated tools that invoke Unicorn. They always receive full verbosity. (<a target="_blank" rel="noopener" href="https://github.com/kamsar/Unicorn/issues/112">#112</a>)</p>
<h3 id="XML-Field-Formatting-Improved"><a href="#XML-Field-Formatting-Improved" class="headerlink" title="XML Field Formatting Improved"></a>XML Field Formatting Improved</h3><p>XML fields are now stored by default with attributes on new lines. This further improves mergeability of Rainbow serialized items by allowing attribute merges. If you hate this idea, you can turn it off in <code>Rainbow.config</code>. (<a target="_blank" rel="noopener" href="https://github.com/kamsar/Rainbow/issues/12">#12</a>)</p>
<p>Rainbow 1.1:</p>
<pre><code>&lt;r xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot;&gt;
  &lt;d id=&quot;&#123;FE5D7FDF-89C0-4D99-9AA3-B5FBD009C9F3&#125;&quot; l=&quot;&#123;0DAC6578-BC11-4B41-960A-E95F21A78D1F&#125;&quot; /&gt;
&lt;/r&gt;
</code></pre>
<p>Rainbow 1.2 (Unicorn 3.1.3+):</p>
<pre><code>&lt;r xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot;&gt;
  &lt;d
    id=&quot;&#123;FE5D7FDF-89C0-4D99-9AA3-B5FBD009C9F3&#125;&quot;
    l=&quot;&#123;0DAC6578-BC11-4B41-960A-E95F21A78D1F&#125;&quot; /&gt;
&lt;/r&gt;
</code></pre>
<p>This formatting change is completely backwards compatible and no reserialization is required. As items are saved, they will be rewritten to use attributes on newlines.</p>
<h3 id="Fixes-amp-Minor-Improvements"><a href="#Fixes-amp-Minor-Improvements" class="headerlink" title="Fixes &amp; Minor Improvements"></a>Fixes &amp; Minor Improvements</h3><ul>
<li>The UX of the control panel has been streamlined to result in less vertical space for each configuration, a boon for setups like Habitat with lots of configurations.</li>
<li>Unicorn auto publishing now functions correctly on items with versions in several languages (<a target="_blank" rel="noopener" href="https://github.com/kamsar/Unicorn/issues/114">#114</a>)</li>
<li>Using the “Copy to” function will no longer result in an incorrect serialized parent ID on the copied item. Other forms of duplication were not affected. (<a target="_blank" rel="noopener" href="https://github.com/kamsar/Unicorn/issues/119">#119</a>)</li>
<li>Fixed a case where <code>NullReferenceException</code> was incorrectly thrown when using transparent sync (<a target="_blank" rel="noopener" href="https://github.com/kamsar/Unicorn/pull/117">#117</a>)</li>
<li>Fixed an error when duplicating items that did not exist in the database when using transparent sync (<a target="_blank" rel="noopener" href="https://github.com/kamsar/Unicorn/issues/116">#116</a>)</li>
<li>Rainbow YAML formatting is more friendly to third party YAML parsers with the way it escapes values. This does mean that some values that did not previously get wrapped in double quotes (like GUIDs), will now have it going forward. Format is backwards compatible, no reserialize required. Items will upgrade to the new version on save. (<a target="_blank" rel="noopener" href="https://github.com/kamsar/Rainbow/issues/11">#11</a>)</li>
</ul>
<h2 id="Upgrading"><a href="#Upgrading" class="headerlink" title="Upgrading"></a>Upgrading</h2><p>To upgrade simply update your NuGet packages. There are no other steps required for this release <strong>unless coming from <a href="https://kamsar.net/index.php/2016/01/Unicorn-3-1-Released/">Unicorn 3.0.x</a></strong>. </p>
<p>If you wish to completely normalize your items to the latest Rainbow 1.2 format, you may reserialize them. But it is not a requirement, as Rainbow 1.2 can parse 1.1 serialized items.</p>
<h2 id="Credits"><a href="#Credits" class="headerlink" title="Credits"></a>Credits</h2><p>As usual, Unicorn updates are a community effort. Big thanks to the folks below for reporting bugs, sending pull requests, and general encouragement.</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/agehrke">Andreas Gehrke</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/PetersonDave">Dave Peterson</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/TheCodeKing">Mike Carlisle</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/DotTech">Ruud van Falier</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/sbouwmeester">Sander Bouwmeester</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/stasmaxymov">Stanislav Maxymov</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kamsar.net/index.php/2016/02/Unicorn-3-1-4-Released/" data-id="ckrl9emya003t98q78i8u56zw" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Unicorn-3-1-Released" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/index.php/2016/01/Unicorn-3-1-Released/">Unicorn 3.1 Released</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/index.php/2016/01/Unicorn-3-1-Released/">
    <time datetime="2016-01-27T04:58:31.000Z" itemprop="datePublished">January 26, 2016</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/index.php/category/Unicorn/">Unicorn</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Unicorn 3.1 and Rainbow 1.1 are released to NuGet. These updated versions bring several new features and a bunch of fixes. Upgrading is recommended for all users of Unicorn 3.0 due to the fixing of some data issues.</p>
<h2 id="What’s-new"><a href="#What’s-new" class="headerlink" title="What’s new?"></a>What’s new?</h2><h3 id="Configuration-Dependencies"><a href="#Configuration-Dependencies" class="headerlink" title="Configuration Dependencies"></a>Configuration Dependencies</h3><p>Unicorn configurations may now declare dependency relationships between each other. This is useful for example when one configuration may contain templates and another configuration might contain items based on those templates. With a dependency relationship the dependent configurations are guaranteed to always go first when configurations are synced. Transitive relationships (e.g. A -&gt; B -&gt; C) are supported.</p>
<p>Dependencies are defined using <a target="_blank" rel="noopener" href="https://github.com/kamsar/Unicorn/blob/master/src/Unicorn/Standard%20Config%20Files/Unicorn.Configs.Dependency.config.example">a dependencies attribute</a> on the configuration.</p>
<p>Dependencies <strong>do not</strong> force dependent configurations to sync. If config <code>A</code> depends on config <code>B</code> and you choose to sync only config <code>A</code>, <code>B</code> will not be synced. However if you sync <em>both</em> <code>A</code> and <code>B</code>, then <code>B</code> will always sync first due to the dependency.</p>
<h3 id="Include-Exclude-Predicate-Enhancements"><a href="#Include-Exclude-Predicate-Enhancements" class="headerlink" title="Include/Exclude Predicate Enhancements"></a>Include/Exclude Predicate Enhancements</h3><p>The predicate system has been significantly overhauled in Unicorn 3.1 to allow more advanced include and exclude scenarios.</p>
<ul>
<li><p>Exclude entries may now use paths relative to the parent <code>&lt;include&gt;</code> by omitting a leading slash. This would exclude <code>/foo/bar</code>: </p>
<pre><code>  &lt;include path=&quot;/foo&quot;&gt;
      &lt;exclude path=&quot;bar&quot; /&gt;
  &lt;/include&gt;
</code></pre>
</li>
</ul>
<ul>
<li><p>A new explicit grammar for excluding all children of an include has been introduced. This replaces the previous implicit grammar of adding a trailing slash (which still works but is deprecated).</p>
<pre><code>  &lt;include path=&quot;/foo&quot;&gt;
      &lt;exclude children=&quot;true&quot; /&gt;
  &lt;/include&gt;
</code></pre>
</li>
<li><p>The explicit children grammar supports <code>&lt;except&gt;</code> syntax to exclude all children <a target="_blank" rel="noopener" href="https://github.com/kamsar/Unicorn/blob/master/src/Unicorn.Tests/Predicates/TestConfiguration.xml#L31">except for specific ones</a>.</p>
<pre><code>  &lt;include path=&quot;/somechildren&quot;&gt;
      &lt;exclude children=&quot;true&quot;&gt;
          &lt;except name=&quot;tests&quot; /&gt;
          &lt;except name=&quot;fests&quot; /&gt;
      &lt;/exclude&gt;
  &lt;/include&gt;
</code></pre>
</li>
<li><p>A new explicit grammar for excluding only children of a specific sub-path has been added. This grammar also supports <a target="_blank" rel="noopener" href="https://github.com/kamsar/Unicorn/blob/master/src/Unicorn.Tests/Predicates/TestConfiguration.xml#L41"><code>&lt;except&gt;</code> syntax</a> and relative paths.</p>
<pre><code>  &lt;include path=&quot;/foo&quot;&gt;
      &lt;exclude childrenOfPath=&quot;/foo&quot; /&gt;
      &lt;exclude childrenOfPath=&quot;bar&quot;&gt; &lt;!-- /foo/bar/* --&gt;
          &lt;except name=&quot;quux&quot; /&gt; &lt;!-- include /foo/bar/quux --&gt;
      &lt;/exclude&gt;
  &lt;/include&gt;
</code></pre>
</li>
</ul>
<p>Take a look at the <a target="_blank" rel="noopener" href="https://github.com/kamsar/Unicorn/blob/master/src/Unicorn.Tests/Predicates/TestConfiguration.xml">test predicate configuration</a> for examples of all available grammars.</p>
<h3 id="Control-Panel-Tool-Authentication"><a href="#Control-Panel-Tool-Authentication" class="headerlink" title="Control Panel Tool Authentication"></a>Control Panel Tool Authentication</h3><p>The method used to authenticate automated tools to Unicorn has been updated to be significantly more secure using a <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Challenge-Handshake_Authentication_Protocol">CHAP</a> implementation. This also comes with a handy <a target="_blank" rel="noopener" href="https://github.com/kamsar/Unicorn/tree/master/doc/PowerShell%20Remote%20Scripting">PowerShell module</a> that you can use to simply invoke the handshake from a build script.</p>
<p>Should you require the legacy shared secret method, that is <a target="_blank" rel="noopener" href="https://github.com/kamsar/Unicorn/blob/master/src/Unicorn/Standard%20Config%20Files/Unicorn.UI.config#L24">still available but it is not the default</a>. Security is also now pluggable, if you wanted to use your own implementation.</p>
<p>The remote API ships disabled by default and you must activate it by <a target="_blank" rel="noopener" href="https://github.com/kamsar/Unicorn/blob/master/src/Unicorn/Standard%20Config%20Files/Unicorn.UI.config#L18">generating a random shared secret and adding it to the config</a>. This same secret must be known to invoke the API, and unlike the legacy API the secret is never transmitted directly.</p>
<h3 id="Breaking-Changes"><a href="#Breaking-Changes" class="headerlink" title="Breaking Changes"></a>Breaking Changes</h3><p>Unicorn 3.1 has some breaking changes compared to Unicorn 3.0, so upgrading requires reserializing your items to get them in a consistent format with the latest version. Unicorn 3.1 does understand Unicorn 3.0-formatted items, but Unicorn 3.0 <em>does not</em> understand Unicorn 3.1-formatted items. There will also be some repeated changes in the logs if you sync 3.0 items with 3.1, so usage with 3.0 items is not recommended.</p>
<p>Introducing breaking changes was a hard decision to make, but I think the saner defaults and new capabilities will justify the slightly more difficult upgrade process. So what’s breaking?</p>
<ul>
<li>The item’s database name is now stored in the serialized data (<a target="_blank" rel="noopener" href="https://github.com/kamsar/Rainbow/pull/7">#7</a>). This enables parsing serialized items in contexts where the database cannot easily be inferred, such as Courier.</li>
<li>Unversioned fields have official support and are nested under the <code>Language</code> instead of under a <code>Version</code> within the language which was incorrect. Prior to reserializing, syncing a 3.0-formatted item with 3.1 may result in messages that the field has been reset to standard values and then set again. <code>IItemData</code> now has an <code>UnversionedFields</code> property to store unversioned fields by language.</li>
<li>The name on serialized fields has been converted from a comment in the YAML into an actual parsed value. Note that this value is just a hint and if a template field is renamed it is NOT updated automatically.</li>
<li>The default setting of <code>Rainbow.SFS.ExtraInvalidFilenameCharacters</code> has been changed to <code>&quot;$&quot;</code> to make Rainbow compatible by default with TFS, and the TFS config example that previously set this has been removed.</li>
<li>The default setting for <code>Rainbow.SFS.SerializationFolderPathMaxLength</code> has been increased from <code>90</code> to <code>110</code> based on real world experience that 90 is too short.</li>
<li>The default setting for <code>Rainbow.SFS.MaxItemNameLengthBeforeTruncation</code> has been reduced from <code>100</code> to <code>30</code> based on real world experience that 100 was long enough to break the path length limitation for items with near 100 length names.</li>
<li>Automated deployment tools calling Unicorn have a new security API. See below for details on this, but it’s now more secure.</li>
</ul>
<h3 id="Other-Improvements"><a href="#Other-Improvements" class="headerlink" title="Other Improvements:"></a>Other Improvements:</h3><ul>
<li>Syncing dictionary items will now cause the dictionary cache to be cleared at the end of the sync, forcing the synced entries to be loaded.</li>
<li>The Unicorn Control Panel is now pipeline-based and extensible so that modules may define their own verbs or alter the UI if needed.</li>
<li>Error messages when serializing and deserializing XML-based fields (layout, rules) have been improved.</li>
<li>Unicorn and Rainbow both now utilize the C# 6.0 syntax and require the <a target="_blank" rel="noopener" href="https://www.microsoft.com/en-us/download/details.aspx?id=48159">C# 6.0 compiler</a> to build. They still target .NET 4.5.</li>
<li>Config file comments and documentation have been updated to cover the new features of Unicorn 3.1.</li>
</ul>
<h3 id="Bug-fixes"><a href="#Bug-fixes" class="headerlink" title="Bug fixes:"></a>Bug fixes:</h3><ul>
<li>Renaming or moving items which are serialized on loopback paths will no longer cause the serialized children to be deleted.</li>
<li>Missing field errors on the root item of a tree now result in a retry and non fatal error as expected.</li>
<li>A non fatal warning when syncing multiple configurations will no longer result in the sync stopping at the end of the configuration with the non fatal warning.</li>
<li>When using the New Items Only evaluator, you will no longer receive sync conflict warnings when saving items created by the evaluator.</li>
<li>Copying items when Transparent Sync is enabled and the source item is not in the Sitecore database now works correctly.</li>
<li>Empty field values will no longer cause problems when Transparent Sync is enabled.</li>
<li>XML-based fields (layout, rules) with empty values will no longer cause exceptions. <a target="_blank" rel="noopener" href="https://github.com/kamsar/Rainbow/pull/6">#6</a>, <a target="_blank" rel="noopener" href="https://github.com/kamsar/Unicorn/issues/90">#90</a></li>
<li>Items installed by Sitecore packages or update packages into Unicorn configuration areas will no longer lose some field values in the serialized items. <a target="_blank" rel="noopener" href="https://github.com/kamsar/Unicorn/issues/92">#92</a></li>
<li>Predicate include entries and SFS trees are no longer confused by paths which are different but start with similar bases, such as <code>/sitecore/content</code> and <code>/sitecore/content monkey</code></li>
<li>Plain text Unicorn logs returned to automated tool calls will no longer include HTML-encoded values such as <code>&amp;gt;</code></li>
<li>Naming items a <a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa365247(v=vs.85).aspx">Windows reserved file name</a> such as CON or COM1 will no longer result in an error. <a target="_blank" rel="noopener" href="https://github.com/kamsar/Rainbow/issues/8">#8</a></li>
<li>Fields with a blank value in Sitecore that were not included in the serialized item were not being correctly reset to standard values. This has been fixed.</li>
</ul>
<h2 id="Upgrading"><a href="#Upgrading" class="headerlink" title="Upgrading"></a>Upgrading</h2><p>Ok so there are breaking changes, how do I upgrade? Thankfully it’s not too hard.</p>
<ol>
<li><strong>Before</strong> you upgrade, run a full sync of all configurations. If some have Transparent Sync enabled, turn that off during the upgrade. (you can reenable after step 4)</li>
<li>Upgrade your NuGet packages to Unicorn 3.1. (which will also install Rainbow 1.1)</li>
<li>Run a build of your solution, and if you develop out of webroot publish your changes.</li>
<li>Using the Unicorn control panel, <strong>Reserialize</strong> all configurations to flush them to disk as 3.1-format items.</li>
<li>If you use the automated tool API to do automated execution of Unicorn, migrate to the <a target="_blank" rel="noopener" href="https://github.com/kamsar/Unicorn/tree/master/doc/PowerShell%20Remote%20Scripting">PowerShell module</a> to invoke the new API.</li>
<li>Have fun!</li>
</ol>
<h2 id="Contributors"><a href="#Contributors" class="headerlink" title="Contributors"></a>Contributors</h2><p>Unicorn 3.1 has seen contributions from many community members. Thank you all for your support, testing, bug reports, and contributions!</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/cassidydotdk">Mark Cassidy</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Eldblom">Thomas Eldblom</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/agehrke">Andreas Gerhke</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/OlegJytnik">Oleg Jytnik</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/patoncrispy">Chris Paton</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/drachele">Daniel Rachele</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/divamatrix">Lewanna Rathbun</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/guitarrich">Richard Seal</a></li>
<li><a target="_blank" rel="noopener" href="https://twitter.com/BerserkerDotNET">Andrii Snihyr</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/csteeg">Chris van de Steeg</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/GeorgeKarbyn">George Thomaidis</a></li>
<li><a target="_blank" rel="noopener" href="https://twitter.com/williamsk000">Kevin Williams</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/dashkodo">dashkodo</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/devstack">devstack</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/uandrei">uandrei</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kamsar.net/index.php/2016/01/Unicorn-3-1-Released/" data-id="ckrl9emy9003r98q70jcl0y37" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Benchmark-Show-Precompilation" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/index.php/2016/01/Benchmark-Show-Precompilation/">The Benchmark Show: Sitecore Precompilation</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/index.php/2016/01/Benchmark-Show-Precompilation/">
    <time datetime="2016-01-05T04:20:35.000Z" itemprop="datePublished">January 4, 2016</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/index.php/category/Sitecore/">Sitecore</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I’m <a href="https://kamsar.net/index.php/2015/02/sitecore-8-experience-editor-performance-optimization/">mildly obsessed with Sitecore performance</a>, so when I found a new trick I had to see what it could do: <a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/ms229863.aspx"><code>aspnet_compiler.exe</code></a>. This is a really old tool that was designed to compile your .aspx pages into an assembly - and then later your cshtml as well. This improves startup time because no dynamic compilation needs to take place at runtime.</p>
<p>Getting <code>aspnet_compiler</code> to run against Sitecore, by which I mean executing it against an entire deployment ready web root including both your code and the <code>sitecore</code> folder, is a bit of a challenge. Because you cannot tell <code>aspnet_compiler</code> to ignore anything, and because one of the cshtml files in Sitecore 8.1 Update-1 apparently has a compiler error (for the curious, add <code>@using Sitecore.ListManagement.Client.Web.UI.Controls.ImportMapTo</code> to /sitecore/shell/client/Applications/ListManager/Controls/ContactFields/ContactFields.cshtml). You also have to comment out the <code>@Html.Sitecore()</code>s in /sitecore/shell/Templates/layout.cshtml (don’t worry it’s just a template used when you add a new MVC layout).</p>
<p>Once you get the fixes made, running <code>aspnet_compiler</code> is as simple as:</p>
<p><code>&quot;c:\Windows\Microsoft.NET\Framework\v4.0.30319\aspnet_compiler.exe&quot; -v / -p &quot;c:\path\to\deploy\ready\files&quot; &quot;c:\output\path&quot;</code></p>
<p>It will take a while - probably at least a minute - while it compiles every aspx and cshtml in the whole place into assemblies.</p>
<h2 id="Cool-trick-Does-it-work"><a href="#Cool-trick-Does-it-work" class="headerlink" title="Cool trick. Does it work?"></a>Cool trick. Does it work?</h2><p>Let’s look at some hard data. I took my base Sitecore site (which runs <a target="_blank" rel="noopener" href="https://gist.github.com/kamsar/8c9efc80e72e6ada8304">Performance.config</a>) and executed my deployment scripts over it, then precompiled that to a new folder with <code>aspnet_compiler</code>. Then I devised several tests to tease out both the effects of precompilation and whether Sitecore’s built in SPEAK precompilation has improved since its 8.0 days - where it could make startup take 140 seconds. The tests were in most cases run both with a cold <em>ASP.NET Temporary Files</em> folder (where .NET puts compiled Razor caches) and with a warm one for comparison. Cold would be the first startup on a new machine, whereas warm would be after an app pool recycle thereafter.</p>
<h3 id="Test-1-Home-Page"><a href="#Test-1-Home-Page" class="headerlink" title="Test 1: Home Page"></a>Test 1: Home Page</h3><p>This is a simple test of loading the home page, which is a fairly simple Sitecore MVC layout with about 4 view and controller renderings and several partials. All tests begin with the app pool stopped and no <code>w3wp</code> executing.</p>
<h3 id="Test-2-SPEAK-Media-Library-Dialog"><a href="#Test-2-SPEAK-Media-Library-Dialog" class="headerlink" title="Test 2: SPEAK Media Library Dialog"></a>Test 2: SPEAK Media Library Dialog</h3><p>The SPEAK media browser (what you get when browsing from an image field, for example) has been historically a pain point performance wise. For this test I loaded the dialog iframe URL into a Chrome tab and measured the time to finish page load with the Chrome developer tools.</p>
<h2 id="Results"><a href="#Results" class="headerlink" title="Results"></a>Results</h2><h3 id="Home-Page-cold"><a href="#Home-Page-cold" class="headerlink" title="Home Page (cold)"></a>Home Page (cold)</h3><p>Baseline (Performance.config): 22.25s<br>SC Precompiler: 24.8s<br>Precompiled: 21.5s</p>
<p>As expected the precompiled is marginally fastest. Sitecore 8.1’s precompilation function, as we’ll see throughout the tests, seems to add 2-4 seconds to startup time. Without preexisting compiled temp files, startup is extremely slow in all cases - unexpectedly so for the supposedly ‘precompiled’ site. My guess is that it copies the precompiled files to the temp folder, which expends I/O, but that’s a guess.</p>
<h3 id="Home-Page-warm"><a href="#Home-Page-warm" class="headerlink" title="Home Page (warm)"></a>Home Page (warm)</h3><p>Baseline: 9.71s<br>SC Precompiler: 13.97s<br>Precompiled: 9.51s</p>
<p>With the temporary files warm, startup gets much faster. Once again the Sitecore precompiler is in last place.</p>
<h3 id="SPEAK-Media-cold"><a href="#SPEAK-Media-cold" class="headerlink" title="SPEAK Media (cold)"></a>SPEAK Media (cold)</h3><p>Baseline: 29.6s<br>SC Precompiler: 33.8s<br>Precompiled: 22.93s</p>
<p>The effects of precompilation are strong when loading the very complex, partial-heavy SPEAK dialog - coming in 47% faster than the Sitecore default.</p>
<h3 id="SPEAK-Media-warm"><a href="#SPEAK-Media-warm" class="headerlink" title="SPEAK Media (warm)"></a>SPEAK Media (warm)</h3><p>Baseline: 12.2s<br>SC Precompiler: 16s<br>Precompiled: 12.82s<br>SC Precompiler (warmed): 13.23s</p>
<p>Performance is nearly identical once the temporary compiled files are cached the first time for SPEAK. In this case there is also a test for having warmed the Sitecore precompiler and allowed it to finish precompiling in the background, then restarted the cold app pool. </p>
<h2 id="Analysis-TL-DR"><a href="#Analysis-TL-DR" class="headerlink" title="Analysis (TL;DR)"></a>Analysis (TL;DR)</h2><p>Overall the effects of using <code>aspnet_compiler</code> prior to deployment are relatively minor in most real world cases. Initial startup is ideally a rare case, and once their caches are heated all options perform quite similarly (as an example, the second hit to the media dialog is ~250ms to finish). For more elastic deployments, such as cloud setups, or for larger clusters it is probably worth the effort since you burn the CPU cycles once and it does significantly improve first hit to SPEAK dialogs as well as marginal overall performance improvements. Rendering heavy Sitecore MVC implementations would also likely see similar gains to SPEAK. In addition to performance, using the <code>aspnet_compiler</code> validates the C# in your Razor views - which is a nice plus in the event of a Razor syntax error which would normally be discovered at runtime.</p>
<p>The big downside of precompiling is that it’s fairly slow (several minutes on fast hardware, probably much slower otherwise or without SSDs), and that it has to re-copy the whole web root to another output location (lots of I/O). So overall build time on CI may increase significantly.</p>
<h3 id="Another-option-Use-the-Sitecore-precompiler"><a href="#Another-option-Use-the-Sitecore-precompiler" class="headerlink" title="Another option: Use the Sitecore precompiler"></a>Another option: Use the Sitecore precompiler</h3><p>If you look at the results, <em>startup time</em> with the Sitecore precompiler is always a bit longer. But once the Sitecore precompiler completes its asynchronous run - usually within a couple minutes after startup - the results are very close to a natively precompiled site (see the warm media dialog results). This is overall a much simpler option. It does mean every instance has to compile for itself, but it does not require adaptation of the build process nor long times spent copying files.</p>
<p>And here’s the best part: <em>you can use it for your own views, too</em>. It’s just a Razor precompiler pipeline processor, and you can add one - or more - for your sites’ MVC views. For example:</p>
<pre><code>&lt;processor type=&quot;Sitecore.Pipelines.Initialize.PrecompileSpeakViews, Sitecore.Speak.Client&quot;&gt;
    &lt;Paths&gt;/Areas/MySite/Views&lt;/Paths&gt; &lt;!-- virtual path to your views --&gt;
&lt;/processor&gt;
</code></pre>
<p>This will cause your views to all get precompiled asynchronously on startup - if they are not already - which writes their assemblies into the <em>Temporary ASP.NET Files</em> folder. So you trade a couple seconds of startup time, and an initial spike of CPU cycles, for consistent performance thereafter. However, you lose the protection against syntax errors provided by build-time precompilation.</p>
<p>Next time on the benchmark show: Common Sitecore development tasks, benchmarked on a variety of hardware.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kamsar.net/index.php/2016/01/Benchmark-Show-Precompilation/" data-id="ckrl9emy8003n98q78eu654g6" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/index.php/page/3/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/index.php/page/2/">2</a><a class="page-number" href="/index.php/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/index.php/page/5/">5</a><a class="page-number" href="/index.php/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/index.php/page/11/">11</a><a class="extend next" rel="next" href="/index.php/page/5/">Next &amp;raquo;</a>
    </nav>
  
</section>
      
        <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul id="recent-post" class="no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/index.php/category/JavaScript/">JavaScript</a></p>
              <p class="item-title"><a href="/index.php/2021/07/Fun-with-async-generators-and-for-await/" class="title">Fun with async generators and for await</a></p>
              <p class="item-date"><time datetime="2021-07-26T23:30:51.000Z" itemprop="datePublished">July 26, 2021</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/index.php/category/Jamstack/">Jamstack</a></p>
              <p class="item-title"><a href="/index.php/2020/08/Deploying-multiple-Netlify-sites-from-one-Git-repository/" class="title">Deploying multiple Netlify sites from one monorepo</a></p>
              <p class="item-date"><time datetime="2020-08-21T03:30:32.000Z" itemprop="datePublished">August 20, 2020</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/index.php/category/JSS/">JSS</a></p>
              <p class="item-title"><a href="/index.php/2019/09/Running-JSS-headless-mode-in-containers-part-2-Build-containers/" class="title">Running JSS headless mode in containers part 2: Build containers</a></p>
              <p class="item-date"><time datetime="2019-09-16T02:14:04.000Z" itemprop="datePublished">September 15, 2019</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/index.php/category/JSS/">JSS</a></p>
              <p class="item-title"><a href="/index.php/2019/09/Running-JSS-headless-mode-in-containers-part-1/" class="title">Running JSS headless mode in containers, part 1</a></p>
              <p class="item-date"><time datetime="2019-09-08T19:00:36.000Z" itemprop="datePublished">September 8, 2019</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/index.php/category/C/">C#</a></p>
              <p class="item-title"><a href="/index.php/2019/05/Build-2019-All-the-things/" class="title">Build 2019: All the things</a></p>
              <p class="item-date"><time datetime="2019-05-10T23:01:11.000Z" itemprop="datePublished">May 10, 2019</time></p>
            </div>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/index.php/category/April-1/">April 1</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Blade/">Blade</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Build-Scripts/">Build Scripts</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/C/">C#</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Dianoga/">Dianoga</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/JSS/">JSS</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Jamstack/">Jamstack</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/JavaScript/">JavaScript</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Node-js/">Node.js</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Sitecore/">Sitecore</a><span class="category-list-count">39</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Sitecore/Crypto/">Crypto</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Sitecore/Lucene/">Lucene</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Sitecore/MVC/">MVC</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Sitecore/Search/">Search</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Sitecore/xDB/">xDB</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Synthesis/">Synthesis</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Unicorn/">Unicorn</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/WebConsole/">WebConsole</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  
  <div id="toTop" class="fa fa-chevron-up"></div>
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      <p>&copy; 2021 Kam Figy</p>
      <p><small>Opinions expressed on this blog are my own, and not necessarily those of my employer.</small></p>
     <p><small>This work is licensed under a <a rel="license noopener" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</small></p>
    </div>
  </div>
</footer>
    


<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>




<script src="/js/script.js"></script>


  </div>
</body>
</html>