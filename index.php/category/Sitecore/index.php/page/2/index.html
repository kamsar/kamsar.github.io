<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Category: Sitecore | Kam&#39;s Idea Log</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Kam&#39;s Idea Log">
<meta property="og:url" content="https://kamsar.net/index.php/category/Sitecore/index.php/page/2/index.html">
<meta property="og:site_name" content="Kam&#39;s Idea Log">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Kam Figy">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@kamsar">
  
    <link rel="alternative" href="/index.php/feed" title="Kam&#39;s Idea Log" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:400italic,400,600' rel='stylesheet' type='text/css'>
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">

  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-62284328-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


<meta name="generator" content="Hexo 5.4.0"></head>
<body>
  <div id="container">
    <header id="header">
  <div id="header-main" class="header-inner">
    <div class="outer">
      <a href="/" id="logo">
        <span class="site-title">Kam&#39;s Idea Log</span>
        <span class="subtitle">C#, Jamstack, and Shenanigans</span>
      </a>
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/blog/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        <div class="profile" id="profile-nav">
          <a id="profile-anchor" href="javascript:;"><img class="avatar" src="https://www.gravatar.com/avatar/314826f5d569260f26ac9f26f9e38b86?s=40" srcset="https://www.gravatar.com/avatar/314826f5d569260f26ac9f26f9e38b86?s=80 2x" alt="omg the beard"><i class="fa fa-caret-down"></i></a>
        </div>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"> </button><input type="hidden" name="sitesearch" value="https://kamsar.net"></form>
      </div>
    </div>
  </div>
  <div id="main-nav-mobile" class="header-sub header-inner">
    <table class="menu outer">
      <tr>
      
        <td><a class="main-nav-link" href="/">Home</a></td>
      
        <td><a class="main-nav-link" href="/blog/archives">Archives</a></td>
      
      <td>
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="https://kamsar.net"></form>
      </td>
      </tr>
    </table>
  </div>
  
  <div id="header-sub" class="header-sub header-inner">
    <div class="outer">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/index.php/category/April-1/">April 1</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Blade/">Blade</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Build-Scripts/">Build Scripts</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/C/">C#</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Dianoga/">Dianoga</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/JSS/">JSS</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Jamstack/">Jamstack</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/JavaScript/">JavaScript</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Node-js/">Node.js</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Sitecore/">Sitecore</a><span class="category-list-count">39</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Synthesis/">Synthesis</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Unicorn/">Unicorn</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/WebConsole/">WebConsole</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>
  
</header>
    <div class="outer">
      <aside id="profile">
  <div class="inner profile-inner">
  	<div class="base-info profile-block">
		  <img id="avatar" src="https://www.gravatar.com/avatar/314826f5d569260f26ac9f26f9e38b86?s=128" srcset="https://www.gravatar.com/avatar/314826f5d569260f26ac9f26f9e38b86?s=256 2x" alt="#sitecorebeard">
      <h2 id="name">Kam Figy</h2>
      <h3 id="title">Principal Platform Architect at</h3>
      <a class="corp-logo" href="https://uniform.dev" target="_blank"><img src="/css/images/uniform-logo.svg" alt="Uniform" width="180"></a>
      <span id="location"><i class="fa fa-map-marker"></i>Vancouver, WA USA</span>
      <a id="follow" target="_blank" rel="noopener" href="https://twitter.com/kamsar">FOLLOW</a>
  	</div>
    <div class="contact-info profile-block">
      <table class="contact-list">
        <tr>
        
          <td><a target="_blank" rel="noopener" href="https://github.com/kamsar" title="github"><i class="fa fa-github"></i></a></td>
        
          <td><a target="_blank" rel="noopener" href="https://twitter.com/kamsar" title="twitter"><i class="fa fa-twitter"></i></a></td>
        
          <td><a href="/index.php/feed" title="rss"><i class="fa fa-rss"></i></a></td>
        
        </tr>
      </table>
    </div>
    <div class="article-info profile-block bio">
      <h2>About</h2>
      <p>Kam has been making websites since 1996, starting out with a 14.4k modem on a <a href="https://en.wikipedia.org/wiki/Party_line_(telephony)" target="_blank">party line</a> in the Hawaiian rainforest. A veteran developer, architect, and speaker, he's been working in the content management space for well over a decade. Kam is the author of <a href="https://github.com/kamsar/Unicorn" target="_blank">Unicorn</a>, <a href="https://github.com/kamsar/Synthesis" target="_blank">Synthesis</a>, <a href="https://github.com/kamsar/Dianoga" target="_blank">Dianoga</a>, and several other open-source libraries.</p>
    </div>
  </div>
</aside>
      <section id="main">
  
  
    
    
      
        <div class="archive-year-wrap">
          <i class="fa fa-calendar"></i>
          <a href="/archives/2016" class="archive-year">2016</a>
        </div>
    
    <article id="post-Precompiled-Views-with-Sitecore-8-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/index.php/2016/09/Precompiled-Views-with-Sitecore-8-2/">Precompiled Views with Sitecore 8.2</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/index.php/2016/09/Precompiled-Views-with-Sitecore-8-2/">
    <time datetime="2016-09-02T19:20:43.000Z" itemprop="datePublished">September 2, 2016</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/index.php/category/Sitecore/">Sitecore</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>A while ago I wrote a post about <a href="/index.php/2016/01/Benchmark-Show-Precompilation/">speeding up your views with precompilation</a>.</p>
<p>After writing that post I learned about <a target="_blank" rel="noopener" href="https://github.com/RazorGenerator/RazorGenerator">RazorGenerator</a> which <a target="_blank" rel="noopener" href="http://www.chrisvandesteeg.nl/2010/11/22/embedding-pre-compiled-razor-views-in-your-dll/">Chris van de Steeg blogged about</a>. RazorGenerator is better in just about every way compared to <code>aspnet_compiler.exe</code>. Whereas the <code>aspnet_compiler</code> just warms the compiler cache for the current machine, RazorGenerator builds the generated classes for your Razor files <em>directly into your assemblies</em>.</p>
<p>With RazorGenerator you can compile once and deploy everywhere. Getting started with it is almost stupidly simple. Seriously, I described the whole process <a target="_blank" rel="noopener" href="https://twitter.com/kamsar/status/684823059082027008">in one tweet</a>: Install the <code>RazorGenerator.MsBuild</code> NuGet package. That’s it. So what does that get you?</p>
<ul>
<li>Compile-time view syntax checking. Ever deployed a Razor file that broke at runtime after a “successful” build? Well now your builds will <em>fail</em> if your Razor syntax is invalid. Hoorah!</li>
<li>Your Razor views are compiled into your output assembly (look at it in DotPeek and see the <code>ASP</code> namespace)</li>
<li>It’s fast. You probably won’t even notice the build time difference.</li>
</ul>
<h2 id="But-that’s-not-quite-all"><a href="#But-that’s-not-quite-all" class="headerlink" title="But that’s not quite all"></a>But that’s not quite all</h2><p>Right, so how do you get your precompiled views to actually get loaded? ASP.NET MVC doesn’t understand how to resolve <em>classes</em> instead of <em>files</em> out of the box. With Sitecore 8.1 and earlier, you could use the <code>RazorGenerator.Mvc</code> NuGet package and <a target="_blank" rel="noopener" href="https://github.com/RazorGenerator/RazorGenerator/wiki/Using-RazorGenerator.Mvc">wire up its <code>PrecompiledViewEngine</code></a> to accomplish this.</p>
<p>Sitecore 8.2 modernizes a lot of the MVC implementation under the covers, and part of that is that the Sitecore infrastructure now supports precompiled views natively! (Wondering why the experience editor starts up a lot faster in 8.2? That’s why.) It’s really easy to use, in fact: all you have to do is tell Sitecore which assemblies to look for precompiled views in and it does the rest. Behold:</p>
<pre><code>&lt;configuration xmlns:patch=&quot;http://www.sitecore.net/xmlconfig/&quot;&gt;
  &lt;sitecore&gt;
    &lt;mvc&gt;
      &lt;precompilation&gt;
        &lt;assemblies&gt;
          &lt;assemblyIdentity name=&quot;My.Project&quot; /&gt;
          &lt;assemblyIdentity name=&quot;My.OtherProject&quot; /&gt;
        &lt;/assemblies&gt;
      &lt;/precompilation&gt;
    &lt;/mvc&gt;
  &lt;/sitecore&gt;
&lt;/configuration&gt;
</code></pre>
<p><strong>CAVEAT</strong>: The Sitecore precompiler is greedy by default. When it is on, if a class exists for your view, <em>the physical file for the view is not checked</em>. You can even delete it. This means that you cannot tweak the cshtml file and have updates be reflected. You can enable timestamp checking if you must by changing this setting:</p>
<pre><code>&lt;configuration xmlns:patch=&quot;http://www.sitecore.net/xmlconfig/&quot;&gt;
  &lt;sitecore&gt;
    &lt;settings&gt;
      &lt;!--  MVC: Flag for controlling whether Razor View Engine will look at physical view last modified dates 
        when determining to use a view file from a pre-compiled assembly or from the file system.
        Default: &quot;false&quot;
        --&gt;
        &lt;setting name=&quot;Mvc.UsePhysicalViewsIfNewer&quot; value=&quot;false&quot; /&gt;
      &lt;/settings&gt;
  &lt;/sitecore&gt;
&lt;/configuration&gt;
</code></pre>
<p>Because there are (minor) performance implications of doing the timestamp checks, I would advise <em>enabling</em> this setting for development and <em>disabling</em> the setting for production. You should never, ever be changing files on production after a deployment anyway.</p>
<h2 id="Recap"><a href="#Recap" class="headerlink" title="Recap"></a>Recap</h2><p>If you’re on Sitecore 8.2, you can get view performance gains by:</p>
<ul>
<li>Installing <code>RazorGenerator.MsBuild</code> on each Visual Studio project that contains Razor views</li>
<li>Registering each of those assemblies with the Sitecore precompiled view engine so that it uses your precompiled classes for view rendering</li>
</ul>
<p>Big thanks to <a target="_blank" rel="noopener" href="https://twitter.com/herskinduk">Kern</a> for setting up the MVC expert panel, without which this feature might well not exist. And we might still have <a href="https://kamsar.net/index.php/2015/02/sitecore-8-experience-editor-performance-optimization/">1:40 startup times</a> after a compile. :)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kamsar.net/index.php/2016/09/Precompiled-Views-with-Sitecore-8-2/" data-id="ckrl9emyd004798q7g5ct7q94" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    
    
    <article id="post-Sitecore-hangs-on-startup-when-using-MongoDB" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/index.php/2016/09/Sitecore-hangs-on-startup-when-using-MongoDB/">Sitecore hangs on startup when using MongoDB</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/index.php/2016/09/Sitecore-hangs-on-startup-when-using-MongoDB/">
    <time datetime="2016-09-02T17:52:25.000Z" itemprop="datePublished">September 2, 2016</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/index.php/category/Sitecore/">Sitecore</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I ran across a tricky issue today where a Sitecore content delivery cluster would simply hang on startup. No errors in the logs. Nothing in the windows event logs. The content editing server worked just fine.</p>
<p>Mystifying, right? So it came down to process of elimination: I disabled analytics and removed all Mongo connection strings and the site worked. The obvious answer here would be “it’s a firewall issue.”</p>
<p>It wasn’t. <code>mongo.exe</code> could connect to the replica set just fine. The connection was using SSL, so I checked the server certificate. It was valid and trusted. </p>
<p>Eventually it came down to a few important facts:</p>
<ul>
<li>We were using SSL.</li>
<li>Because we weren’t using client certificates, <code>mongo.exe</code> had to use <code>--sslAllowInvalidCertificates</code>, which meant that it was not verifying the server certificate.</li>
<li>The Mongo C# driver <em>does</em> validate the server certificate.</li>
</ul>
<p>But you said the server certificate was totally valid, right? Right - and it was valid.</p>
<p>Except for the sneaky fact that <em>the certificate had a Certificate Revocation List (CRL) URL embedded in it</em>. The Mongo C# driver defaults to checking the CRL to make sure the server certificate is not revoked.</p>
<p>Normally that’s a good thing, but in this case <em>the CRL was behind the firewall, and the delivery servers were not</em>. So the CRL could not be checked, and the server certificate was treated as invalid due to that.</p>
<p>Why this results in straight up hanging the site instead of an error I’m not sure. But that leads to how it got fixed.</p>
<h2 id="Extending-the-Mongo-Client-Settings"><a href="#Extending-the-Mongo-Client-Settings" class="headerlink" title="Extending the Mongo Client Settings"></a>Extending the Mongo Client Settings</h2><p>The most obvious fix would be to add something to the connection string to disable the CRL check, as it would be undesirable to expose the PKI server that issued the certificate to the DMZ where the delivery servers live. Unfortunately, there is no option to do that in the Mongo connection string format.</p>
<p>Fortunately, There’s A Micro-Pipeline For That™. Sitecore exposes the <code>updateMongoDriverSettings</code> pipeline, which is empty by default. This pipeline allows you to fool with the <a target="_blank" rel="noopener" href="http://api.mongodb.com/csharp/current/html/T_MongoDB_Driver_MongoClientSettings.htm">MongoClientSettings</a> object and alter configurations that are not available in the connection string.</p>
<p>Here’s an example patch to add a processor to said pipeline:</p>
<pre><code>&lt;configuration xmlns:patch=&quot;http://www.sitecore.net/xmlconfig/&quot;&gt;
    &lt;sitecore&gt;
        &lt;pipelines&gt;
            &lt;updateMongoDriverSettings&gt;
                &lt;processor type=&quot;Me.Pipelines.UpdateMongoDriverSettings.DisableCrlChecks, Me&quot;/&gt;
            &lt;/updateMongoDriverSettings&gt;
        &lt;/pipelines&gt;
    &lt;/sitecore&gt;
&lt;/configuration&gt;
</code></pre>
<p>And the processor implementation that alters the <code>MongoClientSettings</code> to disable CRL checks:</p>
<pre><code>using MongoDB.Driver;
using Sitecore.Analytics.Pipelines.UpdateMongoDriverSettings;

namespace Me.Pipelines.UpdateMongoDriverSettings
&#123;
    public class DisableCrlChecks : UpdateMongoDriverSettingsProcessor
    &#123;
        public override void UpdateSettings(UpdateMongoDriverSettingsArgs args)
        &#123;
            args.MongoSettings.SslSettings = new SslSettings &#123; CheckCertificateRevocation = false &#125;;
        &#125;
    &#125;
&#125;
</code></pre>
<p>This technique could also be used to diagnose other SSL issues that might involve <em>invalid</em> certificates, because you can also <a target="_blank" rel="noopener" href="https://stackoverflow.com/a/34735350/1359221">alter the certificate validity handling</a> to get diagnostic output.</p>
<h2 id="Caveat-Sorry-not-for-you-Mongo-Session-Provider"><a href="#Caveat-Sorry-not-for-you-Mongo-Session-Provider" class="headerlink" title="Caveat: Sorry, not for you Mongo Session Provider"></a>Caveat: Sorry, not for you Mongo Session Provider</h2><img src="/index.php/2016/09/Sitecore-hangs-on-startup-when-using-MongoDB/vader.jpg" class=""> 

<p>Unfortunately if you’re using the MongoDB Session State provider, it does not respect this pipeline. In fact, it makes itself highly extensible, by hiding the place to put your options in a private static method! Called by internal methods! </p>
<pre><code>private static MongoCollection GetCollection(string connectionString, string databaseName, string collectionName)
&#123;
    return (MongoCollection) new MongoClient(new MongoUrl(connectionString)).GetServer().GetDatabase(databaseName).GetCollection(collectionName);
&#125;
</code></pre>
<p>So you’re hosed if you’re using Mongo sessions.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kamsar.net/index.php/2016/09/Sitecore-hangs-on-startup-when-using-MongoDB/" data-id="ckrl9emyd004998q712ij8i3i" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    
    
    <article id="post-Dependency-Injection-in-Sitecore-8-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/index.php/2016/08/Dependency-Injection-in-Sitecore-8-2/">Dependency Injection in Sitecore 8.2</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/index.php/2016/08/Dependency-Injection-in-Sitecore-8-2/">
    <time datetime="2016-09-01T00:30:03.000Z" itemprop="datePublished">August 31, 2016</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/index.php/category/Sitecore/">Sitecore</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Sitecore 8.2, hot off the presses yesterday, includes built in <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Dependency_injection">dependency injection</a>. If you’ve been following the internal architecture of Sitecore for very long, you’ve probably realized that a lot of it is uglier than it needs to be - and less extensible - thanks to the lack of system-wide DI support. It’s kind of a big deal. Even if <a target="_blank" rel="noopener" href="https://twitter.com/cardinal252">Nat Mann</a> hates conforming containers ;)</p>
<p>The Sitecore <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Inversion_of_control">IoC</a> container is based on <a target="_blank" rel="noopener" href="https://docs.asp.net/en/latest/mvc/controllers/dependency-injection.html">Microsoft’s Dependency Injection</a> library that was written for .NET Core. It is not the world’s most flexible or performant container (nor was it designed to be), but it works and is a decent choice. If you wish you can change the underlying IoC library being used, but we aren’t going to cover that today.</p>
<p>Sitecore’s built in DI offers two major advantages over the third party dependency injection that most advanced Sitecore teams have been using for a long time:</p>
<ul>
<li>Sitecore itself is using it (and thus you can extend Sitecore itself by replacing dependencies)</li>
<li>You can natively dependency inject into pipeline processors (which you could <a target="_blank" rel="noopener" href="https://cardinalcore.co.uk/2014/07/02/sitecore-pipelines-commands-using-ioc-containers/">sort of already do</a>)</li>
</ul>
<h2 id="Controller-Injection"><a href="#Controller-Injection" class="headerlink" title="Controller Injection"></a>Controller Injection</h2><p>As with most ASP.NET DI implementations, most dependency resolution will take place in <em>controllers</em>. If you’ve already been using constructor injection with Sitecore, you may have to change absolutely nothing:</p>
<pre><code>public class FooController : Controller
&#123;
    private readonly IDependency _dependency;

    public Foo(IDependency dependency) 
    &#123;
        _dependency = dependency;
    &#125;

    public ActionResult Index() 
    &#123;
        return View(_dependency.DoStuff());
    &#125;
&#125;
</code></pre>
<p>Be aware that the built in IoC container has two major limitations when injecting controllers:</p>
<ul>
<li>You may only have <em>one</em> public constructor for your controller - or any other registered dependency. This is a good thing, as multiple public constructors are a <a target="_blank" rel="noopener" href="https://cuttingedge.it/blogs/steven/pivot/entry.php?id=97">DI antipattern</a> anyway.</li>
<li>The controller class must be registered with the container to be resolvable (e.g. you must register it such as <code>container.AddTransient&lt;FooController&gt;()</code>).</li>
</ul>
<p>The latter limitation we can do something nice about: read on and we’ll get to that when we talk about registering dependencies :)</p>
<h2 id="Pipeline-Injection"><a href="#Pipeline-Injection" class="headerlink" title="Pipeline Injection"></a>Pipeline Injection</h2><p>You may also inject dependencies into pipeline processors using the same constructor injection pattern as controllers. Processors are <em>not injected by default</em>, presumably for performance. As with controllers, processors may only have one public constructor. I suspect, but have not tried, that this trick would also work with commands.</p>
<p>To inject a processor, simply add <code>resolve=&quot;true&quot;</code> to its registration. For example:</p>
<pre><code>&lt;processor type=&quot;Foo.BarProcessor, Foo&quot; resolve=&quot;true&quot; /&gt;
</code></pre>
<h2 id="Web-Forms-Dependency-Injection"><a href="#Web-Forms-Dependency-Injection" class="headerlink" title="Web Forms Dependency Injection"></a>Web Forms Dependency Injection</h2><img src="/index.php/2016/08/Dependency-Injection-in-Sitecore-8-2/grumpy-cat-no.jpg" class="">

<p>(You can actually do Web Forms DI with Sitecore but I’m not going to tell you how. Quit using Web Forms.)</p>
<h2 id="Service-Locator"><a href="#Service-Locator" class="headerlink" title="Service Locator"></a>Service Locator</h2><p>You can also resolve dependencies from the Sitecore container using the <a target="_blank" rel="noopener" href="http://blog.ploeh.dk/2010/02/03/ServiceLocatorisanAnti-Pattern/">Service Locator <em>antipattern</em></a>. This is where you explicitly ask the container to give you an instance of an object. It’s an antipattern, and you should use it as a weapon of last resort, because it tightly couples your class to the IoC container and makes things difficult to test.</p>
<p>There are actually multiple ways you can use Service Locator:</p>
<pre><code>// the MVC DependencyResolver can be used
DependencyResolver.Current.GetService&lt;IService&gt;();

// the Sitecore ServiceLocator can be used
using Sitecore.DependencyInjection;
ServiceLocator.ServiceProvider.GetService&lt;IServiceCollection&gt;();
</code></pre>
<p>Again don’t use these…unless you have no other choice.</p>
<h1 id="Registering-Dependencies"><a href="#Registering-Dependencies" class="headerlink" title="Registering Dependencies"></a>Registering Dependencies</h1><p>Of course an IoC container is useless if it has no registered dependencies to resolve! Sitecore’s container can be configured in multiple ways, all of which involve some level of XML. I heard you groan when you read that ;)</p>
<p>Keep in mind when wiring dependencies that the IoC container is <em>not multitenant</em>. Your dependencies are sharing the container with Sitecore’s - and if you have more than one site, potentially other sites as well. So don’t go expecting to have <code>IFoo</code> resolve to different implementations in different sites!</p>
<p>If you get confused and want to see a list of every dependency that is currently registered, along with its scope and type, there’s a page for that! Just visit <code>/sitecore/admin/showservicesconfig.aspx</code> and there you are. While you’re at it, check out the <a target="_blank" rel="noopener" href="https://jammykam.wordpress.com/2016/08/23/sitecore-admin-pages-cheat-sheet-new-tools/">other handy tools in the admin pages too</a>.</p>
<h2 id="Configurators"><a href="#Configurators" class="headerlink" title="Configurators"></a>Configurators</h2><p>A configurator is probably what you think of when you consider IoC configuration if you’ve been using any modern container library. It’s a C# class that conforms to an interface where you are given a container object, and expected to wire your dependencies to it. You can register as many configurators as you like in the <code>&lt;services&gt;</code> section.</p>
<pre><code>&lt;configuration xmlns:patch=&quot;http://www.sitecore.net/xmlconfig/&quot;&gt;
    &lt;sitecore&gt;
        &lt;services&gt;
            &lt;configurator type=&quot;MyProject.MyConfiguratorClass, MyProject&quot; /&gt;
        &lt;/services&gt;
    &lt;/sitecore&gt;
&lt;/configuration&gt;
</code></pre>
<p>Here’s an example configurator implementation that registers a couple dependencies. As with most containers <code>Transient</code> and <code>Singleton</code> dependencies are available, and I believe <code>Scoped</code> as well, but I’m not sure what the exact behaviour of that is in this case.</p>
<pre><code>using Microsoft.Extensions.DependencyInjection;
using Sitecore.DependencyInjection;

namespace MyProject
&#123;
    public class MyConfiguratorClass : IServicesConfigurator
    &#123;
        public void Configure(IServiceCollection serviceCollection)
        &#123;
            serviceCollection.AddSingleton&lt;IDependency, Dependency&gt;();
            serviceCollection.AddSingleton&lt;IService&gt;(provider =&gt; new Service(&quot;withFactory&quot;));
        &#125;
    &#125;
&#125;
</code></pre>
<p><strong>Note</strong>: You cannot use Sitecore Factory conventions when registering configurators, for example setting properties on the configurator with child elements. This is because the Factory also speaks DI now as a fallback, so it’d be like asking the container to resolve itself :)</p>
<h2 id="Direct-Registration"><a href="#Direct-Registration" class="headerlink" title="Direct Registration"></a>Direct Registration</h2><p>You can also register individual dependencies with XML, just like we did ten years ago! I wouldn’t suggest doing this as it is less expressive than a configurator, not type-checked by compilation, and probably marginally slower as well due to having to convert the string to the type for every dependency.</p>
<pre><code>&lt;configuration xmlns:patch=&quot;http://www.sitecore.net/xmlconfig/&quot;&gt;
    &lt;sitecore&gt;
        &lt;services&gt;
            &lt;register 
                serviceType=&quot;Type.IName, Assembly&quot; 
                implementationType=&quot;Type.Name, Assembly&quot; 
                lifetime=&quot;Transient&quot; /&gt;
        &lt;/services&gt;
    &lt;/sitecore&gt;
&lt;/configuration&gt;
</code></pre>
<h1 id="Automatic-Controller-Registration"><a href="#Automatic-Controller-Registration" class="headerlink" title="Automatic Controller Registration"></a>Automatic Controller Registration</h1><p>If you’re actually reading this, you may have noticed that I mentioned earlier that you must register every MVC controller you wish to dependency inject with the IoC container. Sounds like a drag, right? Not so fast! Pull out your robe and wizard hat, grab this handy code, and register all your controllers automatically within a configurator:</p>
<pre><code>public void Configure(IServiceCollection serviceCollection)
&#123;
    // configurator per project? Use this:
    serviceCollection.AddMvcControllersInCurrentAssembly();

    // configure all the things from on high by convention? Use this (Habitat as the example):
    serviceCollection.AddMvcControllers(
        &quot;Sitecore.Feature.*&quot;, 
        &quot;Sitecore.*.Website&quot;);

    // you can also pass Assembly instances directly, but why?
    serviceCollection.AddMvcControllers(
        Assembly.FromName(&quot;Foo&quot;), 
        Assembly.FromName(&quot;Bar&quot;));
&#125;
</code></pre>
<p>And without further ado, here’s the code that makes that possible.</p>
<script src="//gist.github.com/460528edc3043b16bdccfdbd0ea0c552.js"></script>

<p>Have a nice day!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kamsar.net/index.php/2016/08/Dependency-Injection-in-Sitecore-8-2/" data-id="ckrl9emyc004598q7109igf24" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    
    
    <article id="post-Configuring-domains-from-patch-files" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/index.php/2016/08/Configuring-domains-from-patch-files/">Configuring domains from patch files</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/index.php/2016/08/Configuring-domains-from-patch-files/">
    <time datetime="2016-08-05T19:22:53.000Z" itemprop="datePublished">August 5, 2016</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/index.php/category/Sitecore/">Sitecore</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Sitecore domains are logical security groupings, for example the product ships with “sitecore” (backend users) and “extranet” (frontend users). But you do not have to stick with only the domains the product ships with, as usual for Sitecore you can extend and add your own.</p>
<p>Normally adding a domain means editing <code>App_Config\Security\Domains.config</code>, but we don’t want to do this. Why? Because editing standard Sitecore config files makes it difficult to upgrade Sitecore and introduces error prone file merging. </p>
<p>What we want to do instead is use <a target="_blank" rel="noopener" href="http://sitecore-community.github.io/docs/documentation/Sitecore%20Fundamentals/Patch%20Files/"><em>config patch</em> files</a>. These allow us to add our config completely separately from Sitecore’s standard configuration files. But there’s a problem when it comes to domains: <code>Domains.config</code> does not live in the requisite <code>&lt;sitecore&gt;</code> config section so we cannot patch it.</p>
<p>Fortunately there’s a little known way around this. Someone at Sitecore implemented a config-based domain manager, but it’s not the default - presumably for backwards compatibility. And you <em>can</em> activate that, and add domains to it, using patch files.</p>
<p>So next time you want to add a domain to Sitecore, like say adding a domain for each site to provide logical author role groupings, switch over to the config domain manager. You know you want <code>MySite\Editor</code> instead of <code>sitecore\MySite Editor</code>. It’s easy to do, too.</p>
<p>This patch will activate the config domain manager (the defaults for the config manager already are the same as <code>Domains.config</code> so nothing else needs to be registered):</p>
<pre><code>&lt;configuration xmlns:patch=&quot;http://www.sitecore.net/xmlconfig/&quot;&gt;
    &lt;sitecore&gt;
        &lt;domainManager defaultProvider=&quot;file&quot;&gt;
            &lt;patch:attribute name=&quot;defaultProvider&quot;&gt;config&lt;/patch:attribute&gt;
        &lt;/domainManager&gt;
    &lt;/sitecore&gt;
&lt;/configuration&gt;
</code></pre>
<p>And this patch is an example of adding a domain to the config domain manager:</p>
<pre><code>&lt;configuration xmlns:patch=&quot;http://www.sitecore.net/xmlconfig/&quot;&gt;
    &lt;sitecore&gt;
        &lt;domainManager&gt;
            &lt;domains&gt;
                &lt;domain id=&quot;MyNewDomain&quot; type=&quot;Sitecore.Security.Domains.Domain, Sitecore.Kernel&quot;&gt;
                    &lt;param desc=&quot;name&quot;&gt;$(id)&lt;/param&gt;
                    &lt;ensureAnonymousUser&gt;false&lt;/ensureAnonymousUser&gt;
                &lt;/domain&gt;
            &lt;/domains&gt;
        &lt;/domainManager&gt;
    &lt;/sitecore&gt;
&lt;/configuration&gt;
</code></pre>
<p>And there you have it. Enjoy!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kamsar.net/index.php/2016/08/Configuring-domains-from-patch-files/" data-id="ckrl9emyc004398q715q6cbaq" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    
    
    <article id="post-The-Solr-Cannon" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/index.php/2016/03/The-Solr-Cannon/">The Solr Cannon: Rapid Solr Setup for Sitecore</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/index.php/2016/03/The-Solr-Cannon/">
    <time datetime="2016-03-15T21:43:43.000Z" itemprop="datePublished">March 15, 2016</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/index.php/category/Sitecore/">Sitecore</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Have you ever wished that standing up a Solr server for Sitecore was easy? I have. So I made a script to make it so.</p>
<p>The Solr Cannon automates the setup and configuration of Solr on Windows (Note: Linux may be a better production choice if you have the option), including installation as a background service, Sitecore schema installation, core creation, and generating a Sitecore config patch file that will point Sitecore at your shiny new Solr server and its cores.</p>
<h2 id="What-you’ll-need"><a href="#What-you’ll-need" class="headerlink" title="What you’ll need"></a>What you’ll need</h2><ul>
<li>A copy of the <a target="_blank" rel="noopener" href="https://bitnami.com/stack/solr">Bitnami Solr Stack</a> for Windows (I used 5.5.0-1)</li>
<li>A copy of <a target="_blank" rel="noopener" href="https://gist.github.com/kamsar/ef8811bd458603f1e808#file-install-solr-ps1">the script</a> and the <a target="_blank" rel="noopener" href="https://gist.github.com/kamsar/ef8811bd458603f1e808#file-schema-xml">solr schema file</a> (the schema was generated with Sitecore 8.1 Update 1, you might need to generate your own if it doesn’t work)</li>
<li>PowerShell 3.0 or later</li>
</ul>
<h2 id="Let’s-do-this"><a href="#Let’s-do-this" class="headerlink" title="Let’s do this"></a>Let’s do this</h2><ul>
<li>Copy the Solr stack and scripts to a folder on the server that will run Solr</li>
<li>Review the <code>Install Solr.ps1</code> script to make sure the variables are to your liking (<em>project name</em>, ports, solr stack installer path, etc)</li>
<li>Open an administrative PowerShell prompt</li>
<li>Execute <code>Install Solr.ps1</code></li>
<li>Kick back for a couple minutes</li>
<li>Bask in the glow of your new Solr server and all of its Sitecore cores</li>
</ul>
<h2 id="But-what-about-the-rest"><a href="#But-what-about-the-rest" class="headerlink" title="But what about the rest?"></a>But what about the rest?</h2><p>Ok ok, that’s not all you need to do in order to configure Solr and Sitecore. </p>
<ul>
<li>Check out <a target="_blank" rel="noopener" href="http://sitecoreblog.patrickperrone.com/2015/02/sitecore-8-solr-part33-configur-ageddon.html">Patrick Perrone’s post</a> to help you <a target="_blank" rel="noopener" href="http://sitecoreblog.patrickperrone.com/2015/03/a-script-to-swap-search-in-sitecore.html">swap in Solr</a> as the search provider and configure the Solr IoC container. Note: I’d recommend Windsor for the IoC. Autofac and Ninject were less than awesome install experiences…</li>
<li>Once you have the Sitecore configuration flipped to Solr, you can grab the <code>Solr.config</code> file that the Solr Cannon produced when it installed Solr (written to the script directory). This config patch will:<ul>
<li>Point Sitecore at your Solr server</li>
<li>Make Sitecore look at the correct core names for each index</li>
<li>Enable <code>SwitchOnRebuildSolrIndex</code> which allows you to rebuild indexes without any index downtime (great for production…or dev)</li>
</ul>
</li>
<li>Load up Sitecore, open the indexing manager, and rebuild all your indexes. With a bit of luck, you’ll be good to go!</li>
</ul>
<h2 id="Multi-tenant-Solr"><a href="#Multi-tenant-Solr" class="headerlink" title="Multi-tenant Solr"></a>Multi-tenant Solr</h2><p>Suppose you’re working on your own machine and you’ve got more than one dev site that’s using Solr. The Solr Cannon scripts can act to create a new config set and cores for several Sitecore installations on the same Solr server. Edit the script to have a different <code>$ProjectName</code> set, run it again, and say no when asked if you need to install a Solr server. In this mode, the script will build out a config set and cores for a new Sitecore site, as well as the patch file.</p>
<p>Have fun :)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kamsar.net/index.php/2016/03/The-Solr-Cannon/" data-id="ckrl9emyb003x98q74pbb1jmn" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    
    
    <article id="post-Branch-Datasource-Presets" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/index.php/2016/03/Branch-Datasource-Presets/">Branch Datasource Presets</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/index.php/2016/03/Branch-Datasource-Presets/">
    <time datetime="2016-03-15T21:39:23.000Z" itemprop="datePublished">March 15, 2016</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/index.php/category/Sitecore/">Sitecore</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Ever stored rendering component data source items under a page? For example:</p>
<pre><code>/sitecore/content/Page
/sitecore/content/Page/Datasources/ComponentDataSourceItem
</code></pre>
<p>It’s a good practice and it seems to work quite well for page specific components. I use it all the time.</p>
<p>But have you ever wished branch templates understood that pattern in a logical fashion? What if this:</p>
<pre><code>/sitecore/templates/branches/Foo/$name
/sitecore/templates/branches/Foo/$name/Datasources/ComponentDataSourceItem
</code></pre>
<p>…expanded out to have the branch create the hierarchy <strong>and</strong> re-link the layout details on the instiantiated branch item to point to the right relative child data source item, instead of the child item under the branch template?</p>
<p>Doing this lets you use branch templates to create preset rendering hierarchies, <strong>including</strong> page specific data source items.</p>
<p>Sound good? Well you’ve found the right place to <a target="_blank" rel="noopener" href="https://github.com/kamsar/BranchPresets">get the code to do just that</a>. This requires Sitecore 8 or above with the pipeline-based item provider to operate.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kamsar.net/index.php/2016/03/Branch-Datasource-Presets/" data-id="ckrl9emya003v98q7hfqbdpk0" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    
    
    <article id="post-Benchmark-Show-Precompilation" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/index.php/2016/01/Benchmark-Show-Precompilation/">The Benchmark Show: Sitecore Precompilation</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/index.php/2016/01/Benchmark-Show-Precompilation/">
    <time datetime="2016-01-05T04:20:35.000Z" itemprop="datePublished">January 4, 2016</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/index.php/category/Sitecore/">Sitecore</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I’m <a href="https://kamsar.net/index.php/2015/02/sitecore-8-experience-editor-performance-optimization/">mildly obsessed with Sitecore performance</a>, so when I found a new trick I had to see what it could do: <a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/ms229863.aspx"><code>aspnet_compiler.exe</code></a>. This is a really old tool that was designed to compile your .aspx pages into an assembly - and then later your cshtml as well. This improves startup time because no dynamic compilation needs to take place at runtime.</p>
<p>Getting <code>aspnet_compiler</code> to run against Sitecore, by which I mean executing it against an entire deployment ready web root including both your code and the <code>sitecore</code> folder, is a bit of a challenge. Because you cannot tell <code>aspnet_compiler</code> to ignore anything, and because one of the cshtml files in Sitecore 8.1 Update-1 apparently has a compiler error (for the curious, add <code>@using Sitecore.ListManagement.Client.Web.UI.Controls.ImportMapTo</code> to /sitecore/shell/client/Applications/ListManager/Controls/ContactFields/ContactFields.cshtml). You also have to comment out the <code>@Html.Sitecore()</code>s in /sitecore/shell/Templates/layout.cshtml (don’t worry it’s just a template used when you add a new MVC layout).</p>
<p>Once you get the fixes made, running <code>aspnet_compiler</code> is as simple as:</p>
<p><code>&quot;c:\Windows\Microsoft.NET\Framework\v4.0.30319\aspnet_compiler.exe&quot; -v / -p &quot;c:\path\to\deploy\ready\files&quot; &quot;c:\output\path&quot;</code></p>
<p>It will take a while - probably at least a minute - while it compiles every aspx and cshtml in the whole place into assemblies.</p>
<h2 id="Cool-trick-Does-it-work"><a href="#Cool-trick-Does-it-work" class="headerlink" title="Cool trick. Does it work?"></a>Cool trick. Does it work?</h2><p>Let’s look at some hard data. I took my base Sitecore site (which runs <a target="_blank" rel="noopener" href="https://gist.github.com/kamsar/8c9efc80e72e6ada8304">Performance.config</a>) and executed my deployment scripts over it, then precompiled that to a new folder with <code>aspnet_compiler</code>. Then I devised several tests to tease out both the effects of precompilation and whether Sitecore’s built in SPEAK precompilation has improved since its 8.0 days - where it could make startup take 140 seconds. The tests were in most cases run both with a cold <em>ASP.NET Temporary Files</em> folder (where .NET puts compiled Razor caches) and with a warm one for comparison. Cold would be the first startup on a new machine, whereas warm would be after an app pool recycle thereafter.</p>
<h3 id="Test-1-Home-Page"><a href="#Test-1-Home-Page" class="headerlink" title="Test 1: Home Page"></a>Test 1: Home Page</h3><p>This is a simple test of loading the home page, which is a fairly simple Sitecore MVC layout with about 4 view and controller renderings and several partials. All tests begin with the app pool stopped and no <code>w3wp</code> executing.</p>
<h3 id="Test-2-SPEAK-Media-Library-Dialog"><a href="#Test-2-SPEAK-Media-Library-Dialog" class="headerlink" title="Test 2: SPEAK Media Library Dialog"></a>Test 2: SPEAK Media Library Dialog</h3><p>The SPEAK media browser (what you get when browsing from an image field, for example) has been historically a pain point performance wise. For this test I loaded the dialog iframe URL into a Chrome tab and measured the time to finish page load with the Chrome developer tools.</p>
<h2 id="Results"><a href="#Results" class="headerlink" title="Results"></a>Results</h2><h3 id="Home-Page-cold"><a href="#Home-Page-cold" class="headerlink" title="Home Page (cold)"></a>Home Page (cold)</h3><p>Baseline (Performance.config): 22.25s<br>SC Precompiler: 24.8s<br>Precompiled: 21.5s</p>
<p>As expected the precompiled is marginally fastest. Sitecore 8.1’s precompilation function, as we’ll see throughout the tests, seems to add 2-4 seconds to startup time. Without preexisting compiled temp files, startup is extremely slow in all cases - unexpectedly so for the supposedly ‘precompiled’ site. My guess is that it copies the precompiled files to the temp folder, which expends I/O, but that’s a guess.</p>
<h3 id="Home-Page-warm"><a href="#Home-Page-warm" class="headerlink" title="Home Page (warm)"></a>Home Page (warm)</h3><p>Baseline: 9.71s<br>SC Precompiler: 13.97s<br>Precompiled: 9.51s</p>
<p>With the temporary files warm, startup gets much faster. Once again the Sitecore precompiler is in last place.</p>
<h3 id="SPEAK-Media-cold"><a href="#SPEAK-Media-cold" class="headerlink" title="SPEAK Media (cold)"></a>SPEAK Media (cold)</h3><p>Baseline: 29.6s<br>SC Precompiler: 33.8s<br>Precompiled: 22.93s</p>
<p>The effects of precompilation are strong when loading the very complex, partial-heavy SPEAK dialog - coming in 47% faster than the Sitecore default.</p>
<h3 id="SPEAK-Media-warm"><a href="#SPEAK-Media-warm" class="headerlink" title="SPEAK Media (warm)"></a>SPEAK Media (warm)</h3><p>Baseline: 12.2s<br>SC Precompiler: 16s<br>Precompiled: 12.82s<br>SC Precompiler (warmed): 13.23s</p>
<p>Performance is nearly identical once the temporary compiled files are cached the first time for SPEAK. In this case there is also a test for having warmed the Sitecore precompiler and allowed it to finish precompiling in the background, then restarted the cold app pool. </p>
<h2 id="Analysis-TL-DR"><a href="#Analysis-TL-DR" class="headerlink" title="Analysis (TL;DR)"></a>Analysis (TL;DR)</h2><p>Overall the effects of using <code>aspnet_compiler</code> prior to deployment are relatively minor in most real world cases. Initial startup is ideally a rare case, and once their caches are heated all options perform quite similarly (as an example, the second hit to the media dialog is ~250ms to finish). For more elastic deployments, such as cloud setups, or for larger clusters it is probably worth the effort since you burn the CPU cycles once and it does significantly improve first hit to SPEAK dialogs as well as marginal overall performance improvements. Rendering heavy Sitecore MVC implementations would also likely see similar gains to SPEAK. In addition to performance, using the <code>aspnet_compiler</code> validates the C# in your Razor views - which is a nice plus in the event of a Razor syntax error which would normally be discovered at runtime.</p>
<p>The big downside of precompiling is that it’s fairly slow (several minutes on fast hardware, probably much slower otherwise or without SSDs), and that it has to re-copy the whole web root to another output location (lots of I/O). So overall build time on CI may increase significantly.</p>
<h3 id="Another-option-Use-the-Sitecore-precompiler"><a href="#Another-option-Use-the-Sitecore-precompiler" class="headerlink" title="Another option: Use the Sitecore precompiler"></a>Another option: Use the Sitecore precompiler</h3><p>If you look at the results, <em>startup time</em> with the Sitecore precompiler is always a bit longer. But once the Sitecore precompiler completes its asynchronous run - usually within a couple minutes after startup - the results are very close to a natively precompiled site (see the warm media dialog results). This is overall a much simpler option. It does mean every instance has to compile for itself, but it does not require adaptation of the build process nor long times spent copying files.</p>
<p>And here’s the best part: <em>you can use it for your own views, too</em>. It’s just a Razor precompiler pipeline processor, and you can add one - or more - for your sites’ MVC views. For example:</p>
<pre><code>&lt;processor type=&quot;Sitecore.Pipelines.Initialize.PrecompileSpeakViews, Sitecore.Speak.Client&quot;&gt;
    &lt;Paths&gt;/Areas/MySite/Views&lt;/Paths&gt; &lt;!-- virtual path to your views --&gt;
&lt;/processor&gt;
</code></pre>
<p>This will cause your views to all get precompiled asynchronously on startup - if they are not already - which writes their assemblies into the <em>Temporary ASP.NET Files</em> folder. So you trade a couple seconds of startup time, and an initial spike of CPU cycles, for consistent performance thereafter. However, you lose the protection against syntax errors provided by build-time precompilation.</p>
<p>Next time on the benchmark show: Common Sitecore development tasks, benchmarked on a variety of hardware.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kamsar.net/index.php/2016/01/Benchmark-Show-Precompilation/" data-id="ckrl9emy8003n98q78eu654g6" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    
    
      
        <div class="archive-year-wrap">
          <i class="fa fa-calendar"></i>
          <a href="/archives/2015" class="archive-year">2015</a>
        </div>
    
    <article id="post-Sitecore-Azure-Role-Sizing-Guide" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/index.php/2015/07/Sitecore-Azure-Role-Sizing-Guide/">Sitecore Azure Role Sizing Guide</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/index.php/2015/07/Sitecore-Azure-Role-Sizing-Guide/">
    <time datetime="2015-07-03T02:44:20.000Z" itemprop="datePublished">July 2, 2015</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/index.php/category/Sitecore/">Sitecore</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>It seems like everyone is hot to get Sitecore on <a target="_blank" rel="noopener" href="http://azure.microsoft.com/">Azure</a> these days, but there’s not a whole lot of guidance out there on how Sitecore scales effectively in an Azure environment. Since I get asked the “what size instances do we need?” or “how much will Azure cost us?” question a lot, I figured some testing was in order.</p>
<p>The environment I tested in is a real actual customer website on Sitecore 7.2 Update-4 (not yet launched but in late beta). The site has been relatively optimized with normal practices - namely, appropriate application of output caching and in-memory object caching. The site scores a B on <a target="_blank" rel="noopener" href="http://www.webpagetest.org/">WebPageTest</a> - due to things out of my control - and is in decent shape. We are deploying to Azure Cloud Services (<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Platform_as_a_service">PaaS</a>), using custom PowerShell scripting - <em>not</em> the Sitecore Azure module (we have had suboptimal experiences with the module). We’re using SQL Azure as the database backend, and the Azure Cache session provider. Note that the Azure Cache session is not supported for xDB (7.5/8) scenarios.</p>
<h2 id="The-Tests"><a href="#The-Tests" class="headerlink" title="The Tests"></a>The Tests</h2><p>I wanted to determine the effects of changing various cloud scaling options relative to real world performance, but I also didn’t want to spend days benchmarking. So I settled on two test scenarios:</p>
<ul>
<li>Frontend performance. This is a JMeter test that hits the site with 10,000 requests to the home page, with 1,000 threads at once. The idea is to beat the server into submission and see how it does.</li>
<li>Backend performance. I chose Lucene search index rebuilding, as that is a taxing process on both the database and server CPUs, and it conveniently reports how long it took to run. Note that you should probably be using Solr for any xDB scenarios or any search-heavy sites.</li>
</ul>
<p>These are not supposed to be ‘end of story’ benchmarks. There are no doubt many bones to pick with them, and they’re certainly not comprehensive. But they do paint a decent picture of overall scaling potential.</p>
<h2 id="Testing-Environment"><a href="#Testing-Environment" class="headerlink" title="Testing Environment"></a>Testing Environment</h2><p>The base testing environment consists of an Azure Cloud Service running two A3 (4-core, 7.5GB RAM, HDDs) web roles. The databases (core, master, web, analytics) are SQL Azure S3 instances running on a SQL Azure v12 (latest) server.</p>
<p>Several role variants were tested:</p>
<ul>
<li>2x A3 roles, which are 4-cores with 7GB RAM and HDD local storage (~$268/mo each)</li>
<li>2x D2 roles, which are 2-cores (D-series cores are ‘60% faster’ per Microsoft) 7GB RAM and SSD local storage (~$254/mo each)</li>
<li>2x D3 roles, 4-cores 14GB RAM and SSD local storage (~$509/mo each)</li>
<li>2x D4 roles, 8-cores 28GB RAM and SSD local storage (~$1018/mo each)</li>
</ul>
<p>In addition, I tested the effect of changing the SQL Azure sizes on the backend with the D4 roles. I did not test the frontend in these cases, because that seemed to scale well on the S3s already.</p>
<ul>
<li>S3 databases, which are 100DTU “standard” (~$150/mo each)</li>
<li>P1 databases, which are 125DTU “premium” (~$465/mo each)</li>
<li>P2 databases, which are 250DTU “premium” (~$930/mo each)</li>
</ul>
<h2 id="Results"><a href="#Results" class="headerlink" title="Results"></a>Results</h2><p>Our first set of tests are comparing the size of the web roles in Azure. It is quite likely that these results would also be loosely applicable to IaaS virtual machine deployments as well.</p>
<h3 id="Throughput"><a href="#Throughput" class="headerlink" title="Throughput"></a>Throughput</h3><img src="/index.php/2015/07/Sitecore-Azure-Role-Sizing-Guide/rps.png" class="" title="Throughput Graph">

<p>The throughput graph is about as expected: add more cores, get more scaling. The one surprise is that the D2 instance, with 4 total cores at a higher clock and SSD disk, is able to match the A3 with 8 total cores (D2 and A3 cost a similar amount). </p>
<p>Keep in mind that all of these were using the same SQL Azure S3 databases as the backend - for general frontend service, especially with output caching, Sitecore is extremely database-efficient and does not bottleneck on lower grade databases even with 16 cores serving. </p>
<p>Note that I strongly suspect the bandwidth between myself and Azure was the bottleneck on the D4 results, as I saw it burst up to more like 500 during the main portion of the test.</p>
<h3 id="Latency"><a href="#Latency" class="headerlink" title="Latency"></a>Latency</h3><img src="/index.php/2015/07/Sitecore-Azure-Role-Sizing-Guide/latency.png" class="" title="Latency Graph">

<p>Latency continues the interesting battle between A3 and D2. The A3 pulls out a minor - within margin of error - victory on average but the SSD of the D2 gives it a convincing performance consistency win with the 95% line over 1 second faster. Given that A3 and D2 cost a similar amount, it seems D2 would be a good choice for budget conscious hosting - but if you can afford Sitecore, you should probably stretch your licenses to more cores per instance.</p>
<p>The D3 is probably the ideal general purpose choice for your web roles. </p>
<p>The latency numbers on the monstrous 8-core D4 instances tell the tale that my 1,000 threads and puny 100Mb/s bandwidth were just making the servers laugh.</p>
<p>These graphs illustrate the latency consistency you gain from a D-series role with SSD:</p>
<img src="/index.php/2015/07/Sitecore-Azure-Role-Sizing-Guide/a3graph.png" class="" title="A3 Latency Graph">
<img src="/index.php/2015/07/Sitecore-Azure-Role-Sizing-Guide/d3graph.png" class="" title="D3 Latency Graph">

<p>These two graphs plot the latency over time during the JMeter test. You can see how the top one (A3) is much less consistent thanks to its HDDs, whereas the lower one (D3) is smoother, indicating fewer latency spikes. The latency decreases in the final stage of the test due to some JMeter threads having completed their 10-request run earlier than others, so less server load is in play.</p>
<h3 id="Bandwidth"><a href="#Bandwidth" class="headerlink" title="Bandwidth"></a>Bandwidth</h3><img src="/index.php/2015/07/Sitecore-Azure-Role-Sizing-Guide/bandwidth.png" class="" title="Bandwidth Graph">

<p>Bandwidth is another measure of how much data is being pushed out. Once again, the lesser gain than you might expect from D4 was due to my downstream connection becoming saturated as the monstrous servers <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=CTjolEUj00g">laughed</a>.</p>
<h3 id="Backend-Rebuild-all-indexes"><a href="#Backend-Rebuild-all-indexes" class="headerlink" title="Backend: Rebuild all indexes"></a>Backend: Rebuild all indexes</h3><p>For this test, I rebuilt the default sitecore_core_index, sitecore_master_index, and sitecore_web_index indices.</p>
<img src="/index.php/2015/07/Sitecore-Azure-Role-Sizing-Guide/backend.png" class="" title="Backend Graph">

<p>Here we see the limitations of the S3 databases creep in during our D4 testing. Up to D3 seems to be limited by CPU speed, but the D4 is actually slower until we both up the max index rebuild parallelism <em>and</em> go to P2 databases to feed the monstrous 8-core beast. </p>
<p>Note that with SQL Azure, the charge is per-db - so if you wanted to kit out core, master, and web on P2s you’d be paying near $3,000/month just for the DBs. At that point it might be worth considering using IaaS SQL or looking at the <a target="_blank" rel="noopener" href="https://azure.microsoft.com/en-us/documentation/articles/sql-database-elastic-pool/">Elastic Database Pools</a> to spread around the bursty load of many databases.</p>
<h2 id="Final-Words"><a href="#Final-Words" class="headerlink" title="Final Words"></a>Final Words</h2><p>Overall Sitecore is a very CPU-intensive application where you can generally get away with saving a few bucks on the databases in favor of more compute, especially in content delivery. As in most applications, SSDs make a significant performance improvement to the point where I would suggest Azure D3 instances for nearly all normal Sitecore in Azure deployments, unless you need <a target="_blank" rel="noopener" href="http://www.realultimatepower.net/">Real Ultimate Power</a> from a D4 - or for the truly ridiculous a 16-core D14 ;)</p>
<p>For general frontend scaling the SQL Azure S3 seems to be the best price/performance until you go past quad cores, or past two web roles (one would assume 4x D3 would be relatively similar to 2x D4). Once you have 16 cores serving the frontend, you’ll be bottlenecked below P2 databases at least for index rebuilding. Publishing probably has similar characteristics.</p>
<p>As always when designing for scale, the first step should be to optimize your code and caching. For example, before I did any caching optimizations I did the same JMeter test on the site. The A3s only put out 40 requests/sec - after output caching and tweaks, they did 144 requests/sec. That’s not to say the site was slow pre-optimization: <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Time_To_First_Byte">TTFB</a> was about 220ms without load. But once you add load, even small optimizations make a huge difference.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kamsar.net/index.php/2015/07/Sitecore-Azure-Role-Sizing-Guide/" data-id="ckrl9emy3003598q75i14d2eg" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    
    
    <article id="post-Enabling-Async-in-Sitecore-Controller-Renderings" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/index.php/2015/05/Enabling-Async-in-Sitecore-Controller-Renderings/">Enabling Async in Sitecore Controller Renderings</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/index.php/2015/05/Enabling-Async-in-Sitecore-Controller-Renderings/">
    <time datetime="2015-05-20T04:26:05.000Z" itemprop="datePublished">May 19, 2015</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/index.php/category/Sitecore/">Sitecore</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="IMPORTANT-NOTE"><a href="#IMPORTANT-NOTE" class="headerlink" title="IMPORTANT NOTE:"></a>IMPORTANT NOTE:</h3><p>The information in this post unfortunately does NOT work for controller renderings as I had originally thought. It does, however enable you to use async actions outside of Sitecore contexts (e.g. in directly invoked controllers via non-Sitecore routes or Html.RenderAction() on a Sitecore rendering)</p>
<p>For the past few years, the rest of the .NET world outside Sitecore has been adopting the new <code>async/await</code> programming model that was introduced in .NET 4.5. This model essentially allows you to free up your worker thread while you’re waiting for something else to happen to continue exection. WTF does that mean?</p>
<p>Ok, so imagine you have a very simple web server that has 20 execution threads. This more or less means you can process 20 HTTP requests at the same time before you have to start queuing incoming requests - which kills performance.</p>
<p>Now suppose you’re making an expensive database call that takes 5 seconds on each request, and you get 40 requests at once. Without <code>async</code>, you have no choice but to send 20 requests into the queue. But with <code>async</code>, you can <code>await</code> the expensive database call - which frees up your execution thread(s) for someone else to use for actual processing while you wait for the database. So with an async database call and your 40 requests, you’d start processing 20 requests and rapidly start awaiting the database. This would enable the web server to start processing the other 20 queued requests instead of taking up execution threads that are doing nothing but wait! Then imagine if the latter 20 requests needed CPU time instead of database time - the web server CPUs would remain much more loaded over time and get more work done using the same resources.</p>
<p>Sounds good, right? But one of the down-sides of async is that you really need async calls from top to bottom to avoid deadlocks in ASP.NET. In other words, you could write your SQL API or REST client using async APIs all day - but unless the controller you invoke the APIs from is ALSO async, you’ll either get a deadlock or very little performance improvement. Unfortunately, Sitecore (as of 8.0 Update-2 anyway) does not support async controller actions. I didn’t like this, so I set out to fix that.</p>
<p>Ironically, the problem was very simple and rather hilarious. Sitecore MVC uses its own <code>ControllerFactory</code> which essentially wraps the default <code>IControllerFactory</code> from ASP.NET MVC and decorates it with some Sitecore-specific stuff. One of the things it does is look for the <code>IActionInvoker</code> on each controller, and if one exists wraps that implementation similarly with <code>SitecoreActionInvoker</code> to alter the way controller actions are invoked.</p>
<p>Looking around in the ASP.NET MVC source code, you can see that there are two interfaces for action invokers: <code>IActionInvoker</code> and <code>IAsyncActionInvoker</code>. Guess what? Sitecore’s ActionInvoker implements <code>IActionInvoker</code> but NOT <code>IAsyncActionInvoker</code> - which means that even though the default MVC action invoker it was wrapping supported async invocation, the wrapper’s lack of <code>IAsyncActionInvoker</code> implementation meant ASP.NET MVC wouldn’t use async invocation at all - and would instead throw an error that you cannot return a <code>Task&lt;ActionResult&gt;</code> from a synchronous controller. What?!</p>
<p>It’s a simple matter to patch Sitecore’s <code>ControllerFactory</code>, which is registered in the <code>&lt;initialize&gt;</code> pipeline:</p>
<pre><code>&lt;initialize&gt;
    &lt;processor type=&quot;Foo.Pipelines.Initialize.InitializeAsyncControllerFactory, Foo.Core&quot; patch:instead=&quot;*[@type=&#39;Sitecore.Mvc.Pipelines.Loader.InitializeControllerFactory, Sitecore.Mvc&#39;]&quot;/&gt;
&lt;/initialize&gt;

using Sitecore.Mvc.Controllers;
using Sitecore.Mvc.Pipelines.Loader;
using Sitecore.Pipelines;
using ControllerBuilder = System.Web.Mvc.ControllerBuilder;
</code></pre>
<p>The class to override the controller factory:</p>
<pre><code>namespace Foo.Pipelines.Initialize
&#123;
    /// &lt;summary&gt;
    /// Replaces the standard Sitecore MVC controller factory with one that knows how to do async action invocation.
    /// &lt;/summary&gt;
    public class InitializeAsyncControllerFactory : InitializeControllerFactory
    &#123;
        protected override void SetControllerFactory(PipelineArgs args)
        &#123;
            SitecoreControllerFactory controllerFactory = new SitecoreAsyncControllerFactory(ControllerBuilder.Current.GetControllerFactory());
            ControllerBuilder.Current.SetControllerFactory(controllerFactory);
        &#125;
    &#125;
&#125;
</code></pre>
<p>Then override the way the <code>SitecoreControllerFactory</code> patches the <code>IActionInvoker</code> on the controllers:</p>
<pre><code>using System.Web.Mvc;
using System.Web.Mvc.Async;
using Sitecore.Mvc.Configuration;
using Sitecore.Mvc.Controllers;

namespace Foo
&#123;
    /// &lt;summary&gt;
    /// Patches the normal Sitecore controller factory to enable executing async actions and using async/await
    /// The ActionInvoker that Sitecore MVC wraps the inner action invoker with does not implement IAsyncActionInvoker,
    /// which means ASP.NET MVC does not try to execute it async if needed, and precludes async/await.
    /// &lt;/summary&gt;
    public class SitecoreAsyncControllerFactory : SitecoreControllerFactory
    &#123;
        public SitecoreAsyncControllerFactory(IControllerFactory innerFactory) : base(innerFactory)
        &#123;
        &#125;

        protected override void PrepareController(IController controller, string controllerName)
        &#123;
            if (!MvcSettings.DetailedErrorOnMissingAction)
            &#123;
                return;
            &#125;
            Controller controller2 = controller as Controller;
            if (controller2 == null)
            &#123;
                return;
            &#125;

            /* BEGIN PATCH FOR ASYNC INVOCATION (the rest of this method is stock) */
            IAsyncActionInvoker asyncInvoker = controller2.ActionInvoker as IAsyncActionInvoker;

            if (asyncInvoker != null)
            &#123;
                controller2.ActionInvoker = new SitecoreAsyncActionInvoker(asyncInvoker, controllerName);
                return;
            &#125;
            /* END PATCH FOR ASYNC INVOCATION */

            IActionInvoker actionInvoker = controller2.ActionInvoker;
            if (actionInvoker == null)
            &#123;
                return;
            &#125;
            controller2.ActionInvoker = new SitecoreActionInvoker(actionInvoker, controllerName);
        &#125;
    &#125;
&#125;
</code></pre>
<p>And finally, implement an override of <code>SitecoreActionInvoker</code> which implements <code>IAsyncActionInvoker</code>:</p>
<pre><code>using System;
using System.Web.Mvc;
using System.Web.Mvc.Async;
using Sitecore.Mvc.Controllers;

namespace Foo
&#123;
    /// &lt;summary&gt;
    /// Literally all this does is provider an IAsyncActionInvoker wrapper the same way SitecoreActionInvoker wraps non-IAsyncActionInvokers
    /// This instructs ASP.NET MVC to perform async invocation for controller actions.
    /// &lt;/summary&gt;
    public class SitecoreAsyncActionInvoker : SitecoreActionInvoker, IAsyncActionInvoker
    &#123;
        private readonly IAsyncActionInvoker _innerInvoker;

        public SitecoreAsyncActionInvoker(IAsyncActionInvoker innerInvoker, string controllerName) : base(innerInvoker, controllerName)
        &#123;
            _innerInvoker = innerInvoker;
        &#125;

        public IAsyncResult BeginInvokeAction(ControllerContext controllerContext, string actionName, AsyncCallback callback, object state)
        &#123;
            return _innerInvoker.BeginInvokeAction(controllerContext, actionName, callback, state);
        &#125;

        public bool EndInvokeAction(IAsyncResult asyncResult)
        &#123;
            return _innerInvoker.EndInvokeAction(asyncResult);
        &#125;
    &#125;
&#125;
</code></pre>
<p>Then you can go forth and write lovely async controller renderings!</p>
<pre><code>public async Task&lt;ActionResult&gt; AsyncActionMethod()
&#123;
    // download a bunch of URLs in parallel with await
    var webClient = new WebClient();

    var urls = new[] &#123;
        &quot;https://google.com&quot;,
        &quot;https://bing.com&quot;,
        &quot;https://yahoo.com&quot;
    &#125;.Select(url =&gt; webClient.DownloadStringTaskAsync(url));

    var contents = await Task.WhenAll(urls);

    // or just await one task
    var google = await webClient.DownloadStringTaskAsync(&quot;https://google.com&quot;);

    // execution will pick up right here when all the awaited tasks are done - thawing the thread to finish execution

    return View(contents);
&#125;
</code></pre>
<p>Have fun!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kamsar.net/index.php/2015/05/Enabling-Async-in-Sitecore-Controller-Renderings/" data-id="ckrl9emy3003398q7bt480d37" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    
    
    <article id="post-Extending-Sitecore-Rich-Text-Preview-CSS" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/index.php/2015/05/Extending-Sitecore-Rich-Text-Preview-CSS/">Extending Sitecore Rich Text Preview CSS</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/index.php/2015/05/Extending-Sitecore-Rich-Text-Preview-CSS/">
    <time datetime="2015-05-15T18:44:16.000Z" itemprop="datePublished">May 15, 2015</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/index.php/category/Sitecore/">Sitecore</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>The <a target="_blank" rel="noopener" href="https://jammykam.wordpress.com/">other Sitecore Kam</a> wrote an excellent post titled <a target="_blank" rel="noopener" href="https://jammykam.wordpress.com/2015/03/11/user-specific-or-multi-site-specific-css-styles-in-sitecore-rich-text-editor/">User Specific or Multi Site Specific CSS styles in Sitecore Rich Text Editor</a> a few months ago. I noticed one gap in what it did, however: changing the RTE configuration does not change the <em>preview</em> of the rich text shown in the Sitecore content editor interface.</p>
<p>This means that you’d see the site specific styles when in the RTE proper, but not when browsing the item in the content editor.</p>
<p>So here’s how to accomplish just that. The RTE preview is rendered by the <code>sitecore/shell/Controls/Rich Text Editor/Preview.aspx</code> page. Being a normal Web Form page, we can hack its <code>Inherits</code> attribute to something else in order to inject our custom CSS:</p>
<pre><code>&lt;%@ Page ... Inherits=&quot;MyLibrary.MultisiteRichTextEditorPreview, MyLibraryAssembly&quot; %&gt;
</code></pre>
<p>Then we have to create a class which inherits the default codebehind class, <code>Sitecore.Shell.Controls.RADEditor.Preview</code>:</p>
<pre><code>using System;
using System.Web.UI;
using Sitecore.Shell.Controls.RADEditor;

namespace MyLibrary
&#123;
    public class MultisiteRichTextEditorPreview : Preview
    &#123;
        protected override void OnLoad(EventArgs e)
        &#123;
            base.OnLoad(e);

            // replace the method call here with whatever you&#39;re using to resolve a custom RTE CSS path(s)
            // note that the query string parameter &#39;id&#39; is the context item ID here just like in the EditorConfiguration Kamruz blogged about.
            var stylesheetPath = MultisiteRichTextEditorUtility.GetRichTextEditorCssPath();

            if (stylesheetPath != null) Stylesheets.Controls.Add(new LiteralControl(string.Format(&quot;&lt;link href=\&quot;&#123;0&#125;\&quot; rel=\&quot;stylesheet\&quot;&gt;&quot;, stylesheetPath)));
        &#125;
    &#125;
&#125;
</code></pre>
<p>Finally, we need to ‘improve’ our RTE stylesheet (this is optional, but excellent!):</p>
<pre><code>* &#123;
    font-family: &quot;Comic Sans MS&quot; !important;
    color: pink !important;
&#125;
</code></pre>
<p>And then we have our newly enhanced rich text preview:</p>
<img src="/index.php/2015/05/Extending-Sitecore-Rich-Text-Preview-CSS/comical.png" class="" title="HAHAHAHAHA">
      
    </div>
    <footer class="article-footer">
      <a data-url="https://kamsar.net/index.php/2015/05/Extending-Sitecore-Rich-Text-Preview-CSS/" data-id="ckrl9emy1002w98q744jsdav5" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/index.php/category/Sitecore/">&amp;laquo; Prev</a><a class="page-number" href="/index.php/category/Sitecore/">1</a><span class="page-number current">2</span><a class="page-number" href="/index.php/category/Sitecore/index.php/page/3/">3</a><a class="page-number" href="/index.php/category/Sitecore/index.php/page/4/">4</a><a class="extend next" rel="next" href="/index.php/category/Sitecore/index.php/page/3/">Next &amp;raquo;</a>
    </nav>
  
</section>
      
        <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul id="recent-post" class="no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/index.php/category/JavaScript/">JavaScript</a></p>
              <p class="item-title"><a href="/index.php/2021/07/Fun-with-async-generators-and-for-await/" class="title">Fun with async generators and for await</a></p>
              <p class="item-date"><time datetime="2021-07-26T23:30:51.000Z" itemprop="datePublished">July 26, 2021</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/index.php/category/Jamstack/">Jamstack</a></p>
              <p class="item-title"><a href="/index.php/2020/08/Deploying-multiple-Netlify-sites-from-one-Git-repository/" class="title">Deploying multiple Netlify sites from one monorepo</a></p>
              <p class="item-date"><time datetime="2020-08-21T03:30:32.000Z" itemprop="datePublished">August 20, 2020</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/index.php/category/JSS/">JSS</a></p>
              <p class="item-title"><a href="/index.php/2019/09/Running-JSS-headless-mode-in-containers-part-2-Build-containers/" class="title">Running JSS headless mode in containers part 2: Build containers</a></p>
              <p class="item-date"><time datetime="2019-09-16T02:14:04.000Z" itemprop="datePublished">September 15, 2019</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/index.php/category/JSS/">JSS</a></p>
              <p class="item-title"><a href="/index.php/2019/09/Running-JSS-headless-mode-in-containers-part-1/" class="title">Running JSS headless mode in containers, part 1</a></p>
              <p class="item-date"><time datetime="2019-09-08T19:00:36.000Z" itemprop="datePublished">September 8, 2019</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/index.php/category/C/">C#</a></p>
              <p class="item-title"><a href="/index.php/2019/05/Build-2019-All-the-things/" class="title">Build 2019: All the things</a></p>
              <p class="item-date"><time datetime="2019-05-10T23:01:11.000Z" itemprop="datePublished">May 10, 2019</time></p>
            </div>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/index.php/category/April-1/">April 1</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Blade/">Blade</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Build-Scripts/">Build Scripts</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/C/">C#</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Dianoga/">Dianoga</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/JSS/">JSS</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Jamstack/">Jamstack</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/JavaScript/">JavaScript</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Node-js/">Node.js</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Sitecore/">Sitecore</a><span class="category-list-count">39</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Sitecore/Crypto/">Crypto</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Sitecore/Lucene/">Lucene</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Sitecore/MVC/">MVC</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Sitecore/Search/">Search</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Sitecore/xDB/">xDB</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Synthesis/">Synthesis</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Unicorn/">Unicorn</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/WebConsole/">WebConsole</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  
  <div id="toTop" class="fa fa-chevron-up"></div>
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      <p>&copy; 2021 Kam Figy</p>
      <p><small>Opinions expressed on this blog are my own, and not necessarily those of my employer.</small></p>
     <p><small>This work is licensed under a <a rel="license noopener" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</small></p>
    </div>
  </div>
</footer>
    


<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>




<script src="/js/script.js"></script>


  </div>
</body>
</html>