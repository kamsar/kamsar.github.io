<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Category: Sitecore | Kam&#39;s Idea Log</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Kam&#39;s Idea Log">
<meta property="og:url" content="https://kamsar.net/index.php/category/Sitecore/index.php/page/3/index.html">
<meta property="og:site_name" content="Kam&#39;s Idea Log">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Kam Figy">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@kamsar">
  
    <link rel="alternative" href="/index.php/feed" title="Kam&#39;s Idea Log" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:400italic,400,600' rel='stylesheet' type='text/css'>
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">

  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-62284328-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


<meta name="generator" content="Hexo 5.4.0"></head>
<body>
  <div id="container">
    <header id="header">
  <div id="header-main" class="header-inner">
    <div class="outer">
      <a href="/" id="logo">
        <span class="site-title">Kam&#39;s Idea Log</span>
        <span class="subtitle">C#, Jamstack, and Shenanigans</span>
      </a>
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/blog/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        <div class="profile" id="profile-nav">
          <a id="profile-anchor" href="javascript:;"><img class="avatar" src="https://www.gravatar.com/avatar/314826f5d569260f26ac9f26f9e38b86?s=40" srcset="https://www.gravatar.com/avatar/314826f5d569260f26ac9f26f9e38b86?s=80 2x" alt="omg the beard"><i class="fa fa-caret-down"></i></a>
        </div>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"> </button><input type="hidden" name="sitesearch" value="https://kamsar.net"></form>
      </div>
    </div>
  </div>
  <div id="main-nav-mobile" class="header-sub header-inner">
    <table class="menu outer">
      <tr>
      
        <td><a class="main-nav-link" href="/">Home</a></td>
      
        <td><a class="main-nav-link" href="/blog/archives">Archives</a></td>
      
      <td>
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="https://kamsar.net"></form>
      </td>
      </tr>
    </table>
  </div>
  
  <div id="header-sub" class="header-sub header-inner">
    <div class="outer">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/index.php/category/April-1/">April 1</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Blade/">Blade</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Build-Scripts/">Build Scripts</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/C/">C#</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Dianoga/">Dianoga</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/JSS/">JSS</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Jamstack/">Jamstack</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/JavaScript/">JavaScript</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Node-js/">Node.js</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Sitecore/">Sitecore</a><span class="category-list-count">39</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Synthesis/">Synthesis</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Unicorn/">Unicorn</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/WebConsole/">WebConsole</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>
  
</header>
    <div class="outer">
      <aside id="profile">
  <div class="inner profile-inner">
  	<div class="base-info profile-block">
		  <img id="avatar" src="https://www.gravatar.com/avatar/314826f5d569260f26ac9f26f9e38b86?s=128" srcset="https://www.gravatar.com/avatar/314826f5d569260f26ac9f26f9e38b86?s=256 2x" alt="#sitecorebeard">
      <h2 id="name">Kam Figy</h2>
      <h3 id="title">Principal Platform Architect at</h3>
      <a class="corp-logo" href="https://uniform.dev" target="_blank"><img src="/css/images/uniform-logo.svg" alt="Uniform" width="180"></a>
      <span id="location"><i class="fa fa-map-marker"></i>Vancouver, WA USA</span>
      <a id="follow" target="_blank" rel="noopener" href="https://twitter.com/kamsar">FOLLOW</a>
  	</div>
    <div class="contact-info profile-block">
      <table class="contact-list">
        <tr>
        
          <td><a target="_blank" rel="noopener" href="https://github.com/kamsar" title="github"><i class="fa fa-github"></i></a></td>
        
          <td><a target="_blank" rel="noopener" href="https://twitter.com/kamsar" title="twitter"><i class="fa fa-twitter"></i></a></td>
        
          <td><a href="/index.php/feed" title="rss"><i class="fa fa-rss"></i></a></td>
        
        </tr>
      </table>
    </div>
    <div class="article-info profile-block bio">
      <h2>About</h2>
      <p>Kam has been making websites since 1996, starting out with a 14.4k modem on a <a href="https://en.wikipedia.org/wiki/Party_line_(telephony)" target="_blank">party line</a> in the Hawaiian rainforest. A veteran developer, architect, and speaker, he's been working in the content management space for well over a decade. Kam is the author of <a href="https://github.com/kamsar/Unicorn" target="_blank">Unicorn</a>, <a href="https://github.com/kamsar/Synthesis" target="_blank">Synthesis</a>, <a href="https://github.com/kamsar/Dianoga" target="_blank">Dianoga</a>, and several other open-source libraries.</p>
    </div>
  </div>
</aside>
      <section id="main">
  
  
    
    
      
        <div class="archive-year-wrap">
          <i class="fa fa-calendar"></i>
          <a href="/archives/2015" class="archive-year">2015</a>
        </div>
    
    <article id="post-A-Multiple-Root-Treelist-Field" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/index.php/2015/05/A-Multiple-Root-Treelist-Field/">A Multiple Root Treelist Field</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/index.php/2015/05/A-Multiple-Root-Treelist-Field/">
    <time datetime="2015-05-06T00:00:27.000Z" itemprop="datePublished">May 5, 2015</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/index.php/category/Sitecore/">Sitecore</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Recently I came across a need to allow selecting items for a TreeList field from several locations - specifically, we needed to be able to choose images OR videos to assign, and those were in different places in the content tree.</p>
<p>This has <a target="_blank" rel="noopener" href="http://optimizedquery.com/2013/02/22/sitecore-field-multi-root-treelist/">been done before</a>, but there was altogether too much copied private method in that solution for my taste - and that it appears to not work with Sitecore 7.5 sealed the deal. To the hackmobile!</p>
<p>Turned out to not be too hard to reduce it to one file: Sitecore itself provides a <code>MultiRootTreeList</code> control that is used for rendering the insert data source item dialog (which supports multiple roots). With a little creative manipulation of the control tree, here we go:</p>
<img src="/index.php/2015/05/A-Multiple-Root-Treelist-Field/tree.png" class="" title="Multi root content tree">

<p>And, the code (<a target="_blank" rel="noopener" href="https://gist.github.com/kamsar/33d1245ffdb630b1f126">also as a Gist</a>) - tested on Sitecore 7.2 Update-3 and Sitecore 8 Update-2:</p>
<pre><code>using System;
using System.Linq;
using Sitecore.Diagnostics;
using Sitecore.Globalization;
using Sitecore.Shell.Applications.ContentEditor;
using Sitecore.Text;
using Sitecore.Web;
using Sitecore.Web.UI.HtmlControls;
using Sitecore.Web.UI.WebControls;

namespace Kamsar.FieldTypes
&#123;
    /// &lt;summary&gt;
    /// This field type is like a tree list, but you can specify more than one root item to select from (for example, videos or photos)
    /// The data source roots are specified using pipe delimiting just like regular Sitecore Query language
    /// &lt;/summary&gt;
    public class MultiRootTreeList : TreeList
    &#123;
        protected override void OnLoad(EventArgs args)
        &#123;
            Assert.ArgumentNotNull(args, &quot;args&quot;);
            base.OnLoad(args);

            if (!Sitecore.Context.ClientPage.IsEvent)
            &#123;
                // find the existing TreeviewEx that the base OnLoad added, get a ref to its parent, and remove it from controls
                var existingTreeView = (TreeviewEx)WebUtil.FindControlOfType(this, typeof(TreeviewEx));
                var treeviewParent = existingTreeView.Parent;

                existingTreeView.Parent.Controls.Clear(); // remove stock treeviewex, we replace with multiroot

                // find the existing DataContext that the base OnLoad added, get a ref to its parent, and remove it from controls
                var dataContext = (DataContext)WebUtil.FindControlOfType(this, typeof(DataContext));
                var dataContextParent = dataContext.Parent;

                dataContextParent.Controls.Remove(dataContext); // remove stock datacontext, we parse our own

                // create our MultiRootTreeview to replace the TreeviewEx
                var impostor = new Sitecore.Web.UI.WebControls.MultiRootTreeview();
                impostor.ID = existingTreeView.ID;
                impostor.DblClick = existingTreeView.DblClick;
                impostor.Enabled = existingTreeView.Enabled;
                impostor.DisplayFieldName = existingTreeView.DisplayFieldName;

                // parse the data source and create appropriate data contexts out of it
                var dataContexts = ParseDataContexts(dataContext);

                impostor.DataContext = string.Join(&quot;|&quot;, dataContexts.Select(x =&gt; x.ID));
                foreach(var context in dataContexts) dataContextParent.Controls.Add(context);

                // inject our replaced control where the TreeviewEx originally was
                treeviewParent.Controls.Add(impostor);
            &#125;
        &#125;

        /// &lt;summary&gt;
        /// Parses multiple source roots into discrete data context controls (e.g. &#39;dataSource=/sitecore/content|/sitecore/media library&#39;)
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;originalDataContext&quot;&gt;The original data context the base control generated. We reuse some of its property values.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        protected virtual DataContext[] ParseDataContexts(DataContext originalDataContext)
        &#123;
            return new ListString(DataSource).Select(x =&gt; CreateDataContext(originalDataContext, x)).ToArray();
        &#125;

        /// &lt;summary&gt;
        /// Creates a DataContext control for a given Sitecore path data source
        /// &lt;/summary&gt;
        protected virtual DataContext CreateDataContext(DataContext baseDataContext, string dataSource)
        &#123;
            DataContext dataContext = new DataContext();
            dataContext.ID = GetUniqueID(&quot;D&quot;);
            dataContext.Filter = baseDataContext.Filter;
            dataContext.DataViewName = &quot;Master&quot;;
            if (!string.IsNullOrEmpty(DatabaseName))
            &#123;
                dataContext.Parameters = &quot;databasename=&quot; + DatabaseName;
            &#125;
            dataContext.Root = dataSource;
            dataContext.Language = Language.Parse(ItemLanguage);

            return dataContext;
        &#125;
    &#125;
&#125;
</code></pre>
<p>Have fun!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kamsar.net/index.php/2015/05/A-Multiple-Root-Treelist-Field/" data-id="ckrl9emy2002z98q7hdnw5rtw" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    
    
    <article id="post-sitecore-8-experience-editor-performance-optimization" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/index.php/2015/02/sitecore-8-experience-editor-performance-optimization/">Sitecore 8 Experience Editor Performance Optimization</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/index.php/2015/02/sitecore-8-experience-editor-performance-optimization/">
    <time datetime="2015-02-02T22:46:19.000Z" itemprop="datePublished">February 2, 2015</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/index.php/category/Sitecore/">Sitecore</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Sitecore 8 is pretty nice, but not without its share of rough edges. One persistently annoying issue I came across is that after you compile your solution in Visual Studio, it is <em>glacially</em> slow to start up in Experience Editor (formerly Page Editor) mode. Given that most sites built in modern Sitecore fashion are using component based architecture that is Experience Editor centric, this is a big drag on development time.</p>
<p>In this post I’ll outline the <a target="_blank" rel="noopener" href="https://twitter.com/kamsar/status/562315734710108160">story so far</a>, and some tweaks you can perform to improve the performance of Sitecore 8 after a compilation.</p>
<p>As a baseline, on my i7-3770k, 32GB RAM, and all-SSD system EE 8.0 takes <strong>1:30</strong> to startup after a compile. Yeah, a minute and a half. Sitecore 6.5 will start in the same situation in <strong>0:21</strong>.</p>
<h1 id="Option-1-Precompilation"><a href="#Option-1-Precompilation" class="headerlink" title="Option 1: Precompilation"></a>Option 1: Precompilation</h1><p>John West and Kevin Obee noted that I should try disabling the SPEAK precompilation features. These are in the <code>&lt;initialize&gt;</code> pipeline and registered in <code>Sitecore.Speak.config</code> and <code>ContentTesting\Sitecore.ContentTesting.config</code>. If you comment these out, you trade having the SPEAK interfaces come up slower the first time (because they are not precompiled) for faster initial startup time (because you skip precompiling).</p>
<p>With those two precompilers commented out, my startup time dropped massively to <strong>0:41</strong>. Still twice as slow as Sitecore 7.2, but oh so worth it when you’re compiling all day.</p>
<h1 id="Option-2-Optimize-Compilation"><a href="#Option-2-Optimize-Compilation" class="headerlink" title="Option 2: Optimize Compilation"></a>Option 2: Optimize Compilation</h1><p>Still unsatisfied with spending 20 seconds compiling unchanged .cshtml SPEAK views every time I compile my application, I started looking around into the actual compilation process. An interesting facet of this issue is that it’s <em>not</em> triggered by simply restarting the app pool. You must touch an assembly in the bin folder to trigger the slow startup.</p>
<p>A clue came in the form of this <a target="_blank" rel="noopener" href="http://stackoverflow.com/a/1419979">StackOverflow answer</a> from <a target="_blank" rel="noopener" href="https://twitter.com/pbering">@pbering</a>. He mentioned enabling the <code>optimizeCompilations</code> setting in the web.config. What does this do? Well, off to <a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/ms366723.aspx">MSDN</a>. If you read this document, it makes it clear that when you change a <em>top-level file</em> (which includes anything in <code>bin</code>) it invalidates <em>all</em> dynamically compiled assets because a <em>dependency of their compilation has changed</em>. Razor files, such as what SPEAK uses, are dynamically compiled - .NET parses them, compiles them to a C# class, and stores them off in the <code>Temporary ASP.NET Files</code> folder.</p>
<p>So essentially what happens is that Sitecore 8 depends on a WHOLE LOT of dynamically compiled SPEAK renderings. When you start it up the first time, ASP.NET compiles them and stores them in its compilation cache. As long as you don’t change any dependencies - e.g. dlls, global.asax - .NET can update the cache selectively when the cshtml file is changed, and it’s fast. But as soon as a dependency is changed - e.g. your site dll - .NET throws out the whole site’s cache and compiles it all again, just to be safe. <em>With Sitecore 8, this takes 20-60 seconds at least</em>.</p>
<p>You can instruct .NET to ignore dependency changes and only recompile dynamically compiled files when <em>the file itself is modified</em>. This has some potential dangers <em>if you modify a dependency without changing the dynamically compiled file and make a breaking change</em>; <a target="_blank" rel="noopener" href="https://msdn.microsoft.com/en-us/library/ms366723.aspx">see the MSDN article</a> for details of the things to be aware of if you enable optimization.</p>
<p><strong>The good news is, if you turn on <code>&lt;compilation optimizeCompilations=&quot;true&quot;&gt;</code> in your web.config, there is no longer any SPEAK recompiling on startup! Even better, it starts up in 0:13, beating 7.2 by 8 seconds!</strong></p>
<p>That said, be aware that there are significant issues to be aware of when enabling optimizeCompilations. Read the MSDN article. I have not deeply tested using this setting, other than it removes the startup speed issue. If you run into problems, stopping IIS and clearing the Temporary ASP.NET files folder should clear it up. <em>Rebuild may not help.</em></p>
<h1 id="Option-3-Disable-the-SPEAK-Experience-Editor"><a href="#Option-3-Disable-the-SPEAK-Experience-Editor" class="headerlink" title="Option 3: Disable the SPEAK Experience Editor"></a>Option 3: Disable the SPEAK Experience Editor</h1><p>A separate ticket on Sitecore support (relating to EE in Sitecore MVC) rustled up this other possible solution: disable the SPEAK-based Experience Editor, and go back to the Sheer one from previous Sitecore versions. This removes all cshtml compilation issues from the equation, and feels slightly faster in the browser to me. It has a less-polished UI appearance however, likely due to it not being a priority to reskin :)</p>
<p>To disable the SPEAK EE, open <code>App_Config/Include/Sitecore.MvcExperienceEditor.config</code>. Locate the comment around like 33 regarding ‘uncomment the page extenders below to switch to sheer’ and follow the directions in the comment.</p>
<p>Hope that helps!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kamsar.net/index.php/2015/02/sitecore-8-experience-editor-performance-optimization/" data-id="ckrl9emxz002o98q7d4q64tm7" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    
    
    <article id="post-quick-note-sitecore-mvc-partials" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/index.php/2015/01/quick-note-sitecore-mvc-partials/">Quick note: Sitecore MVC partials</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/index.php/2015/01/quick-note-sitecore-mvc-partials/">
    <time datetime="2015-01-08T03:36:25.000Z" itemprop="datePublished">January 7, 2015</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/index.php/category/Sitecore/">Sitecore</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Here’s a bit of an obtuse trick that lets you use <code>@Html.Partial()</code> effectively on Sitecore MVC View renderings without specifying the full path to the partial you want to render. You might think that regular MVC syntax would work here:</p>
<pre><code>@Html.Partial(&quot;_MyPartial&quot;)
</code></pre>
<p>But you’d be wrong. Instead, you’ll get an error that the partial could not be found, and the perplexing message that it tried to search <code>[path-to-views]/Sitecore/_MyPartial.cshtml</code>. Where’d that “/sitecore” come from? To understand this, a bit of background on how ASP.NET MVC resolves partials is in order.</p>
<p>The view resolution convention is based on <em>the controller name</em> that executes the view, <em>not the view’s physical location</em>. This makes sense in a pure ASP.NET MVC environment where every view is the result of a controller. However in a View Rendering, there’s just the cshtml. Except that in the background, Sitecore executes the View Rendering using a shim controller - a shim that goes by <code>SitecoreController</code>. This is where the <code>/Views/Sitecore</code> search path comes from.</p>
<p>So what’s the trick? Well, as long as all your views are in a MVC-like hierarchy, you can refer to the partial using the parent path:</p>
<pre><code>@Html.Partial(&quot;../ViewParentFolder/_MyPartial&quot;)
</code></pre>
<p>This jumps out of the controller rendering folder (always Sitecore) and lets you specify the parent folder directly instead, without resorting to a full absolute path which - especially if you use areas or moved views around later - could break.</p>
<p>In case you’re wondering why I’m using native partials instead of <code>@Html.Sitecore().Rendering()</code> or <code>@Html.Sitecore().ViewRendering()</code> and such, these are static components of a MVC layout that are shared between multiple layouts - so it doesn’t make much sense to also register them as dynamic renderings and take the performance hit of that lookup.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kamsar.net/index.php/2015/01/quick-note-sitecore-mvc-partials/" data-id="ckrl9emxy002h98q7hzk01mpt" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    
    
      
        <div class="archive-year-wrap">
          <i class="fa fa-calendar"></i>
          <a href="/archives/2014" class="archive-year">2014</a>
        </div>
    
    <article id="post-automatic-asp-dot-net-connection-string-encryption" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/index.php/2014/07/automatic-asp-dot-net-connection-string-encryption/">Automatic ASP.NET connection string encryption</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/index.php/2014/07/automatic-asp-dot-net-connection-string-encryption/">
    <time datetime="2014-07-16T00:29:06.000Z" itemprop="datePublished">July 15, 2014</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/index.php/category/Sitecore/">Sitecore</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Encrypting your connection strings is a good practice as it obfuscates your database connection information from an attacker who has gained filesystem access to your web server. It’s a bit of a pain to implement if you’re wanting to keep all of your build happening on a CI server however, as encrypting it requires a executing <code>aspnet_regiis</code> on the target server because the encryption is keyed by the machine key of the destination server.</p>
<p>The other day I was reading <a target="_blank" rel="noopener" href="http://blog.istern.dk/2014/05/01/encrypting-and-securing-your-sitecore-connenction-strings/">Thomas Stern’s article</a> about encrypting Sitecore connection strings and it got me to thinking of ways to make connection string encryption fully automatic with minimal configuration. Turns out it’s actually quite easy.</p>
<p>There are actually quite nice <a target="_blank" rel="noopener" href="http://www.codeproject.com/Tips/598863/EncryptionplusDecryptionplusConnectionplusStringpl">C# APIs to encrypt and decrypt</a> so I set to try and make the application self-encrypt on startup using these APIs. That way you can deploy an unencrypted configuration file from CI, and as soon as the app starts up (which is immediately in my case since we run some HTTP calls to it as part of the deploy) it will encrypt itself using the local machine key.</p>
<p>To use this code example you will need to install the <a target="_blank" rel="noopener" href="https://www.nuget.org/packages/WebActivatorEx/">WebActivator NuGet package</a> that allows it to register itself as an application startup task. You can also just call the <code>AutoEncrypt</code> method in <code>Global.asax</code> for the same effect, but WebActivator makes it completely self-contained.</p>
<p>This example only runs encryption if <code>&lt;compilation debug=&quot;false&quot;&gt;</code> is in the web.config (so for local debugging you keep yourself decrypted), and the section has not already been encrypted. It is also fully compatible with the default <code>App_Config\ConnectionStrings.config</code> that Sitecore uses as the config reader is smart enough to save the right file.</p>
<script src="//gist.github.com/ef3a9f3b7ef1f9d491d5.js"></script>

<p>Hope that’s helpful.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kamsar.net/index.php/2014/07/automatic-asp-dot-net-connection-string-encryption/" data-id="ckrl9emxx002d98q75v9r0x44" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    
    
    <article id="post-indexing-subcontent" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/index.php/2014/05/indexing-subcontent/">Indexing Subcontent</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/index.php/2014/05/indexing-subcontent/">
    <time datetime="2014-05-15T03:13:05.000Z" itemprop="datePublished">May 14, 2014</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/index.php/category/Sitecore/">Sitecore</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Often in Sitecore solutions we will utilize the page component architecture, where a page is composed of a base item and one or more “subcontent” items that are data sources for renderings that we have added to the page to customize its layout. This grants editors extreme flexibility to customize what is shown on their pages, but causes a major headache if you’re trying to have your search index contain the full content of a page because now the content is spread across potentially many backend items.</p>
<p><em>Note: While the code presented in this article is mine, the original idea was my coworker Erik Brown’s. Unfortunately he has no Twitter or blog that I know of, but if he ever gets one you should follow it :)</em></p>
<p>The solution we came up with utilizes Sitecore 7’s <em>computed index fields</em> (blog posts: <a target="_blank" rel="noopener" href="http://www.sitecore.net/Community/Technical-Blogs/John-West-Sitecore-Blog/Posts/2013/03/Sitecore-7-Computed-Index-Fields.aspx">John West</a>, <a target="_blank" rel="noopener" href="http://www.sitecore.net/Community/Technical-Blogs/Martina-Welander-Sitecore-Blog/Posts/2013/09/Sitecore-7-Search-Tips-Computed-Fields.aspx">Martina Welander</a>), and a handy but less than obvious trick. </p>
<p>The trick is that the Sitecore indexes can contain more than one value for the same index field. This means that if you want to augment the value of the system <code>_content</code> field (which contains all the indexable text fields on the item), all you have to do is define a computed field that <em>is also named</em> <code>_content</code>. Now the <code>_content</code> index field stores two values: the system value, and your computed value - and it will search on both values when you query it.</p>
<p>Armed with this knowledge I set out to use the layout field on the base item to find all rendering datasources it points to and use the same code that Sitecore uses to create the <code>_content</code> value for the main item. This turned out to not be all that hard (though I had the advantage of having done a lot of layout field messing around before):</p>
<script src="//gist.github.com/d6bfcdd2f3ee7163f0f9.js"></script>

<p>Registering the computed field to augment the main <code>_content</code> index field requires a config patch file (note that this targets Lucene; your patch for SOLR or Coveo would be different):</p>
<script src="//gist.github.com/7b76515efca7a48f8911.js"></script>

<p>Another handy tweak for indexing this kind of item is to use <a target="_blank" rel="noopener" href="https://twitter.com/techphoria414">Nick Wesselman</a>‘s <a target="_blank" rel="noopener" href="http://www.techphoria414.com/Blog/2013/November/Sitecore-7-Computed-Fields-All-Templates-and-Datasource-Content">handy code to cause the main item to be updated in the index whenever any of its datasource items are modified</a>. Nice work!</p>
<p>Hope you find this helpful :)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kamsar.net/index.php/2014/05/indexing-subcontent/" data-id="ckrl9emxv002898q7ec916aht" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    
    
    <article id="post-using-web-api-2-attribute-routing-with-sitecore" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/index.php/2014/05/using-web-api-2-attribute-routing-with-sitecore/">Using Web API 2 Attribute Routing with Sitecore</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/index.php/2014/05/using-web-api-2-attribute-routing-with-sitecore/">
    <time datetime="2014-05-03T02:25:07.000Z" itemprop="datePublished">May 2, 2014</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/index.php/category/Sitecore/">Sitecore</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>There are a lot of times when developing a Sitecore site that you need to introduce dynamic, API-driven content - such as search autocompletes, single page apps, and other dynamic client-side content. Sitecore itself provides the Item Web API, but sometimes you want a more targeted solution designed for end users to acquire data in a fashion that exposes as little as possible.</p>
<p>Microsoft provides a technology that does this pretty nicely: the aptly named <a target="_blank" rel="noopener" href="http://www.asp.net/web-api">ASP.NET Web API</a>. Web API uses a ASP.NET MVC-like controller to easily expose REST services over JSON or XML. I set out to make it work with Sitecore. Of course, <a target="_blank" rel="noopener" href="http://patrickdelancy.com/2013/08/sitecore-webapi-living-harmony/">some other folks</a> had already <a target="_blank" rel="noopener" href="http://nttdatasitecore.com/Blog/2013/November/Using-Web-API-with-Sitecore-ASPNET-Web-Forms">got this to work</a>. Unfortunately their work is also in some cases out of date - so let’s untangle things.</p>
<h2 id="How-to-get-Web-API-working-on-Sitecore-by-version"><a href="#How-to-get-Web-API-working-on-Sitecore-by-version" class="headerlink" title="How to get Web API working on Sitecore, by version"></a>How to get Web API working on Sitecore, by version</h2><h3 id="Sitecore-6-x-or-7-0-without-Sitecore-MVC"><a href="#Sitecore-6-x-or-7-0-without-Sitecore-MVC" class="headerlink" title="Sitecore 6.x or 7.0 (without Sitecore MVC)"></a>Sitecore 6.x or 7.0 (without Sitecore MVC)</h3><p>If you’re using Sitecore 6 or 7.0 without Sitecore MVC enabled, you can use the directions in the previously referenced blog posts to get Web API configured. By default, Sitecore will not respect ASP.NET routing unless Sitecore MVC is enabled so you have to use the solutions these blogs present to make Sitecore ignore routed URLs.</p>
<h3 id="Sitecore-with-Sitecore-MVC-enabled"><a href="#Sitecore-with-Sitecore-MVC-enabled" class="headerlink" title="Sitecore with Sitecore MVC enabled"></a>Sitecore with Sitecore MVC enabled</h3><p>When Sitecore MVC is enabled (and you cannot turn it off on Sitecore 7.1 and later), you do not need the pipeline handler presented in the existing blog posts about Sitecore and Web API - Sitecore will automatically hand off routed requests to the route handler out of the box.</p>
<h2 id="Web-API-versioning"><a href="#Web-API-versioning" class="headerlink" title="Web API versioning"></a>Web API versioning</h2><p>At this time there are two versions of Web API: </p>
<ul>
<li>v1, which released concurrently with ASP.NET MVC 4.</li>
<li>v2, which released concurrently with ASP.NET MVC 5. </li>
</ul>
<p>If you’re on Sitecore 6 you’ll be using v1, because Sitecore 6 runs on .NET 4.0, and Web API 2 requires .NET 4.5. On Sitecore 7, you have more options. With 7.0 and MVC disabled, you can run v1 or v2. However on Sitecore 7.0 with MVC or 7.1, this adds a dependency on ASP.NET MVC 4 so you are limited to Web API v1 unless you <a href="/index.php/2013/12/using-mvc-5-with-sitecore-7-1/">follow the instructions in this post</a> to add binding redirects and config modifications to enable MVC 5. The landscape thankfully improves with Sitecore 7.2, as that uses ASP.NET MVC 5.1 which easily adapts to Web API 2. <em>Note that attribute routing, the point of this post, requires Web API 2</em></p>
<h2 id="Attribute-routing"><a href="#Attribute-routing" class="headerlink" title="Attribute routing?"></a>Attribute routing?</h2><p>About time we started talking about the core of this post, eh? Attribute routing is a snazzy new way to register routes for Web API and ASP.NET MVC that was introduced in Web API 2/MVC 5 (and it was adapted from a community developed module for MVC 4). In earlier versions, you had to register routes in a global route table that was generally constructed all in one global class. This made developing relatively ad-hoc data services that provide what amount to an “AJAX backend for a CMS page” somewhat problematic as your dependency of a small part of the site now has to stick its fingers in everyone else’s pie by adding a global route.</p>
<p>Attribute routing solves this issue by allowing you to use standard .NET attributes (you know, like <code>[HttpPost]</code> on a MVC action method) to define the route to the code. This makes a lot more sense to my way of thinking. Here’s an example attribute-routed Web API 2 controller:</p>
<script src="//gist.github.com/41b36cbf412b81c1d75a.js"></script>

<p><a target="_blank" rel="noopener" href="http://www.asp.net/web-api/overview/web-api-routing-and-actions/attribute-routing-in-web-api-2">Microsoft has written pretty detailed documentation</a> about Web API 2 attribute routing, which I suggest you review before getting serious about using this stuff.</p>
<h2 id="Enabling-attribute-routing-in-Sitecore"><a href="#Enabling-attribute-routing-in-Sitecore" class="headerlink" title="Enabling attribute routing in Sitecore"></a>Enabling attribute routing in Sitecore</h2><p>If you read the aforementioned documentation, you’re probably already well on your way to enabling attribute routing in Sitecore since it’s the same as any other site - all you have to do is register the attribute routes.</p>
<p>The question then becomes how to do that in Sitecore. I’d say the official route is to add a pipeline handler to the <code>initialize</code> pipeline that does the registration. I decided to go with a more pure .NET approach, and register it using <a target="_blank" rel="noopener" href="https://github.com/davidebbo/WebActivator">WebActivator</a> - look ma, no config file! I created <code>App_Start\WebApiConfig.cs</code> - a pattern which may seem familiar to folks who’ve recently worked on ASP.NET MVC sites - and registered my attribute routes:</p>
<script src="//gist.github.com/d7f47ff20e59d8fdd4f5.js"></script>

<p>So now all I have to do is:</p>
<ul>
<li>Install WebActivatorEx from NuGet</li>
<li>Copy WebApiConfig.cs into my project</li>
<li>Create an attribute-routed controller to do stuff</li>
</ul>
<p>Pretty simple, and - if you’re using Sitecore 7.2 - easy to get set up on as well. For Sitecore before 7.2 there are some potential hoops to jump through to get attribute routing.</p>
<p>Anyhow, I hope this was helpful to someone.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kamsar.net/index.php/2014/05/using-web-api-2-attribute-routing-with-sitecore/" data-id="ckrl9emxu002598q7dk1s51nn" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    
    
    <article id="post-have-two-web-databases-dont-forget-the-indexupdatestrategy" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/index.php/2014/01/have-two-web-databases-dont-forget-the-indexupdatestrategy/">Have two web databases? Don&#39;t forget the IndexUpdateStrategy</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/index.php/2014/01/have-two-web-databases-dont-forget-the-indexupdatestrategy/">
    <time datetime="2014-01-14T04:12:03.000Z" itemprop="datePublished">January 13, 2014</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/index.php/category/Sitecore/">Sitecore</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/index.php/category/Sitecore/Search/">Search</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>If you have two web databases in a Sitecore 7 site (e.g. for a pre-production preview or staging site) and you’re using Lucene here’s something to be aware of:</p>
<p>Simply copying the <code>Sitecore.ContentSearch.Lucene.Index.Web.config</code> file, renaming the index and changing the <code>&lt;locations&gt;</code> entr(ies) is not sufficient to make your new index work correctly! You’ll  notice that if you publish items to that database that the updates don’t make it into the index. Why not?</p>
<p>Simply put, the default <a target="_blank" rel="noopener" href="http://www.sitecore.net/Community/Technical-Blogs/John-West-Sitecore-Blog/Posts/2013/04/Sitecore-7-Index-Update-Strategies.aspx"><code>IndexUpdateStrategies</code></a> are confusingly named. The web index defaults to the <code>onPublishEndAsync</code> strategy, which makes sense to use for our staging database as well - we want the index to get updated by the event queue after a publish completes. But there’s one minor detail: the <code>onPublishEndAsync</code> strategy should really be called <code>onPublishEndAsyncWebdb</code> or something similar. Let’s look at how the strategy is defined:</p>
<pre><code>&lt;onPublishEndAsync type=&quot;Sitecore.ContentSearch.Maintenance.Strategies.OnPublishEndAsynchronousStrategy, Sitecore.ContentSearch&quot;&gt;
    &lt;param desc=&quot;database&quot;&gt;web&lt;/param&gt;
    &lt;CheckForThreshold&gt;true&lt;/CheckForThreshold&gt;
&lt;/onPublishEndAsync&gt;
</code></pre>
<p>Derp - that <code>&lt;param desc=&quot;database&quot;&gt;web&lt;/param&gt;</code>! The strategy actually is only watching the event queue for updates from a single database - and that database is not our staging database. The solution is to define a copy of the <code>onPublishEndAsync</code> strategy for your staging index and change the database parameter, then change your index declaration to reference that strategy instead:</p>
<p>In app_config\include\sitecore.contentsearch.lucene.defaultindexconfiguration.config (or a patch thereof):</p>
<pre><code>&lt;onPublishEndAsyncStaging type=&quot;Sitecore.ContentSearch.Maintenance.Strategies.OnPublishEndAsynchronousStrategy, Sitecore.ContentSearch&quot;&gt;
  &lt;param desc=&quot;database&quot;&gt;web_staging&lt;/param&gt;
  &lt;CheckForThreshold&gt;true&lt;/CheckForThreshold&gt;
&lt;/onPublishEndAsyncStaging&gt;
</code></pre>
<p>In App_Config\Include\Sitecore.ContentSearch.Lucene.Index.Web_Staging.config (or wherever you’re defining your staging index), reference the new strategy instead of the existing strategy:</p>
<pre><code>&lt;strategy ref=&quot;contentSearch/indexUpdateStrategies/onPublishEndAsyncStaging&quot; /&gt;
</code></pre>
<p>Note that if you defined an index that spanned multiple databases you’d need to define multiple strategies for its updates, and reference all of them from the index config - an index can have multiple update strategies.</p>
<p>Hope this is helpful :)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kamsar.net/index.php/2014/01/have-two-web-databases-dont-forget-the-indexupdatestrategy/" data-id="ckrl9emxt001y98q77oxc6e7e" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    
    
      
        <div class="archive-year-wrap">
          <i class="fa fa-calendar"></i>
          <a href="/archives/2013" class="archive-year">2013</a>
        </div>
    
    <article id="post-using-mvc-5-with-sitecore-7-1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/index.php/2013/12/using-mvc-5-with-sitecore-7-1/">Using MVC 5 with Sitecore 7.1</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/index.php/2013/12/using-mvc-5-with-sitecore-7-1/">
    <time datetime="2013-12-27T04:52:05.000Z" itemprop="datePublished">December 26, 2013</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/index.php/category/Sitecore/">Sitecore</a><i class="fa fa-angle-right"></i><a class="article-category-link" href="/index.php/category/Sitecore/MVC/">MVC</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>If you’re using something that is already on ASP.NET MVC 5, for example the latest release of Blade, and want to upgrade to Sitecore 7.1 you may be worried that as of 7.1 Sitecore takes a dependency on ASP.NET MVC 4. Thankfully that’s actually pretty simple to work around in such a way that both your MVC5 code and Sitecore’s MVC4 code can work together.</p>
<h2 id="Tell-Sitecore-to-use-MVC5"><a href="#Tell-Sitecore-to-use-MVC5" class="headerlink" title="Tell Sitecore to use MVC5"></a>Tell Sitecore to use MVC5</h2><p>First you need to redirect bindings to MVC4 to MVC5. You accomplish this by adding a <em>binding redirect</em> to your Web.config file like so:</p>
<pre><code>&lt;runtime&gt;
&lt;assemblyBinding xmlns=&quot;urn:schemas-microsoft-com:asm.v1&quot;&gt;
  &lt;dependentAssembly&gt;
    &lt;assemblyIdentity name=&quot;System.Web.Mvc&quot; publicKeyToken=&quot;31bf3856ad364e35&quot; /&gt;
    &lt;bindingRedirect oldVersion=&quot;1.0.0.0-4.0.0.0&quot; newVersion=&quot;5.0.0.0&quot; /&gt;
  &lt;/dependentAssembly&gt;
 &lt;/assemblyBinding&gt;
 &lt;/runtime&gt;
</code></pre>
<p>Once you’ve done this, the new SPEAK backend will actually be making calls to the MVC5 <code>System.Web.Mvc</code> library - which it appears to be quite happy doing.</p>
<h2 id="Comment-out-the-extra-Razor-section-definition"><a href="#Comment-out-the-extra-Razor-section-definition" class="headerlink" title="Comment out the extra Razor section definition"></a>Comment out the extra Razor section definition</h2><p>In Sitecore 7.1, there is a Web.config added to sitecore/shell/client that contains a definition of the Razor config section. If you’re defining the Razor config section yourself on the Web.config - like Blade does - then this is a duplicate declaration and will throw an exception. All you need to do is comment out this duplicate definition and it will fix the issue:</p>
<pre><code>&lt;!--   &lt;configSections&gt;       
    &lt;sectionGroup name=&quot;system.web.webPages.razor&quot; type=&quot;System.Web.WebPages.Razor.Configuration.RazorWebSectionGroup, System.Web.WebPages.Razor, Version=2.0.0.0, Culture=neutral, PublicKeyToken=31BF3856AD364E35&quot;&gt;
        &lt;section name=&quot;host&quot; type=&quot;System.Web.WebPages.Razor.Configuration.HostSection, System.Web.WebPages.Razor, Version=2.0.0.0, Culture=neutral, PublicKeyToken=31BF3856AD364E35&quot; requirePermission=&quot;false&quot; /&gt;
        &lt;section name=&quot;pages&quot; type=&quot;System.Web.WebPages.Razor.Configuration.RazorPagesSection, System.Web.WebPages.Razor, Version=2.0.0.0, Culture=neutral, PublicKeyToken=31BF3856AD364E35&quot; requirePermission=&quot;false&quot; /&gt;       
    &lt;/sectionGroup&gt;        
&lt;/configSections&gt; --&gt;
</code></pre>
<p>That’s all you need to do to get MVC5 running with Sitecore 7.1. The Web.config in the shell will automatically override whatever Razor settings you may have in your Web.config file and keep SPEAK running when it needs to.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kamsar.net/index.php/2013/12/using-mvc-5-with-sitecore-7-1/" data-id="ckrl9emxs001w98q7be6p67z8" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    
    
    <article id="post-sitecore-data-architecture" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/index.php/2013/11/sitecore-data-architecture/">Sitecore Data Architecture</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/index.php/2013/11/sitecore-data-architecture/">
    <time datetime="2013-11-17T06:28:41.000Z" itemprop="datePublished">November 16, 2013</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/index.php/category/Sitecore/">Sitecore</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>There are many times where you need to extend the Sitecore data architecture in some way. One of the most obvious, and most used, is attaching an event handler to one of the item events (e.g. item:saved, item:renamed) but this is not by any means the only way to manipulate items before they get to the database.</p>
<p>This blog post came out of a discussion I had with Alex Shyba about the DataEngine, a few hours on a plane, and a lot of decompilation. I’m going to attempt to show what happens when an item gets saved and where you can plug into that.</p>
<h2 id="The-entry-point"><a href="#The-entry-point" class="headerlink" title="The entry point"></a>The entry point</h2><p>The most high level API is of course the <code>Item</code> class. Saving an item using this API is very simple:</p>
<pre><code>using(new EditContext(item))
&#123;
    item[&quot;MyField&quot;] = &quot;newValue&quot;;
&#125;
</code></pre>
<p>When the <code>EditContext</code> goes out of scope, this causes <code>item.Editing.AcceptChanges()</code> to be invoked, and our journey down the rabbit-hole begins there.</p>
<h2 id="The-Item-Manager"><a href="#The-Item-Manager" class="headerlink" title="The Item Manager"></a>The Item Manager</h2><p>Our next step is the highest level item data API in Sitecore: the <code>ItemManager</code>. At first blush <code>ItemManager</code> appears to be a rather ugly giant static class, with tons of manipulaton methods: <code>SaveItem</code>, <code>AddVersion</code>, etc. However, it’s not as bad as it looks. <code>ItemManager</code> is basically a static facade around the current <code>ItemProvider</code>.</p>
<h2 id="The-Item-Provider"><a href="#The-Item-Provider" class="headerlink" title="The Item Provider"></a>The Item Provider</h2><p>Here’s where things get interesting. You can register <em>multiple</em> item providers in the config under <code>itemManager/providers</code>. While this appears to provide a lot of power as an extension point - being able to plugin your own high level provider - it unfortunately seems to be rather ungainly. If multiple providers are registered you can access them directly using <code>ItemManager.Providers</code>, but the other <code>ItemManager</code> methods only execute against the default provider. You <em>could</em> replace the default provider with your own, but this is less than ideal as it can lead to contention for whose item provider gets used if more than one module wants to extend using it.</p>
<p>Extension points aside, the <code>ItemProvider</code> is the most broad data API Sitecore provides. It deals in high level objects and abstracts lower level concepts like databases and item definitions away. Most all methods in the <code>ItemProvider</code> result in invocations of the next lower level construct, the <code>DataEngine</code>.</p>
<p><em>UPDATE</em>: <a target="_blank" rel="noopener" href="https://twitter.com/techphoria414">Nick Wesselman</a> pointed out that some queries will bypass the Item Provider and go directly to the Data Engine. <a target="_blank" rel="noopener" href="https://gist.github.com/techphoria414/7506347">This gist</a> has some examples of the types of things that bypass the Item Provider. In light of this I’d say the item provider is generally not a good candidate for extending things.</p>
<h2 id="The-Data-Engine"><a href="#The-Data-Engine" class="headerlink" title="The Data Engine"></a>The Data Engine</h2><p><code>DataEngine</code> (generally accessed by <code>databaseObject.DataManager.DataEngine</code>) is a very interesting component for extension. Unlike the item provider, the <code>DataEngine</code> is database-specific. This is also the layer at which item event handlers (e.g. item:saved) are processed, but more interestingly is also a place where you can hook events in an uninterruptible fashion. Regular event handlers, such as <code>item:saved</code>, are vulnerable to being disabled when someone scopes an <code>EventDisabler</code>. Generally this is good, as events are disabled for performance reasons during things like serialization bulk load operations. But occasionally, such as in <a target="_blank" rel="noopener" href="http://github.com/kamsar/Unicorn">Unicorn</a>, you need an event handler that cannot be disabled. Having a Unicorn event not fire would likely mean data being lost.</p>
<p>The internal architecture of <code>DataEngine</code> works something like this:</p>
<ul>
<li>An engine method gets invoked</li>
<li>The engine creates and initializes an <code>DataEngineCommand&lt;&gt;</code> object, using a stored prototype of the command</li>
<li>The <code>DataEngineCommand</code> has its <code>Execute</code> method invoked.</li>
</ul>
<p>The <code>EngineCommand</code> is a generic type, and each action that the engine can take has its own implementation - for example, there is a <code>Sitecore.Data.Engines.DataCommands.SaveItemCommand</code> class. Each of these command types is bootstrapped by a prototype system on the <code>DataEngine</code> itself. The engine, by way of its <code>Commands</code> property, stores copies of each command type. When a new command is needed, the existing prototype command is cloned (<code>Clone()</code>), initialized (<code>Initialize()</code>), and then used to execute the action. These prototypes are settable, including via configuration, so this allows you to inject your own derived implementation of each command and thus inject ‘event handler like’ functionality into the <code>DataEngine</code>.</p>
<p>Item Buckets utilizes this type of functionality injection, replacing the <code>AddFromTemplatePrototype</code> with its own extended implementation. This is the relevant section of Sitecore.Buckets.config:</p>
<pre><code>  &lt;database id=&quot;master&quot; singleInstance=&quot;true&quot; type=&quot;Sitecore.Data.Database, Sitecore.Kernel&quot;&gt;
    &lt;Engines.DataEngine.Commands.AddFromTemplatePrototype&gt;
      &lt;obj type=&quot;Sitecore.Buckets.Commands.AddFromTemplateCommand, Sitecore.Buckets&quot; /&gt;
    &lt;/Engines.DataEngine.Commands.AddFromTemplatePrototype&gt;
  &lt;/database&gt;
</code></pre>
<p>This same functionality could be used to inject non-disableable event handler type functionality into other events, for example by replacing the <code>SaveItemPrototype</code>. Unfortunately this method also suffers from possible contention issues if multiple modules wished to patch these commands, so be careful when using them.</p>
<h2 id="The-DataEngineCommand"><a href="#The-DataEngineCommand" class="headerlink" title="The DataEngineCommand"></a>The <code>DataEngineCommand</code></h2><p>Once the <code>DataEngine</code> creates and executes a command, the command generally does two things:</p>
<ul>
<li>Pass its task down to the Nexus <code>DataApi</code> to be handled</li>
<li>Fire off any normal item event handlers (item:saved), as long as events are not disabled</li>
</ul>
<p>Most of the methods on <code>DataEngineCommand</code> are virtual so you could extend them. The most obvious candidate, of course, is the <code>DoExecute</code> method that performs the basic action of the command. </p>
<p>Further down the rabbit-hole we arrive to the Nexus APIs.</p>
<h2 id="The-Nexus-DataApi"><a href="#The-Nexus-DataApi" class="headerlink" title="The Nexus DataApi"></a>The Nexus <code>DataApi</code></h2><p>The Nexus assembly, due to it containing licensing code I believe, is the only obfuscated assembly in Sitecore. This makes following what the data API is doing rather difficult, but I’m pretty sure I traced it back out as a call to the <code>databaseItem.DataManager.DataSource</code> APIs, which thankfully are not obfuscated. It’s worth noting that the Nexus APIs appear to also be using a <em>separate</em> command-class based architecture internally. Given the sensitive nature of the Nexus assembly however, I would look elsewhere for extension points.</p>
<h2 id="The-DataSource"><a href="#The-DataSource" class="headerlink" title="The DataSource"></a>The <code>DataSource</code></h2><p>The <code>Sitecore.Data.DataSource</code> appears to largely be a translation layer between slightly higher level APIs, where things like <code>Item</code> are used, and the low level API of the data providers (which use constructs like IDs and <code>ItemDefinition</code> instead). The data source is very generic and does not appear to be designed for extension, which is fine because we can extend both above and below it.</p>
<p>Methods within <code>DataSource</code> eventually make calls down to static methods on the <code>DataProvider</code> class.</p>
<h2 id="The-Data-Provider"><a href="#The-Data-Provider" class="headerlink" title="The Data Provider"></a>The Data Provider</h2><p>There are two faces to the <code>DataProvider</code> class. The internal static methods that the <code>DataSource</code> is invoking are helper methods that invoke non-static methods on all of the data providers attached to the database. (Yes, you can have multiple data providers within the same database, which may not even look at the same backend database at all…hehe) The actual data provider instances are the lowest level data APIs in Sitecore. They deal with primitive objects and have a lot of unspoken rules about them that make them tougher to implement than most other extension points. However they are also the most powerful extension point there is. Using a data provider you can manipulate the content tree in nearly any fashion for example <a target="_blank" rel="noopener" href="http://github.com/kamsar/Rhino">Rhino</a>, a data provider that makes serialized item files on disk appear to be real content items in Sitecore.</p>
<h2 id="You’re-still-reading-this"><a href="#You’re-still-reading-this" class="headerlink" title="You’re still reading this?"></a>You’re still reading this?</h2><p>Hopefully this is a useful post for some crazy nuts like myself who like to bend the guts of Sitecore. It’s definitely a long and byzantine road from saving an item to it getting to the database. Rather amazing that Sitecore is as fast as it is with all of these layers. Part of me suspects that some are baggage from Sitecore 4 for backwards compatibility ;)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kamsar.net/index.php/2013/11/sitecore-data-architecture/" data-id="ckrl9emxs001u98q78m1lajru" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    
    
    <article id="post-make-web-forms-for-marketers-use-a-regular-connection-string" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/index.php/2013/10/make-web-forms-for-marketers-use-a-regular-connection-string/">Make Web Forms for Marketers use a regular connection string</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/index.php/2013/10/make-web-forms-for-marketers-use-a-regular-connection-string/">
    <time datetime="2013-10-10T06:31:11.000Z" itemprop="datePublished">October 9, 2013</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/index.php/category/Sitecore/">Sitecore</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>One of my pet peeves about the Sitecore Web Forms for Marketers module is that it manages the forms database connection string in its own config file, instead of the regular ConnectionStrings.config file.</p>
<p>Fortunately this is easy to fix if you want to manage all your connection strings in one place. First, you need to override the default <code>WFMDataProvider</code> like so:</p>
<script src="//gist.github.com/6903359.js"></script>

<p>Then, you modify the data provider declaration in <code>App_Config\Include\forms.config</code> (replace the namespace and assembly with wherever you place the class above in your project):</p>
<script src="//gist.github.com/6903413.js"></script>

<p>Finally, simply add a connection string named forms (or whatever name you configured in forms.config above) to your <code>ConnectionStrings.config</code> and you’re good to go!</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kamsar.net/index.php/2013/10/make-web-forms-for-marketers-use-a-regular-connection-string/" data-id="ckrl9emxq001n98q7bvk2h5h3" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
  
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/index.php/category/Sitecore/index.php/page/2/">&amp;laquo; Prev</a><a class="page-number" href="/index.php/category/Sitecore/">1</a><a class="page-number" href="/index.php/category/Sitecore/index.php/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/index.php/category/Sitecore/index.php/page/4/">4</a><a class="extend next" rel="next" href="/index.php/category/Sitecore/index.php/page/4/">Next &amp;raquo;</a>
    </nav>
  
</section>
      
        <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul id="recent-post" class="no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/index.php/category/JavaScript/">JavaScript</a></p>
              <p class="item-title"><a href="/index.php/2021/07/Fun-with-async-generators-and-for-await/" class="title">Fun with async generators and for await</a></p>
              <p class="item-date"><time datetime="2021-07-26T23:30:51.000Z" itemprop="datePublished">July 26, 2021</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/index.php/category/Jamstack/">Jamstack</a></p>
              <p class="item-title"><a href="/index.php/2020/08/Deploying-multiple-Netlify-sites-from-one-Git-repository/" class="title">Deploying multiple Netlify sites from one monorepo</a></p>
              <p class="item-date"><time datetime="2020-08-21T03:30:32.000Z" itemprop="datePublished">August 20, 2020</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/index.php/category/JSS/">JSS</a></p>
              <p class="item-title"><a href="/index.php/2019/09/Running-JSS-headless-mode-in-containers-part-2-Build-containers/" class="title">Running JSS headless mode in containers part 2: Build containers</a></p>
              <p class="item-date"><time datetime="2019-09-16T02:14:04.000Z" itemprop="datePublished">September 15, 2019</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/index.php/category/JSS/">JSS</a></p>
              <p class="item-title"><a href="/index.php/2019/09/Running-JSS-headless-mode-in-containers-part-1/" class="title">Running JSS headless mode in containers, part 1</a></p>
              <p class="item-date"><time datetime="2019-09-08T19:00:36.000Z" itemprop="datePublished">September 8, 2019</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/index.php/category/C/">C#</a></p>
              <p class="item-title"><a href="/index.php/2019/05/Build-2019-All-the-things/" class="title">Build 2019: All the things</a></p>
              <p class="item-date"><time datetime="2019-05-10T23:01:11.000Z" itemprop="datePublished">May 10, 2019</time></p>
            </div>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/index.php/category/April-1/">April 1</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Blade/">Blade</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Build-Scripts/">Build Scripts</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/C/">C#</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Dianoga/">Dianoga</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/JSS/">JSS</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Jamstack/">Jamstack</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/JavaScript/">JavaScript</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Node-js/">Node.js</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Sitecore/">Sitecore</a><span class="category-list-count">39</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Sitecore/Crypto/">Crypto</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Sitecore/Lucene/">Lucene</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Sitecore/MVC/">MVC</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Sitecore/Search/">Search</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Sitecore/xDB/">xDB</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Synthesis/">Synthesis</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Unicorn/">Unicorn</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/WebConsole/">WebConsole</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  
  <div id="toTop" class="fa fa-chevron-up"></div>
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      <p>&copy; 2021 Kam Figy</p>
      <p><small>Opinions expressed on this blog are my own, and not necessarily those of my employer.</small></p>
     <p><small>This work is licensed under a <a rel="license noopener" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</small></p>
    </div>
  </div>
</footer>
    


<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>




<script src="/js/script.js"></script>


  </div>
</body>
</html>