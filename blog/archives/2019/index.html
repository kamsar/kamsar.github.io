<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Archives: 2019 | Kam&#39;s Idea Log</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Kam&#39;s Idea Log">
<meta property="og:url" content="https://kamsar.net/blog/archives/2019/index.html">
<meta property="og:site_name" content="Kam&#39;s Idea Log">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Kam Figy">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@kamsar">
  
    <link rel="alternative" href="/index.php/feed" title="Kam&#39;s Idea Log" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:400italic,400,600' rel='stylesheet' type='text/css'>
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">

  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-62284328-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


<meta name="generator" content="Hexo 5.4.0"></head>
<body>
  <div id="container">
    <header id="header">
  <div id="header-main" class="header-inner">
    <div class="outer">
      <a href="/" id="logo">
        <span class="site-title">Kam&#39;s Idea Log</span>
        <span class="subtitle">C#, Jamstack, and Shenanigans</span>
      </a>
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/blog/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        <div class="profile" id="profile-nav">
          <a id="profile-anchor" href="javascript:;"><img class="avatar" src="https://www.gravatar.com/avatar/314826f5d569260f26ac9f26f9e38b86?s=40" srcset="https://www.gravatar.com/avatar/314826f5d569260f26ac9f26f9e38b86?s=80 2x" alt="omg the beard"><i class="fa fa-caret-down"></i></a>
        </div>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"> </button><input type="hidden" name="sitesearch" value="https://kamsar.net"></form>
      </div>
    </div>
  </div>
  <div id="main-nav-mobile" class="header-sub header-inner">
    <table class="menu outer">
      <tr>
      
        <td><a class="main-nav-link" href="/">Home</a></td>
      
        <td><a class="main-nav-link" href="/blog/archives">Archives</a></td>
      
      <td>
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="https://kamsar.net"></form>
      </td>
      </tr>
    </table>
  </div>
  
  <div id="header-sub" class="header-sub header-inner">
    <div class="outer">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/index.php/category/April-1/">April 1</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Blade/">Blade</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Build-Scripts/">Build Scripts</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/C/">C#</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Dianoga/">Dianoga</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/JSS/">JSS</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Jamstack/">Jamstack</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/JavaScript/">JavaScript</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Node-js/">Node.js</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Sitecore/">Sitecore</a><span class="category-list-count">39</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Synthesis/">Synthesis</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Unicorn/">Unicorn</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/WebConsole/">WebConsole</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>
  
</header>
    <div class="outer">
      <aside id="profile">
  <div class="inner profile-inner">
  	<div class="base-info profile-block">
		  <img id="avatar" src="https://www.gravatar.com/avatar/314826f5d569260f26ac9f26f9e38b86?s=128" srcset="https://www.gravatar.com/avatar/314826f5d569260f26ac9f26f9e38b86?s=256 2x" alt="#sitecorebeard">
      <h2 id="name">Kam Figy</h2>
      <h3 id="title">Principal Platform Architect at</h3>
      <a class="corp-logo" href="https://uniform.dev" target="_blank"><img src="/css/images/uniform-logo.svg" alt="Uniform" width="180"></a>
      <span id="location"><i class="fa fa-map-marker"></i>Vancouver, WA USA</span>
      <a id="follow" target="_blank" rel="noopener" href="https://twitter.com/kamsar">FOLLOW</a>
  	</div>
    <div class="contact-info profile-block">
      <table class="contact-list">
        <tr>
        
          <td><a target="_blank" rel="noopener" href="https://github.com/kamsar" title="github"><i class="fa fa-github"></i></a></td>
        
          <td><a target="_blank" rel="noopener" href="https://twitter.com/kamsar" title="twitter"><i class="fa fa-twitter"></i></a></td>
        
          <td><a href="/index.php/feed" title="rss"><i class="fa fa-rss"></i></a></td>
        
        </tr>
      </table>
    </div>
    <div class="article-info profile-block bio">
      <h2>About</h2>
      <p>Kam has been making websites since 1996, starting out with a 14.4k modem on a <a href="https://en.wikipedia.org/wiki/Party_line_(telephony)" target="_blank">party line</a> in the Hawaiian rainforest. A veteran developer, architect, and speaker, he's been working in the content management space for well over a decade. Kam is the author of <a href="https://github.com/kamsar/Unicorn" target="_blank">Unicorn</a>, <a href="https://github.com/kamsar/Synthesis" target="_blank">Synthesis</a>, <a href="https://github.com/kamsar/Dianoga" target="_blank">Dianoga</a>, and several other open-source libraries.</p>
    </div>
  </div>
</aside>
      <section id="main">
  
  
    
    
      
        <div class="archive-year-wrap">
          <i class="fa fa-calendar"></i>
          <a href="/archives/2019" class="archive-year">2019</a>
        </div>
    
    <article id="post-Running-JSS-headless-mode-in-containers-part-2-Build-containers" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/index.php/2019/09/Running-JSS-headless-mode-in-containers-part-2-Build-containers/">Running JSS headless mode in containers part 2: Build containers</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/index.php/2019/09/Running-JSS-headless-mode-in-containers-part-2-Build-containers/">
    <time datetime="2019-09-16T02:14:04.000Z" itemprop="datePublished">September 15, 2019</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/index.php/category/JSS/">JSS</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>In <a href="/index.php/2019/09/Running-JSS-headless-mode-in-containers-part-1/">part 1</a> of this series, we investigated containerizing the JSS headless mode host. But there are some issues with that basic implementation:</p>
<ul>
<li>We still have to pre-compile the JSS app to extract the server bundle, before building the container, and this compile step is not necessarily consistent with the production container environment since it depends on the host environment (different Node versions, OSes, etc are possible)</li>
<li>The standard <a target="_blank" rel="noopener" href="https://hub.docker.com/_/node">Node container</a> is pretty large (900MB), and though there are reasonable reasons for this, something smaller would be nice for production</li>
<li>Because the API key and Sitecore hostname are baked into the server bundle at build time, it would be necessary to maintain a container image for each environment</li>
</ul>
<p>So, let’s fix this by using a <em>build container</em> to create a standardized build environment where we can make our server bundle. Basically, </p>
<img src="/index.php/2019/09/Running-JSS-headless-mode-in-containers-part-2-Build-containers/dawg.jpg" class="">

<h2 id="Build-Containers-101"><a href="#Build-Containers-101" class="headerlink" title="Build Containers 101"></a>Build Containers 101</h2><p>When a <code>Dockerfile</code> executes, the state of each intermediate step is stored so that it need not be repeated every time the image rebuilds. But more importantly, you can also create intermediate <em>build containers</em> that live only long enough to perform a build step, then get thrown away except for some artifacts you want to persist on to some future part of the container build. In the case of our JSS image, the idea is something like this:</p>
<ul>
<li>Create a full Node container</li>
<li>Copy the JSS app into it and run <code>jss build</code></li>
<li>Create a lightweight Node container</li>
<li>Deploy the artifacts from the full Node container and the JSS headless app into it</li>
</ul>
<p>The build container that we use to build the JSS app in is thrown away after the build occurs, leaving only the lightweight production container with its artifacts. In this case, thanks to switching from <code>node:lts</code> to <code>node:lts-alpine</code> as the base container, the built container size shrunk from 921MB to 93MB.</p>
<blockquote>
<p>Note that because the base image is stored as a diff, the image size reduction affects the <em>initial download time</em> of the image on a new host, but once the <code>node:lts</code> image is cached it really only changes the amount of static disk space consumed.</p>
</blockquote>
<p>Adding a build container step involves adding a few lines to the top of the <code>Dockerfile</code> from <a href="/index.php/2019/09/Running-JSS-headless-mode-in-containers-part-1/">part 1</a>:</p>
<pre><code># Create the build container (note aliasing it as &#39;build&#39; so we can get artifacts later)
FROM node:lts as build
# Install the JSS CLI
RUN npm install -g @sitecore-jss/sitecore-jss-cli
# Set a working directory in the container, and copy our app&#39;s source files there
WORKDIR /build
COPY jss-angular /build
# Install the app&#39;s dependencies
RUN npm install
# Run the build
RUN npm run build

# Now, we need to switch contexts into the final container
# lts-alpine is a lightweight Node container, only 90MB
# When we switch contexts, the build container is supplanted
# as the context container
FROM node:lts-alpine

# ...
# When we copy the app&#39;s source into the final container
# we need to use --from=[tag] to get the files from our build container
# instead of the local disk
COPY --from=build /build/dist /jss/dist/$&#123;SITECORE_APP_NAME&#125;
</code></pre>
<h2 id="Tokenizing-the-Server-Bundle"><a href="#Tokenizing-the-Server-Bundle" class="headerlink" title="Tokenizing the Server Bundle"></a>Tokenizing the Server Bundle</h2><p>To solve the issue of the Sitecore API URL and API Key being baked into the server and browser bundles by webpack during <code>jss build</code>, we need to use tokenization. These values really do need to be baked into the file at some point, because the browser that executes them does not understand environment variables on your server or how to replace them - but, we should not need to re-run webpack every time a container starts up either.</p>
<p>We can work around this by baking specific, well-known tokens into the bundle files and then expanding those tokens when the container starts from environment variable values. The approach works something like this:</p>
<ul>
<li>When the build container builds the JSS app, we force it to use specific well-known token values for the API host and API key, such as <code>%sitecoreApiHost%</code></li>
<li>We move all the build output from the build container from <code>*.js</code> files to <code>*.base</code> files. This means the container itself does not contain any JS in its <code>/dist</code>. This is necessary so the container can generate the final files each time it starts up. (Since the same image can start many times with different environment variables present, it has to ‘rebake’ the JS each time)</li>
</ul>
<p>Doing this is a bit harder than just doing the build container. First, during the container build in the <code>Dockerfile</code>:</p>
<pre><code># Before the build container runs the `build` command,
# we need to set specific API key and host values to bake
# into the build artifacts to replace later.
RUN jss setup --layoutServiceHost %layoutServiceHost% --apiKey 309ec3e9-b911-4a0b-aa8d-425045b6dcbd --nonInteractive

RUN npm run build

# After the build container runs the `build` command,
# we need to move all the .js files it emitted to .base files
RUN find dist/ -name &#39;*.js&#39; | xargs -I % mv % %.base
</code></pre>
<p>With the updated <code>Dockerfile</code> in place, the container we build will now have <code>.base</code> files ready to specialize into the running configuration when the container starts up. But without any changes to the image itself, it would fail because we can’t run an app using <code>.base</code> files! So we need to add a little script to the <code>node-headless-ssr-proxy</code> to perform this specialization when it starts up inside a container. The specialization process:</p>
<ul>
<li>Copy all <code>.base</code> files to <code>.js</code> file of the same name (make a runtime copy to use in the browser)</li>
<li>Search &amp; replace the well-known tokens in the <code>.js</code> files with the current runtime environment variables</li>
<li>Start the JSS headless proxy, which will now use the generated <code>.js</code> files and run normally</li>
</ul>
<p>I used <code>bootstrap.sh</code> for the script name, but any name is fine.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find dist/ -name <span class="string">&#x27;*.base&#x27;</span> | <span class="keyword">while</span> <span class="built_in">read</span> filename; <span class="keyword">do</span> <span class="built_in">export</span> jsname=$(<span class="built_in">echo</span> <span class="variable">$filename</span> | sed -e <span class="string">&#x27;s|.base||&#x27;</span>); cp <span class="variable">$filename</span> <span class="variable">$jsname</span>; sed -i -e <span class="string">&quot;s|%layoutServiceHost%|<span class="variable">$SITECORE_API_HOST</span>|g&quot;</span> -e <span class="string">&quot;s|309ec3e9-b911-4a0b-aa8d-425045b6dcbd|<span class="variable">$SITECORE_API_KEY</span>|g&quot;</span> <span class="variable">$jsname</span>; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>This script is a rather hard to read one-liner so let’s piece it out to understand it:</p>
<ul>
<li><code>find dist/ -name &#39;*.base&#39; | while read filename</code> - Finds <code>*.base</code> files anywhere under <code>dist</code>, and reads each found filename into <code>$filename</code> in a loop body</li>
<li><code>do export jsname=$(echo $filename | sed -e &#39;s|.base||&#39;)</code> - Sets <code>$jsname</code> to the name of the found file, with the extension changed from <code>.base</code> to <code>.js</code></li>
<li><code>cp $filename $jsname</code> - copies the <code>.base</code> file to the equivalent path, but using the <code>.js</code> extension instead</li>
<li><code>sed -i -e &quot;s|%layoutServiceHost%|$SITECORE_API_HOST|g&quot; -e &quot;s|309ec3e9-b911-4a0b-aa8d-425045b6dcbd|$SITECORE_API_KEY|g&quot; $jsname</code> - uses <code>sed</code> to perform a regex replace on the known values we baked into the base file, replacing them with the environment variables (<code>$SITECORE_API_HOST</code> and <code>$SITECORE_API_KEY</code>) that form the current runtime configuration for those values</li>
</ul>
<p>Finally we need to get this script to run each time the container starts up. There are several ways we could do this, but I elected to add an npm script to the headless proxy’s <code>package.json</code>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">  <span class="attr">&quot;start&quot;</span>: <span class="string">&quot;node index.js&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;docker&quot;</span>: <span class="string">&quot;./bootstrap.sh &amp;&amp; node index.js&quot;</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>…and then changed the entry point in the <code>Dockerfile</code> to call the container entrypoint:</p>
<pre><code>ENTRYPOINT npm run docker
</code></pre>
<p>The final step is to rebuild the container image so we can start it up, using <code>docker build</code>.</p>
<h3 id="Using-the-tokenized-container"><a href="#Using-the-tokenized-container" class="headerlink" title="Using the tokenized container"></a>Using the tokenized container</h3><p>The headless proxy Node app has always known how to read environment variables for the Sitecore API host and API key, but those have only applied to the <strong>SSR</strong> execution not the browser-side execution. With the modifications we’ve made, setting those same environment variables will now also apply to the browser. Doing this with Docker is quite trivial when booting the container, for example:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 3000:3000 --env SITECORE_API_KEY=[yourkey] --env SITECORE_API_HOST=http://your.site.core [container-image-name]</span><br></pre></td></tr></table></figure>

<h2 id="Putting-it-together"><a href="#Putting-it-together" class="headerlink" title="Putting it together"></a>Putting it together</h2><p>For more clarity, here’s the full contents of the <code>Dockerfile</code> with all these changes made:</p>
<figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:lts as build</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> npm install -g @sitecore-jss/sitecore-jss-cli</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /build</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> jss-angular /build</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> npm install</span></span><br><span class="line"><span class="comment"># setup to use static values we&#x27;ll later replace with env vars</span></span><br><span class="line"><span class="comment"># (for values that are baked into the server bundle)</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> jss setup --layoutServiceHost %layoutServiceHost% --apiKey 309ec3e9-b911-4a0b-aa8d-425045b6dcbd --nonInteractive</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> npm run build</span></span><br><span class="line"><span class="comment"># Rename all .js files to .js.base (so we can bootstrap tokens later)</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> find dist/ -name <span class="string">&#x27;*.js&#x27;</span> | xargs -I % mv % %.base</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> node:lts-alpine</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> SITECORE_API_HOST=http://host.docker.internal</span><br><span class="line"><span class="keyword">ENV</span> SITECORE_API_KEY=MYKEY</span><br><span class="line"><span class="keyword">ENV</span> SITECORE_APP_NAME=jss-angular</span><br><span class="line"><span class="keyword">ENV</span> SITECORE_JSS_SERVER_BUNDLE=./dist/$&#123;SITECORE_APP_NAME&#125;/server.bundle.js</span><br><span class="line"><span class="keyword">ENV</span> SITECORE_ENABLE_DEBUG=false</span><br><span class="line"><span class="keyword">ENV</span> PORT=<span class="number">3000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /jss</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> ./node-headless-ssr-proxy /jss</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=build /build/dist /jss/dist/<span class="variable">$&#123;SITECORE_APP_NAME&#125;</span></span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> npm install</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> npm run docker</span></span><br><span class="line"><span class="keyword">EXPOSE</span> $&#123;PORT&#125;</span><br></pre></td></tr></table></figure>

<p>In this episode, we have improved the JSS headless container build process by running all of the build inside containers for improved repeatability and tokenized the browser JS bundles so that the same container can be deployed to many environments with different API hosts without needing a rebuild. What’s next? Orchestrating multiple instances with Kubernetes.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kamsar.net/index.php/2019/09/Running-JSS-headless-mode-in-containers-part-2-Build-containers/" data-id="ckrl9emyw006298q74ixqfre3" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    
    
    <article id="post-Running-JSS-headless-mode-in-containers-part-1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/index.php/2019/09/Running-JSS-headless-mode-in-containers-part-1/">Running JSS headless mode in containers, part 1</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/index.php/2019/09/Running-JSS-headless-mode-in-containers-part-1/">
    <time datetime="2019-09-08T19:00:36.000Z" itemprop="datePublished">September 8, 2019</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/index.php/category/JSS/">JSS</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I’ve been playing with containers lately and as an experiment, containerized <a target="_blank" rel="noopener" href="https://jss.sitecore.com/docs/fundamentals/application-modes#headless-server-side-rendering-mode">JSS Headless Mode</a>. Since I had fun doing this, I figured I’d share what I learned. Note that this is my own explorations, and should not be construed as any official statement of container support for JSS, nor is it supported via official Sitecore channels.</p>
<h2 id="Containers-101-What’s-a-container"><a href="#Containers-101-What’s-a-container" class="headerlink" title="Containers 101: What’s a container?"></a>Containers 101: What’s a container?</h2><p>The best way to understand containers quickly is, of course, a meme.</p>
<img src="/index.php/2019/09/Running-JSS-headless-mode-in-containers-part-1/works.png" class="if it works on your machine, then ship your machine">

<p>Another way to think of a container is a lightweight virtual machine. Unlike a VM, a container <em>shares</em> much of its system with the host OS or node. This means that containers:</p>
<ol>
<li>Are much smaller both in disk and memory usage compared to a VM</li>
<li>Do not provide as strong of an isolation from the host as a VM</li>
<li>Are more easily <em>based on</em> a standard distribution. For example in this post we won’t be building a container from scratch; we will take the standard <code>node</code> container and deploy JSS to it - thus, we offload the maintenance of the base container to the Node maintainers, and we take on the maintenance of only our app.</li>
</ol>
<p>Containers have become incredibly popular as a way to build and deploy applications because of their consistency and low resource usage. Especially as more applications take on more server-based dependencies (i.e. microservice architectures, or even a traditional app that may need a database, search service, etc), containers provide a reasonable way to replicate such a complex IT infrastructure on a developer machine in the same way that it runs in production - without each developer needing to have a 1TB RAM, 28-core server to run all those virtual machines.</p>
<p>So with that in mind, what if we wanted to containerize Sitecore JSS’ headless mode host?</p>
<blockquote>
<p>Note: we’re only containerizing the JSS SSR host in this post; the rest of the Sitecore infrastrucure would still need to be deployed traditionally.</p>
</blockquote>
<h2 id="Creating-a-JSS-Docker-container"><a href="#Creating-a-JSS-Docker-container" class="headerlink" title="Creating a JSS Docker container"></a>Creating a JSS Docker container</h2><p>If you’re planning to follow along at home with this build, note that you’ll need to install <a target="_blank" rel="noopener" href="https://hub.docker.com/?overlay=onboarding">Docker Desktop</a> in order to be able to locally build and run the containers. You may also need to enable virtualization in your UEFI, if it’s off, or potentially for Windows also enable Hyper-V and Containers features at an OS level. Consult the Docker docs for help with that :)</p>
<p>When you create a container, there are three main tasks:</p>
<h3 id="Determine-the-base-container-to-build-from"><a href="#Determine-the-base-container-to-build-from" class="headerlink" title="Determine the base container to build from"></a>Determine the base container to build from</h3><p>Containers are built on top of other containers in an efficient and lightweight way. This means that for example, your container might start with a Windows Server container, or an Ubuntu container…or it might start from a Node container, that was based on an Debian container. You get the idea - containers, like ogres or ‘90s software architecture, have layers. Each layer is built as a diff from the underlying layer. When you make a container, you’re adding a layer.</p>
<p>In our case, JSS headless SSR is a Node-based application, so we will choose the <a target="_blank" rel="noopener" href="https://hub.docker.com/_/node">Node container</a> as our base.</p>
<h3 id="Define-the-Dockerfile"><a href="#Define-the-Dockerfile" class="headerlink" title="Define the Dockerfile"></a>Define the <code>Dockerfile</code></h3><p>The <a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/builder/">dockerfile</a> is a file named <code>Dockerfile</code> that defines how to create your container. It defines things like:</p>
<ul>
<li>What your base container is (<code>FROM node:lts</code>)</li>
<li>How to modify the base container to turn it into your container (scripts and file copying)</li>
<li>Defaults, like which TCP/UDP ports the container can expose</li>
</ul>
<p>In our case we want to start from the <a target="_blank" rel="noopener" href="https://nodejs.org/en/docs/guides/nodejs-docker-webapp/"><code>node</code> container</a>:</p>
<pre><code>FROM node:lts
</code></pre>
<p>Then we want to tell Docker how to deploy our JSS app on top of the Node container. We do this by telling it which files we want to copy into the container image and where to put them, as well as any commands that need to be run to complete the setup:</p>
<pre><code># We want to place our app at /jss on the container filesystem
# (this is a fairly arbitrary choice; 
# use something app-specific and don&#39;t use &#39;/&#39;)
# Subsequent commands and copies are relative to this directory.
WORKDIR /jss

# Specify the _local_ files to copy into the container;
# in this case a copy of the headless SSR proxy: https://github.com/Sitecore/jss/tree/dev/samples/node-headless-ssr-proxy
COPY ./node-headless-ssr-proxy /jss

# Run shell commands _inside the container_ to set up the app;
# in this case, to install npm packages for the headless Node app.
# NOTE: the container is built on the Docker server, not locally!
# Commands you run here run inside the container, and thus 
# cannot for example reference local file paths!
RUN npm install

# To run JSS in headless mode, we also need to deploy 
# the JSS app&#39;s server build artifacts into the container
# for the headless mode proxy to execute. This is another copy.
COPY my-jss-app-name/dist /jss/dist/my-jss-app-name

# When the container starts, we have to make it do something
# aside from start - in this case, start the JSS app.
# The command is run in the context of the WORKDIR we set earlier.
ENTRYPOINT npm run start

# The JSS headless proxy is configured using environment variables,
# which allow us to configure it at runtime. In this case,
# we need to configure the port, app bundle, etc
ENV SITECORE_APP_NAME=my-jss-app-name

# Relative to /jss path to the server bundle built by the JSS app build
# Note: this path should be identical to the path deployed for integrated
# mode, so that path references work correctly.
ENV SITECORE_JSS_SERVER_BUNDLE=./dist/$&#123;SITECORE_APP_NAME&#125;/server.bundle.js

# Hostname of the Sitecore instance to retrieve layout data from.
# host.docker.internal == DNS name of the docker host machine, 
# i.e. to hit non-container localhost Sitecore dev instance
ENV SITECORE_API_HOST=http://host.docker.internal
ENV SITECORE_API_KEY=GUID-VALUE-HERE
# Enable or disable debug console output (dont use in prod)
ENV SITECORE_ENABLE_DEBUG=false
# Set the _local_ port to run JSS on, within the container
# (this does not expose it publicly)
ENV PORT=3000

# Tell Docker that we expose a port, but this is for documentation;
# the port must be mapped when we start the container to be exposed.
EXPOSE $&#123;PORT&#125;
</code></pre>
<h3 id="Build-the-container"><a href="#Build-the-container" class="headerlink" title="Build the container"></a>Build the container</h3><p>Once we have defined the steps necessary to create the container image, we need to <em>build</em> the container. Building the container:</p>
<ul>
<li>Collects all the files in the <code>Dockerfile</code> directory and uploads them to the Docker host (unless listed in a <code>.dockerignore</code> file)</li>
<li>Acquires the base image, if it’s not already on the Docker host</li>
<li>Creates a container based on the base image and starts it</li>
<li>Executes your <code>Dockerfile</code> script within the container to configure it</li>
<li>Captures your Docker image and stores it for reuse</li>
</ul>
<blockquote>
<p>The <code>Dockerfile</code> does not execute locally, so make sure you don’t make that assumption when using <code>EXEC</code> directives; execution also occurs within the container being built, so it occurs in the context of the container (in this case, Debian) and the dependencies that are part of the container.</p>
</blockquote>
<p>To build your JSS container, within the same folder as your <code>Dockerfile</code> run:</p>
<pre><code>docker build -t your-image-name .
</code></pre>
<p>Once the build is done, you can find your image on Docker using:</p>
<pre><code>docker images
</code></pre>
<h2 id="Using-the-JSS-Docker-container"><a href="#Using-the-JSS-Docker-container" class="headerlink" title="Using the JSS Docker container"></a>Using the JSS Docker container</h2><p>Up to this point we have collected and built the container, but nothing has been run. To create a new instance of your container and start it up, run</p>
<pre><code>docker run -p 3000:3000 --name &lt;pick-a-name-for-container-instance&gt; &lt;imagename&gt;
</code></pre>
<p>The <code>-p</code> maps your localhost port 3000 to the container port 3000 (which we specified the Node host to run on previously using an environment variable).</p>
<p>Once you start the container, visiting <code>http://localhost:3000</code> should run the app in the JSS headless host container. </p>
<h3 id="Container-Debugging-Tips"><a href="#Container-Debugging-Tips" class="headerlink" title="Container Debugging Tips"></a>Container Debugging Tips</h3><ul>
<li>Viewing running containers - list running containers using the <code>docker ps</code> command. If a container was started without an explicit <code>--name</code>, this can help find it.</li>
<li>Opening a shell in a container - to run diagnostic shell commands, you can open a root shell to a running container. The <code>docker exec</code> command lets you run commands, including starting a shell - for example, <code>docker exec -it &lt;container-name&gt; bash</code>. The <code>-it</code> says you want an interactive TTY (in other words an ongoing shell, not a one-off command execution and exit)</li>
</ul>
<h2 id="What’s-Next"><a href="#What’s-Next" class="headerlink" title="What’s Next?"></a>What’s Next?</h2><p>In this post, we’ve created and run a Docker container of the JSS headless mode. This works great for a single container, but for production scenarios we would likely need to orchestrate <em>multiple</em> instances of the container to handle heavy load and provide redundancy. Next time, we will improve our container build script using a build container, then finally the series will end with orchestrating the container using Kubernetes.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kamsar.net/index.php/2019/09/Running-JSS-headless-mode-in-containers-part-1/" data-id="ckrl9emyr005o98q7ccdx1ras" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    
    
    <article id="post-Build-2019-All-the-things" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/index.php/2019/05/Build-2019-All-the-things/">Build 2019: All the things</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/index.php/2019/05/Build-2019-All-the-things/">
    <time datetime="2019-05-10T23:01:11.000Z" itemprop="datePublished">May 10, 2019</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/index.php/category/C/">C#</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I spent the first part of this week out at <a target="_blank" rel="noopener" href="https://www.microsoft.com/en-us/build">Build 2019</a>, and I learned a lot! Here’s all the news I saw fit to print from Build in a concise, notesy format.</p>
<h2 id="NET-Core-3"><a href="#NET-Core-3" class="headerlink" title=".NET Core 3"></a>.NET Core 3</h2><p>The next version of .NET Core will be released in September 2019. It will feature a raft of improvements, notably WPF/desktop app support (Windows only), .NET Standard 2.1 (<em>not going to be supported by .NET 4.x ever</em>), and C# 8 (<em>.NET Standard 2.1 required</em>).</p>
<p>Coinciding with the release of .NET Core 3 will be <a target="_blank" rel="noopener" href="https://www.dotnetconf.net/">dotnetconf</a> from September 23-25, a virtual conference highlighting .NET Core 3.</p>
<p>.NET Core 3.1, the long term support version, is slated to ship in November.</p>
<h2 id="NET-5-and-the-Unified-BCL"><a href="#NET-5-and-the-Unified-BCL" class="headerlink" title=".NET 5 and the Unified BCL"></a>.NET 5 and the Unified BCL</h2><p>After .NET Core 3 ships, .NET Core is dead. Instead .NET 5 will ship, and it will unify the abstraction of .NET Standard into a universal BCL that can run on any .NET 5 compatible runtime (i.e. Xamarin, Mono, Windows .NET). It will also gain Java and Swift interop capabilities (from Mono/Xamarin) on all platforms. The idea is that .NET 5 will be a singular platform that runs anywhere from mobile devices, to IoT/Raspberry Pi, to desktop apps, to cloud server(less).</p>
<p>Web Forms and WCF will never be ported to .NET Core/.NET 5. Specifically for Web Forms, Blazor will be the recommended migration path.</p>
<p>Following .NET 5, the .NET platform will have yearly releases (.NET 6, 7, 8, …). Alternating years will be LTS versions, in other words 2020’s .NET 5 will be supplanted by the LTS .NET 6 in 2021.</p>
<p><a target="_blank" rel="noopener" href="https://devblogs.microsoft.com/dotnet/introducing-net-5/">More on .NET 5 here</a></p>
<h2 id="C-8"><a href="#C-8" class="headerlink" title="C# 8"></a>C# 8</h2><p><em>Note: C# 8 requires compiler changes that need .NET Standard 2.1+. In other words, C# 8 can only be used with .NET Core 3 and later as a consumer!</em></p>
<p>The main focus of C# 8 is “robustness.” There are a number of new features that support this goal:</p>
<h4 id="Async-Enumerable"><a href="#Async-Enumerable" class="headerlink" title="Async Enumerable"></a>Async Enumerable</h4><p>Ever since async/await was shipped in C#, it’s been problematic to use it with enumerables because you must await either <code>Task&lt;IEnumerable&lt;T&gt;&gt;</code> (thus awaiting the WHOLE enumerable, which loses its lazy enumeration advantages), or <code>IEnumerable&lt;Task&lt;T&gt;&gt;</code> which potentially requires awaiting in a loop, which is also suboptimal. It also prevents the use of <code>yield return</code> in async methods, which makes them significantly less pretty.</p>
<p>In C# 8, this is fixed by introducing <code>IAsyncEnumerable&lt;T&gt;</code>, an asynchronously enumerable enumerable type. This type is enumerated using <code>await foreach</code>, i.e. <code>await foreach(var t in asyncEnumerable) &#123; /* where t is not a task */ &#125;</code>. The implementation of <code>IAsyncEnumerable</code> is simply allowed to <code>yield return</code> values, giving the enumerator control over its own internal asynchrony needs, batching, etc.</p>
<h4 id="Nullable-Reference-Types"><a href="#Nullable-Reference-Types" class="headerlink" title="Nullable Reference Types"></a>Nullable Reference Types</h4><p>The <code>NullReferenceException</code> is everyone’s favorite C# bugbear, and solutions good and bad abound for asserting that method arguments are not null to avoid throwing them (my favorite is <code>var x = arg ?? throw new ArgumentNullException(nameof(arg));</code>). In C# 8, you can explicitly declare reference types as nullable, explicitly stating that a method can return - or accept - a null value. Doing this allows the compiler to remove the need for all those assertions, as it can warn you at compile time if you’re not checking a nullable type for null before using it. This is an opt-in feature either with <code>#nullable enable</code> in a file, or it can be turned on per-project.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Item? GetItem() &#123;</span><br><span class="line">    // ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void DoStuff() &#123;</span><br><span class="line">    // with nullable reference types on, this will throw a compiler warning</span><br><span class="line">    // because GetItem declared explicitly that it can return null</span><br><span class="line">    var troll = GetItem().Axes.GetDescendants();</span><br><span class="line"></span><br><span class="line">    // you can bypass the warning if you know what you&#x27;re doing (lol) with !</span><br><span class="line">    var explodingTroll = GetItem()!.Axes.GetDescendants();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Range-Expressions"><a href="#Range-Expressions" class="headerlink" title="Range Expressions"></a>Range Expressions</h4><p>A common need is to parse a string or array and split it up into pieces by index; for example “this string’s last two characters” or “the first 5 elements in this array.” This sort of code is quite vulnerable to naughty data input causing exceptions, for example <code>&quot;a&quot;.Substring(5)</code> will throw because it isn’t 5 characters long.</p>
<p>C# 8 range expressions allow you to concisely and safely (they won’t throw if the array is shorter than the slice) express this sort of problem. They work using <code>^</code> to anchor the range to “length - x” or “start + x”, a spread, and an optional endpoint. A few examples:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var str = &quot;hello world&quot;;</span><br><span class="line">var a = str[0..5]; // &#x27;hello&#x27;</span><br><span class="line">var b = str[^1]; // &#x27;d&#x27;</span><br><span class="line">var c = str[^1..^4]; // &#x27;ello w&#x27;</span><br></pre></td></tr></table></figure>

<h4 id="Switch-Expressions"><a href="#Switch-Expressions" class="headerlink" title="Switch Expressions"></a>Switch Expressions</h4><p>The <code>switch</code> statement receives an upgrade in C# 8 with the ability to assign it directly to a variable, eliminating the need for clumsy <code>break</code> statements in every case. It’s also possible to use pattern matching with this format (not pictured).</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var result = &quot;hello&quot; switch &#123;</span><br><span class="line">	&quot;hello&quot; =&gt; true,</span><br><span class="line">	&quot;goodbye&quot; =&gt; false,</span><br><span class="line">	_ =&gt; false // default case via a discard</span><br><span class="line">&#125;;</span><br><span class="line">// result = true</span><br></pre></td></tr></table></figure>

<h4 id="Default-Interface-Implementations"><a href="#Default-Interface-Implementations" class="headerlink" title="Default Interface Implementations"></a>Default Interface Implementations</h4><p>Interfaces can have default implementations for members. This is not intended to kill IoC containers as much as be a tool for API creators to ship additions to public interfaces without breaking existing consumers of that interface. The additional members need only be optionally implemented by downstream consumers, with the defaults used if not overridden.</p>
<h4 id="Using-Declarations"><a href="#Using-Declarations" class="headerlink" title="Using Declarations"></a>Using Declarations</h4><p>The <code>using</code> statement gets an overhaul to avoid needing a block scope. A using statement is used to prevent forgetting to dispose <code>IDisposable</code> resources, but before C# 8 it required a block scope of its own which especially in nested usings made things hard to read. In C# 8, you can define a variable with the <code>using</code> keyword and no block scope, and it is implicitly disposed at the end of the current block scope. For example:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public void Foo() &#123;</span><br><span class="line">    using var file = new FileStream(@&quot;c:\foo.txt&quot;);</span><br><span class="line">    // file will be disposed when the Foo() block exits</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/csharp/whats-new/csharp-8">More on C# 8 here</a></p>
<h2 id="TypeScript"><a href="#TypeScript" class="headerlink" title="TypeScript"></a>TypeScript</h2><p>In TypeScript 3.4 - currently RC - you can enable <em>incremental builds</em> (via tsconfig, or <code>--incremental</code> to the CLI), which allows TS to cache the output of the last build/watch run and essentially ‘rehydrate’ it during the next build to avoid rebuilding unchanged modules. The upshot of this on the VS Code codebase is that warm build times went from <strong>47 seconds</strong> to <strong>11 seconds</strong>.</p>
<p>On larger TypeScript codebases, using <a target="_blank" rel="noopener" href="https://www.typescriptlang.org/docs/handbook/project-references.html">project references</a> can allow TypeScript to partition compilation units, enabling it to only rebuild changed units in the dependency tree (about like projects and solutions in Visual Studio). This can be used to avoid needing to recompile an entire TypeScript project every time even without incremental builds.</p>
<p>New modernized TypeScript documentation, with content oriented around current TypeScript practices and improved clarity, is in process. Current target is late 2019 to release the new docs.</p>
<p><a target="_blank" rel="noopener" href="https://devblogs.microsoft.com/typescript/announcing-typescript-3-4-rc/">More on TypeScript 3.4 here</a></p>
<h2 id="Live-Share"><a href="#Live-Share" class="headerlink" title="Live Share"></a>Live Share</h2><p>Using Live Share developers can collaborate effectively while remote, with either Visual Studio, VS Code, or both. It’s a bit like a code-specific combination of screen sharing and collaborative editing. This includes things like:</p>
<ul>
<li>Editing code in a Google Docs-like collaborative realtime editor</li>
<li>Setting breakpoints, controlling debugger execution that executes on the host’s computer</li>
<li>Reviewing the other dev’s localhost ports</li>
<li>VS Code can live share with Visual Studio</li>
<li>The viewer need not have a SDK, debugger, or plugins for the host’s code to participate - or even the same CPU architecture.</li>
<li>Works across platforms too, so you could connect using Code on a Mac to VS on Windows and control debugging a windows service, for example.</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://visualstudio.microsoft.com/services/live-share/">More on Live Share here</a></p>
<h2 id="Visual-Studio-Code-Remote-Editing"><a href="#Visual-Studio-Code-Remote-Editing" class="headerlink" title="Visual Studio Code Remote Editing"></a>Visual Studio Code Remote Editing</h2><p>Code can now connect to a remote system (via SSH or directly to a container) and edit the remote instance as if it were local files. This includes things like installing Code plugins <em>on the remote environment</em> - it’s basically connecting to a “headless” VS Code service. For example, you could write Ruby code on a Docker container in AKS from a windows machine running Code…without needing to set up a Ruby dev environment locally or install any Ruby plugins into Code. Or, do .NET Core dev on a remote VM without needing to install the .NET Core SDK locally.</p>
<p>Remote editing really shines when combined with Azure Dev Spaces (read on…).</p>
<p><a target="_blank" rel="noopener" href="https://code.visualstudio.com/docs/remote/remote-overview">More on remote editing here</a></p>
<h2 id="Visual-Studio-Online-not-to-be-confused-with-the-old-name-for-Azure-DevOps"><a href="#Visual-Studio-Online-not-to-be-confused-with-the-old-name-for-Azure-DevOps" class="headerlink" title="Visual Studio Online (not to be confused with the old name for Azure DevOps)"></a>Visual Studio Online (not to be confused with the old name for Azure DevOps)</h2><ul>
<li>Visual Studio Code in a browser</li>
<li>Edit code, review PRs, connect to remote development environments (SSH, Containers)</li>
<li>Works on any browser. Want to review PRs on an iPad? Sure!</li>
<li>In private preview at the moment</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://devblogs.microsoft.com/visualstudio/intelligent-productivity-and-collaboration-from-anywhere/">More on VSO here</a></p>
<h2 id="VS-Code-and-VS-Tips"><a href="#VS-Code-and-VS-Tips" class="headerlink" title="VS Code and VS Tips"></a>VS Code and VS Tips</h2><ul>
<li>There were excellent sessions on getting more out of Visual Studio and VS Code. If you want to learn something about your tools, these were pretty great. For example:</li>
<li>You can configure Code to attach multiple debuggers at launch (i.e. Chrome + Node debuggers)</li>
<li>F1 opens the Code palette, in addition to Ctrl-P</li>
<li>You can quickly open files in Code from the command palette by removing the &gt; prompt and typing a filename or expression</li>
<li>Jump to outlined functions, tags, etc the current file, in Code, by entering <code>@:</code> in the command palette (i.e. <code>@:myfunc</code>)</li>
<li>IntelliCode (available in Code and VS 16.1+) applies ML models to predict the most commonly used code completions for a given state. For example <code>if(arrayVar.</code> might suggest <code>Length</code> but <code>stringVar.</code> might suggest <code>Split</code>. The suggestions model was trained on 2000 of the most popular open source codebases on GitHub, so they’re based on actual community practices.</li>
<li>Visual Studio is aggressively rendering R# irrelevant in current previews. You really might not need it at all in the future. Tons of new refactorings, code cleanup improvements, ability to infer .editorconfig files, et al.</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://mybuild.techcommunity.microsoft.com/sessions/77039">Code tips session</a><br><a target="_blank" rel="noopener" href="https://mybuild.techcommunity.microsoft.com/sessions/77044">Visual Studio tips session</a><br><a target="_blank" rel="noopener" href="https://mybuild.techcommunity.microsoft.com/sessions/77042">Visual Studio debugger/diags tips</a></p>
<h2 id="Azure-Dev-Spaces"><a href="#Azure-Dev-Spaces" class="headerlink" title="Azure Dev Spaces"></a>Azure Dev Spaces</h2><p>It’s no secret that microservice architectures can be pretty difficult to develop locally. Especially if they tend towards the distributed monolith antipattern ;) Well, Azure decided to do something about that. Probably the coolest demo of the whole event.</p>
<p>Dev Spaces is a prebuilt microservice-oriented workflow for developers based on Azure Kubernetes Service (AKS). The basic concept is that a dev team would share an AKS cluster across their whole team - because developers would probably be working on a few microservices, not the whole galaxy of the system, they can then basically “branch” specific microservices out for personal development, while referencing the rest of the system built from the latest CI build. In other words, there’s no need to mock or setup local microservices that you don’t care about, because yours runs in AKS and refers to the master build.</p>
<p>Even more bonkers, you can use remote development to debug and auto-deploy files to your personal microservices running in AKS. Pull requests can be made to similarly build in their own namespace, giving faster and more efficient use of build time. Seems like a pretty darn nice experience, with most of the orchestration issues no longer your problem.</p>
<p><a target="_blank" rel="noopener" href="https://mybuild.techcommunity.microsoft.com/sessions/77060">Watch the session</a><br><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/azure/dev-spaces">Documentation on Dev Spaces</a></p>
<h2 id="YAML-Builds-amp-Releases-for-Azure-DevOps-Pipelines"><a href="#YAML-Builds-amp-Releases-for-Azure-DevOps-Pipelines" class="headerlink" title="YAML Builds &amp; Releases for Azure DevOps Pipelines"></a>YAML Builds &amp; Releases for Azure DevOps Pipelines</h2><p>You can define your Azure DevOps build and release pipelines using YAML files that can be committed to the repository. This allows the build system to be versioned and stable across branches and enables proper testing of changes to the build via PRs. In preview now, release pipelines (in addition to builds) can be defined in YAML. There is also a visual editor that allows generation of YAML for common tasks using a GUI.</p>
<p>Coming soon, pipelines will be able to automatically generate a Kubernetes manifest and Helm chart for any project with a Dockerfile. This will also generate appropriate build YAML to allow building docker images, deploying them to Azure Container Registry, and spinning up the Kubernetes cluster from those images on Azure Kubernetes Service. Looks really easy to use, and a definite lowering of the barrier to entry to Kubernetes deployment. The pipeline doesn’t only support Azure k8s either; it can deploy to other container registries or k8s clusters on premise or in other clouds.</p>
<h2 id="Azure-Cognitive-Search"><a href="#Azure-Cognitive-Search" class="headerlink" title="Azure Cognitive Search"></a>Azure Cognitive Search</h2><p>Azure search is gaining the ability to apply cognitive services to data being indexed; for example it can index the contents of images as detected by cognitive services, etc. Also the 1000-field limit that Sitecore users love is being investigated and may be raised or eliminated in a near term time frame.</p>
<h2 id="ML-NET-1-0-amp-AutoML"><a href="#ML-NET-1-0-amp-AutoML" class="headerlink" title="ML.NET 1.0 &amp; AutoML"></a>ML.NET 1.0 &amp; AutoML</h2><p>A library to build and run machine learning models from within .NET. Can consume several trained model formats, including TensorFlow, which lets you integrate ML models built by a data scientist using Python et al into .NET runtimes. Microsoft is also working on the <a target="_blank" rel="noopener" href="https://onnx.ai/">ONNX</a> model format for interoperable models. While it’s capable of training its own models too, it is interesting to see the model promoted where data scientists do their modeling using mainstream ML tools (i.e. Python), and deploy only the trained model to the .NET application. Promising in terms of integrating .NET with mainstream data scientists.</p>
<p>The AutoML toolkit was also announced. AutoML is a nice looking tool for non-data-scientists to take a dataset and automatically discover a good ML algorithm and hyperparameter set to produce an accurate model. Definitely aimed at the backend developer looking to add a splash of ML to their toolset, as opposed to data scientists, but this seems like it could significantly lower the barrier to ML entry for .NET developers.</p>
<p><a target="_blank" rel="noopener" href="https://dotnet.microsoft.com/apps/machinelearning-ai/ml-dotnet#automl">More on ML.NET and AutoML here</a></p>
<p>Go forth and code, me hearties.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kamsar.net/index.php/2019/05/Build-2019-All-the-things/" data-id="ckrl9emyq005l98q79kkohr92" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
  
</section>
      
        <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul id="recent-post" class="no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/index.php/category/JavaScript/">JavaScript</a></p>
              <p class="item-title"><a href="/index.php/2021/07/Fun-with-async-generators-and-for-await/" class="title">Fun with async generators and for await</a></p>
              <p class="item-date"><time datetime="2021-07-26T23:30:51.000Z" itemprop="datePublished">July 26, 2021</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/index.php/category/Jamstack/">Jamstack</a></p>
              <p class="item-title"><a href="/index.php/2020/08/Deploying-multiple-Netlify-sites-from-one-Git-repository/" class="title">Deploying multiple Netlify sites from one monorepo</a></p>
              <p class="item-date"><time datetime="2020-08-21T03:30:32.000Z" itemprop="datePublished">August 20, 2020</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/index.php/category/JSS/">JSS</a></p>
              <p class="item-title"><a href="/index.php/2019/09/Running-JSS-headless-mode-in-containers-part-2-Build-containers/" class="title">Running JSS headless mode in containers part 2: Build containers</a></p>
              <p class="item-date"><time datetime="2019-09-16T02:14:04.000Z" itemprop="datePublished">September 15, 2019</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/index.php/category/JSS/">JSS</a></p>
              <p class="item-title"><a href="/index.php/2019/09/Running-JSS-headless-mode-in-containers-part-1/" class="title">Running JSS headless mode in containers, part 1</a></p>
              <p class="item-date"><time datetime="2019-09-08T19:00:36.000Z" itemprop="datePublished">September 8, 2019</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/index.php/category/C/">C#</a></p>
              <p class="item-title"><a href="/index.php/2019/05/Build-2019-All-the-things/" class="title">Build 2019: All the things</a></p>
              <p class="item-date"><time datetime="2019-05-10T23:01:11.000Z" itemprop="datePublished">May 10, 2019</time></p>
            </div>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/index.php/category/April-1/">April 1</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Blade/">Blade</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Build-Scripts/">Build Scripts</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/C/">C#</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Dianoga/">Dianoga</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/JSS/">JSS</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Jamstack/">Jamstack</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/JavaScript/">JavaScript</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Node-js/">Node.js</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Sitecore/">Sitecore</a><span class="category-list-count">39</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Sitecore/Crypto/">Crypto</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Sitecore/Lucene/">Lucene</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Sitecore/MVC/">MVC</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Sitecore/Search/">Search</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Sitecore/xDB/">xDB</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Synthesis/">Synthesis</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Unicorn/">Unicorn</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/WebConsole/">WebConsole</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  
  <div id="toTop" class="fa fa-chevron-up"></div>
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      <p>&copy; 2021 Kam Figy</p>
      <p><small>Opinions expressed on this blog are my own, and not necessarily those of my employer.</small></p>
     <p><small>This work is licensed under a <a rel="license noopener" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</small></p>
    </div>
  </div>
</footer>
    


<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>




<script src="/js/script.js"></script>


  </div>
</body>
</html>