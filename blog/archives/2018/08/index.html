<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Archives: 2018/8 | Kam&#39;s Idea Log</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Kam&#39;s Idea Log">
<meta property="og:url" content="https://kamsar.net/blog/archives/2018/08/index.html">
<meta property="og:site_name" content="Kam&#39;s Idea Log">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Kam Figy">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@kamsar">
  
    <link rel="alternative" href="/index.php/feed" title="Kam&#39;s Idea Log" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans:400italic,400,600' rel='stylesheet' type='text/css'>
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">

  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-62284328-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


<meta name="generator" content="Hexo 5.4.0"></head>
<body>
  <div id="container">
    <header id="header">
  <div id="header-main" class="header-inner">
    <div class="outer">
      <a href="/" id="logo">
        <span class="site-title">Kam&#39;s Idea Log</span>
        <span class="subtitle">C#, Jamstack, and Shenanigans</span>
      </a>
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/blog/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        <div class="profile" id="profile-nav">
          <a id="profile-anchor" href="javascript:;"><img class="avatar" src="https://www.gravatar.com/avatar/314826f5d569260f26ac9f26f9e38b86?s=40" srcset="https://www.gravatar.com/avatar/314826f5d569260f26ac9f26f9e38b86?s=80 2x" alt="omg the beard"><i class="fa fa-caret-down"></i></a>
        </div>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"> </button><input type="hidden" name="sitesearch" value="https://kamsar.net"></form>
      </div>
    </div>
  </div>
  <div id="main-nav-mobile" class="header-sub header-inner">
    <table class="menu outer">
      <tr>
      
        <td><a class="main-nav-link" href="/">Home</a></td>
      
        <td><a class="main-nav-link" href="/blog/archives">Archives</a></td>
      
      <td>
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="https://kamsar.net"></form>
      </td>
      </tr>
    </table>
  </div>
  
  <div id="header-sub" class="header-sub header-inner">
    <div class="outer">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/index.php/category/April-1/">April 1</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Blade/">Blade</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Build-Scripts/">Build Scripts</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/C/">C#</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Dianoga/">Dianoga</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/JSS/">JSS</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Jamstack/">Jamstack</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/JavaScript/">JavaScript</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Node-js/">Node.js</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Sitecore/">Sitecore</a><span class="category-list-count">39</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Synthesis/">Synthesis</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Unicorn/">Unicorn</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/WebConsole/">WebConsole</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>
  
</header>
    <div class="outer">
      <aside id="profile">
  <div class="inner profile-inner">
  	<div class="base-info profile-block">
		  <img id="avatar" src="https://www.gravatar.com/avatar/314826f5d569260f26ac9f26f9e38b86?s=128" srcset="https://www.gravatar.com/avatar/314826f5d569260f26ac9f26f9e38b86?s=256 2x" alt="#sitecorebeard">
      <h2 id="name">Kam Figy</h2>
      <h3 id="title">Principal Platform Architect at</h3>
      <a class="corp-logo" href="https://uniform.dev" target="_blank"><img src="/css/images/uniform-logo.svg" alt="Uniform" width="180"></a>
      <span id="location"><i class="fa fa-map-marker"></i>Vancouver, WA USA</span>
      <a id="follow" target="_blank" rel="noopener" href="https://twitter.com/kamsar">FOLLOW</a>
  	</div>
    <div class="contact-info profile-block">
      <table class="contact-list">
        <tr>
        
          <td><a target="_blank" rel="noopener" href="https://github.com/kamsar" title="github"><i class="fa fa-github"></i></a></td>
        
          <td><a target="_blank" rel="noopener" href="https://twitter.com/kamsar" title="twitter"><i class="fa fa-twitter"></i></a></td>
        
          <td><a href="/index.php/feed" title="rss"><i class="fa fa-rss"></i></a></td>
        
        </tr>
      </table>
    </div>
    <div class="article-info profile-block bio">
      <h2>About</h2>
      <p>Kam has been making websites since 1996, starting out with a 14.4k modem on a <a href="https://en.wikipedia.org/wiki/Party_line_(telephony)" target="_blank">party line</a> in the Hawaiian rainforest. A veteran developer, architect, and speaker, he's been working in the content management space for well over a decade. Kam is the author of <a href="https://github.com/kamsar/Unicorn" target="_blank">Unicorn</a>, <a href="https://github.com/kamsar/Synthesis" target="_blank">Synthesis</a>, <a href="https://github.com/kamsar/Dianoga" target="_blank">Dianoga</a>, and several other open-source libraries.</p>
    </div>
  </div>
</aside>
      <section id="main">
  
  
    
    
      
        <div class="archive-year-wrap">
          <i class="fa fa-calendar"></i>
          <a href="/archives/2018" class="archive-year">2018</a>
        </div>
    
    <article id="post-Code-splitting-with-Sitecore-JSS-React" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/index.php/2018/08/Code-splitting-with-Sitecore-JSS-React/">Code splitting with Sitecore JSS + React</a>
    </h1>
  

        <div class="article-meta">
          <div class="article-date">
  <i class="fa fa-calendar"></i>
  <a href="/index.php/2018/08/Code-splitting-with-Sitecore-JSS-React/">
    <time datetime="2018-08-01T15:43:31.000Z" itemprop="datePublished">August 1, 2018</time>
  </a>
</div>
          
  <div class="article-category">
  	<i class="fa fa-folder"></i>
    <a class="article-category-link" href="/index.php/category/JSS/">JSS</a>
  </div>

        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Page weight - how much data a user needs to download to view your website - is a big deal in JavaScript applications. The more script that an application loads, the longer it takes to render for a user - especially in critical mobile scenarios. The longer it takes an app to render, the less happy the users of that app are. JavaScript is especially important to keep lightweight, because JS is not merely downloaded like an image - it also has to be <a target="_blank" rel="noopener" href="https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/javascript-startup-optimization/">parsed and compiled by the browser</a>. Especially on slower mobile devices, this parsing can take longer than the download! So less script is a very good thing.</p>
<p>Imagine a large Sitecore JSS application, with a large number of JavaScript components. With the default JSS applications the entire app JS must be deployed to the user when any page in the application loads. This is simple to reason about and performs well with smaller sites, but on a large site it is detrimental to performance if the home page must load 40 components that are not used on that route in order to render.</p>
<h2 id="Enter-Code-Splitting"><a href="#Enter-Code-Splitting" class="headerlink" title="Enter Code Splitting"></a>Enter Code Splitting</h2><p><a target="_blank" rel="noopener" href="https://webpack.js.org/guides/code-splitting/"><em>Code Splitting</em></a> is a term for breaking up your app’s JS into several chunks, usually via <a target="_blank" rel="noopener" href="https://webpack.js.org/">webpack</a>. There are many ways that code splitting can be set up, but we’ll focus on two popular automatic techniques: route-level code splitting, and component-level code splitting.</p>
<p>Route-level code splitting creates a JS bundle for each route in an application. Because of this, it relies on the app using <em>static routing</em> - in other words knowing all routes in advance, and having static components on those routes. This is probably the most widespread code splitting technique, but it is fundamentally incompatible with JSS because the app’s structure and layout is defined by Sitecore. We do not know all of the routes that an app has at build time, nor do we know which components are on those routes because that is also defined by Sitecore.</p>
<p>Component-level code splitting creates a JS bundle for each component in an application. This results in quite granular bundles, but overall excellent compatibility with JSS because it works great with dynamic routing - we only need to load the JS for the components that an author has added to a given route, and they’re individually cacheable by the browser providing great caching across routes too.</p>
<h2 id="Component-level-Code-Splitting-with-React"><a href="#Component-level-Code-Splitting-with-React" class="headerlink" title="Component-level Code Splitting with React"></a>Component-level Code Splitting with React</h2><p>The <a target="_blank" rel="noopener" href="https://github.com/jamiebuilds/react-loadable">react-loadable</a> library provides excellent component-level code splitting capabilities to React apps. Let’s add it to the JSS React app and split up our components!</p>
<h3 id="Step-1-Add-react-loadable"><a href="#Step-1-Add-react-loadable" class="headerlink" title="Step 1: Add react-loadable"></a>Step 1: Add <code>react-loadable</code></h3><p>We need some extra npm packages to make this work.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// yarn</span><br><span class="line">yarn add react-loadable</span><br><span class="line">yarn add babel-plugin-syntax-dynamic-import babel-plugin-dynamic-import-node --dev</span><br><span class="line"></span><br><span class="line">// npm</span><br><span class="line">npm i react-loadable</span><br><span class="line">npm i babel-plugin-syntax-dynamic-import babel-plugin-dynamic-import-node --save-dev</span><br></pre></td></tr></table></figure>

<h3 id="Step-2-Make-the-componentFactory-use-code-splitting"><a href="#Step-2-Make-the-componentFactory-use-code-splitting" class="headerlink" title="Step 2: Make the componentFactory use code splitting"></a>Step 2: Make the <code>componentFactory</code> use code splitting</h3><p>In order to use code splitting, we have to tell <code>create-react-app</code> (which uses <code>webpack</code>) how to split our output JS. This is pretty easy using <a target="_blank" rel="noopener" href="https://reactjs.org/docs/code-splitting.html#import">dynamic <code>import</code></a>, which works like a normal <code>import</code> or <code>require</code> but loads the module lazily at runtime. <a target="_blank" rel="noopener" href="https://github.com/jamiebuilds/react-loadable">react-loadable</a> provides a simple syntax to wrap any React component in a lazy-loading shell.</p>
<p>In JSS applications, the <em>Component Factory</em> is a mapping of the names of components into the implementation of those components - for example to allow the JSS app to resolve the component named <code>&#39;ContentBlock&#39;</code>, provided by the Sitecore Layout Service, to a React component defined in <code>ContentBlock.js</code>. The Component Factory is a perfect place to put component-level code splitting.</p>
<p>In a JSS React app, the Component Factory is generated code by default - inferring the components to register based on filesystem conventions. The <code>/scripts/generate-component-factory.js</code> file defines how the code is generated. The generated code - created when a build starts - is emitted to <code>/src/temp/componentFactory.js</code>. Before we alter the code generator to generate split components, let’s compare registering a component in each way:</p>
<h5 id="JSS-React-standard-componentFactory-js"><a href="#JSS-React-standard-componentFactory-js" class="headerlink" title="JSS React standard componentFactory.js"></a>JSS React standard componentFactory.js</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// static import</span></span><br><span class="line"><span class="keyword">import</span> ContentBlock <span class="keyword">from</span> <span class="string">&#x27;../components/ContentBlock&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// create component map (identical code)</span></span><br><span class="line"><span class="keyword">const</span> components = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">components.set(<span class="string">&#x27;ContentBlock&#x27;</span>, ContentBlock);</span><br></pre></td></tr></table></figure>

<h5 id="react-loadable-componentFactory-js"><a href="#react-loadable-componentFactory-js" class="headerlink" title="react-loadable componentFactory.js"></a>react-loadable componentFactory.js</h5><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> Loadable <span class="keyword">from</span> <span class="string">&#x27;react-loadable&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// loadable dynamic import component - lazily loads the component implementation when it is first used</span></span><br><span class="line"><span class="keyword">const</span> ContentBlock = Loadable(&#123;</span><br><span class="line">  <span class="comment">// setting webpackChunkName lets us have a nice chunk filename like ContentBlock.hash.js instead of 1.hash.js</span></span><br><span class="line">  <span class="attr">loader</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="comment">/* webpackChunkName: &quot;ContentBlock&quot; */</span> <span class="string">&#x27;../components/ContentBlock&#x27;</span>),</span><br><span class="line">  <span class="comment">// this is a react component shown while lazy loading. See the react-loadable docs for guidance on making a good one.</span></span><br><span class="line">  <span class="attr">loading</span>: <span class="function">() =&gt;</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>Loading...<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>,</span><br><span class="line">  <span class="comment">// this module name should match the webpackChunkName that was set. This is used to determine dependency during server-side rendering.</span></span><br><span class="line">  modules: [<span class="string">&#x27;ContentBlock&#x27;</span>],</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// create component map (identical code)</span></span><br><span class="line"><span class="keyword">const</span> components = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">components.set(<span class="string">&#x27;ContentBlock&#x27;</span>, ContentBlock);</span><br></pre></td></tr></table></figure>

<h4 id="Updating-the-Component-Factory-Code-Generation"><a href="#Updating-the-Component-Factory-Code-Generation" class="headerlink" title="Updating the Component Factory Code Generation"></a>Updating the Component Factory Code Generation</h4><p>In order to have our component factory use splitting, let’s update the code generator to emit <code>react-loadable</code> component definitions. </p>
<p>Modify <code>/scripts/generate-component-factory.js</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// add this function</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">LoadableComponent</span>(<span class="params">importVarName, componentFolder</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`const <span class="subst">$&#123;importVarName&#125;</span> = Loadable(&#123;</span></span><br><span class="line"><span class="string">    loader: () =&gt; import(/* webpackChunkName: &quot;<span class="subst">$&#123;componentFolder&#125;</span>&quot; */ &#x27;../components/<span class="subst">$&#123;componentFolder&#125;</span>&#x27;),</span></span><br><span class="line"><span class="string">    loading: () =&gt; &lt;div&gt;Loading...&lt;/div&gt;,</span></span><br><span class="line"><span class="string">    modules: [&#x27;<span class="subst">$&#123;componentFolder&#125;</span>&#x27;],</span></span><br><span class="line"><span class="string">    &#125;);`</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// modify generateComponentFactory()...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// after const imports = [];</span></span><br><span class="line">imports.push(<span class="string">`import React from &#x27;react&#x27;;`</span>);</span><br><span class="line">imports.push(<span class="string">`import Loadable from &#x27;react-loadable&#x27;;`</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// change imports.push(``import $&#123;importVarName&#125; from &#x27;../components/$&#123;componentFolder&#125;&#x27;;``); to</span></span><br><span class="line">imports.push(LoadableComponent(importVarName, componentFolder));</span><br></pre></td></tr></table></figure>

<p>You can find a completed <a target="_blank" rel="noopener" href="https://gist.github.com/kamsar/9a616dffdb2dc1d76772cc796d716b03">gist of these changes here</a>. Search in it for <code>[CS]</code> to see each change in context. Don’t copy the whole file, in case of future changes to the rest of the loader.</p>
<h5 id="Try-it"><a href="#Try-it" class="headerlink" title="Try it!"></a>Try it!</h5><p>Start your app up with <code>jss start</code>. At this point Code Splitting should be working: you should see a JS file get loaded for each component on a route, and a short flash of <code>Loading...</code> when the route initially loads.</p>
<p>But it still has some issues that could make it more usable. If the app is server-side rendered in <a target="_blank" rel="noopener" href="https://jss.sitecore.net/docs/fundamentals/application-modes">headless or integrated modes</a> none of the content will be present because the dynamic imports are asynchronous and have not resolved before the SSR completes. We’d also love to avoid that flash of loading text if the page was server-side rendered, too. Well guess what, we can do all of that!</p>
<h3 id="Step-3-Configure-code-splitting-for-Server-Side-Rendering"><a href="#Step-3-Configure-code-splitting-for-Server-Side-Rendering" class="headerlink" title="Step 3: Configure code splitting for Server-Side Rendering"></a>Step 3: Configure code splitting for Server-Side Rendering</h3><p>Server-side rendering with code splitting is a bit more complex. There are several pieces that the app needs to support:</p>
<ul>
<li>Preload all lazy loaded components, so that they render immediately during server-side rendering instead of starting to load async and leaving a loading message in the SSR HTML.</li>
<li>Determine which lazy loaded components were used during rendering, so that we can preload the same components’ JS files on the client-side to avoid the flash of loading text.</li>
<li>Emit <code>&lt;script&gt;</code> tags to preload the used components’ JS files on the client side into the SSR HTML.</li>
</ul>
<h4 id="3-1-Configure-SSR-Webpack-to-understand-dynamic-import"><a href="#3-1-Configure-SSR-Webpack-to-understand-dynamic-import" class="headerlink" title="3.1: Configure SSR Webpack to understand dynamic import"></a>3.1: Configure SSR Webpack to understand dynamic import</h4><p>The build of the server-side JS bundle is separate from the client bundle. We need to teach the server-side build how to compile the dynamic import expressions. Open <code>/server/server.webpack.config.js</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// add these after other imports</span></span><br><span class="line"><span class="keyword">const</span> dynamicImport = <span class="built_in">require</span>(<span class="string">&#x27;babel-plugin-syntax-dynamic-import&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> dynamicImportNode = <span class="built_in">require</span>(<span class="string">&#x27;babel-plugin-dynamic-import-node&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> loadableBabel = <span class="built_in">require</span>(<span class="string">&#x27;react-loadable/babel&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// add the plugins to your babel-loader section</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">use: &#123;</span><br><span class="line">  <span class="attr">loader</span>: <span class="string">&#x27;babel-loader&#x27;</span>,</span><br><span class="line">  <span class="attr">options</span>: &#123;</span><br><span class="line">  <span class="attr">babelrc</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">presets</span>: [env, stage0, reactApp],</span><br><span class="line">  <span class="comment">// [CS] ADDED FOR CODE SPLITTING</span></span><br><span class="line">  <span class="attr">plugins</span>: [dynamicImport, dynamicImportNode, loadableBabel],</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>You can find a completed <a target="_blank" rel="noopener" href="https://gist.github.com/kamsar/016b591148325d7de9260042d8113286">gist of these changes here</a>. Search in it for <code>[CS]</code> to see each change in context. Don’t copy the whole file, in case of future changes to the rest of the webpack config.</p>
<h4 id="3-2-Configure-server-js"><a href="#3-2-Configure-server-js" class="headerlink" title="3.2: Configure server.js"></a>3.2: Configure server.js</h4><p>The <code>/server/server.js</code> is the entry point to the JSS React app when it’s rendered on the server-side. We need to teach this entry point how to successfully execute SSR with lazy loaded components, and to emit preload script tags for used components.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// add to the top</span></span><br><span class="line"><span class="keyword">import</span> Loadable <span class="keyword">from</span> <span class="string">&#x27;react-loadable&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> manifest <span class="keyword">from</span> <span class="string">&#x27;../build/asset-manifest.json&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">convertLoadableModulesToScripts</span>(<span class="params">usedModules</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Object</span>.keys(manifest)</span><br><span class="line">    .filter(<span class="function">(<span class="params">chunkName</span>) =&gt;</span> usedModules.indexOf(chunkName.replace(<span class="string">&#x27;.js&#x27;</span>, <span class="string">&#x27;&#x27;</span>)) &gt; -<span class="number">1</span>)</span><br><span class="line">    .map(<span class="function">(<span class="params">k</span>) =&gt;</span> <span class="string">`&lt;script src=&quot;<span class="subst">$&#123;manifest[k]&#125;</span>&quot;&gt;&lt;/script&gt;`</span>)</span><br><span class="line">    .join(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// add after const graphQLClient...</span></span><br><span class="line"><span class="keyword">const</span> loadableModules = [];</span><br><span class="line"></span><br><span class="line"><span class="comment">// add after initializei18n()...</span></span><br><span class="line">.then(<span class="function">() =&gt;</span> Loadable.preloadAll())</span><br><span class="line"></span><br><span class="line"><span class="comment">// wrap the `&lt;AppRoot&gt;` component with the loadable used-component-capture component</span></span><br><span class="line">&lt;Loadable.Capture report=&#123;<span class="function">(<span class="params"><span class="built_in">module</span></span>) =&gt;</span> loadableModules.push(<span class="built_in">module</span>)&#125;&gt;</span><br><span class="line">  <span class="xml"><span class="tag">&lt;<span class="name">AppRoot</span> <span class="attr">path</span>=<span class="string">&#123;path&#125;</span> <span class="attr">Router</span>=<span class="string">&#123;StaticRouter&#125;</span> <span class="attr">graphQLClient</span>=<span class="string">&#123;graphQLClient&#125;</span> /&gt;</span></span></span><br><span class="line">&lt;/Loadable.Capture&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// append another .replace() to the rendered HTML transformations</span></span><br><span class="line">.replace(<span class="string">&#x27;&lt;script&gt;&#x27;</span>, <span class="string">`<span class="subst">$&#123;convertLoadableModulesToScripts(loadableModules)&#125;</span>&lt;script&gt;`</span>);</span><br></pre></td></tr></table></figure>

<p>You can find a completed <a target="_blank" rel="noopener" href="https://gist.github.com/kamsar/29370b58f7a4fb15bed74521e01ad6bc">gist of these changes here</a> <strong>with better explanatory comments</strong>. Search in it for <code>[CS]</code> to see each change in context. Don’t copy the whole file, in case of future changes to the rest of the entry point.</p>
<h4 id="3-3-Configure-client-side-index-js"><a href="#3-3-Configure-client-side-index-js" class="headerlink" title="3.3: Configure client-side index.js"></a>3.3: Configure client-side index.js</h4><p>The <code>/src/index.js</code> is the entry point to the JSS React app when it’s rendered on the browser-side. We need to teach this entry point how to wait to ensure that all preloaded components that SSR may have emitted to the page are done loading before we render the JSS app the first time to avoid a flash of loading text.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// add to the top</span></span><br><span class="line"><span class="keyword">import</span> Loadable <span class="keyword">from</span> <span class="string">&#x27;react-loadable&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// add after i18ninit()</span></span><br><span class="line">.then(<span class="function">() =&gt;</span> Loadable.preloadReady())</span><br></pre></td></tr></table></figure>

<p>You can find a completed <a target="_blank" rel="noopener" href="https://gist.github.com/kamsar/ecbc0a50fdb877eb598ef9c3a385aff9">gist of these changes here</a>. Search in it for <code>[CS]</code> to see each change in context. Don’t copy the whole file, in case of future changes to the rest of the entry point.</p>
<h3 id="Step-4-Try-it-out"><a href="#Step-4-Try-it-out" class="headerlink" title="Step 4: Try it out"></a>Step 4: Try it out</h3><p>With the code changes to enable splitting complete, deploy your app to Sitecore and try it in integrated mode. You should see the SSR HTML include a script tag for every component used on the route, and the rendering will wait until the components have preloaded before showing the application. This preloading means the browser does not have to wait for React to boot up before beginning load of the components, resulting in a much faster page load time.</p>
<img src="/index.php/2018/08/Code-splitting-with-Sitecore-JSS-React/ssr-trace.png" class="">

<p>The ideal component loading technique for each app will be different depending on the number and size of each component. Using the standard JSS styleguide sample app, enabling component code-splitting like this resulted in transferring almost 40k less data when loading the home page (which has a single component) vs the styleguide page (which has many components). This difference increases with the total number of components in a JSS app - but for most apps, code splitting is a smart idea if the app has many components that are used on only a few pages.</p>
<h2 id="Sources"><a href="#Sources" class="headerlink" title="Sources"></a>Sources</h2><ul>
<li><a target="_blank" rel="noopener" href="https://medium.com/bucharestjs/upgrading-a-create-react-app-project-to-a-ssr-code-splitting-setup-9da57df2040a">Upgrading a create-react-app project to a SSR + code splitting setup</a></li>
<li><a target="_blank" rel="noopener" href="https://serverless-stack.com/chapters/code-splitting-in-create-react-app.html">Code Splitting in Create React App</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/jamiebuilds/react-loadable">react-loadable</a></li>
<li><a target="_blank" rel="noopener" href="https://webpack.js.org/guides/code-splitting/">Webpack Code Splitting Guide</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kamsar.net/index.php/2018/08/Code-splitting-with-Sitecore-JSS-React/" data-id="ckrl9emyq005h98q7ar4xcpr4" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
  
</section>
      
        <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul id="recent-post" class="no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/index.php/category/JavaScript/">JavaScript</a></p>
              <p class="item-title"><a href="/index.php/2021/07/Fun-with-async-generators-and-for-await/" class="title">Fun with async generators and for await</a></p>
              <p class="item-date"><time datetime="2021-07-26T23:30:51.000Z" itemprop="datePublished">July 26, 2021</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/index.php/category/Jamstack/">Jamstack</a></p>
              <p class="item-title"><a href="/index.php/2020/08/Deploying-multiple-Netlify-sites-from-one-Git-repository/" class="title">Deploying multiple Netlify sites from one monorepo</a></p>
              <p class="item-date"><time datetime="2020-08-21T03:30:32.000Z" itemprop="datePublished">August 20, 2020</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/index.php/category/JSS/">JSS</a></p>
              <p class="item-title"><a href="/index.php/2019/09/Running-JSS-headless-mode-in-containers-part-2-Build-containers/" class="title">Running JSS headless mode in containers part 2: Build containers</a></p>
              <p class="item-date"><time datetime="2019-09-16T02:14:04.000Z" itemprop="datePublished">September 15, 2019</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/index.php/category/JSS/">JSS</a></p>
              <p class="item-title"><a href="/index.php/2019/09/Running-JSS-headless-mode-in-containers-part-1/" class="title">Running JSS headless mode in containers, part 1</a></p>
              <p class="item-date"><time datetime="2019-09-08T19:00:36.000Z" itemprop="datePublished">September 8, 2019</time></p>
            </div>
          </li>
        
          <li>
            
            <div class="item-inner">
              <p class="item-category"><a class="article-category-link" href="/index.php/category/C/">C#</a></p>
              <p class="item-title"><a href="/index.php/2019/05/Build-2019-All-the-things/" class="title">Build 2019: All the things</a></p>
              <p class="item-date"><time datetime="2019-05-10T23:01:11.000Z" itemprop="datePublished">May 10, 2019</time></p>
            </div>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/index.php/category/April-1/">April 1</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Blade/">Blade</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Build-Scripts/">Build Scripts</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/C/">C#</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Dianoga/">Dianoga</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/JSS/">JSS</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Jamstack/">Jamstack</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/JavaScript/">JavaScript</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Node-js/">Node.js</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Sitecore/">Sitecore</a><span class="category-list-count">39</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Sitecore/Crypto/">Crypto</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Sitecore/Lucene/">Lucene</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Sitecore/MVC/">MVC</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Sitecore/Search/">Search</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Sitecore/xDB/">xDB</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Synthesis/">Synthesis</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/Unicorn/">Unicorn</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="/index.php/category/WebConsole/">WebConsole</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  
  <div id="toTop" class="fa fa-chevron-up"></div>
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      <p>&copy; 2021 Kam Figy</p>
      <p><small>Opinions expressed on this blog are my own, and not necessarily those of my employer.</small></p>
     <p><small>This work is licensed under a <a rel="license noopener" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</small></p>
    </div>
  </div>
</footer>
    


<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>




<script src="/js/script.js"></script>


  </div>
</body>
</html>